<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2024-03-06%20IOCost%20model%20impact%20cpu%20soft%20lockup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2024-03-06%20IOCost%20model%20impact%20cpu%20soft%20lockup/" class="post-title-link" itemprop="url">IOCost model impact cpu soft lockup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:47:49" itemprop="dateCreated datePublished" datetime="2024-03-10T12:47:49+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system/" itemprop="url" rel="index"><span itemprop="name">system</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="IOCost-model-impact-cpu-soft-lockup"><a href="#IOCost-model-impact-cpu-soft-lockup" class="headerlink" title="IOCost model impact cpu soft lockup"></a>IOCost model impact cpu soft lockup</h1><h3 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h3><p><em>environment</em>:</p>
<p>5.15 kernel</p>
<p><em>way</em>:</p>
<p>Enable cgroup v2 and bfq, set bfq as scheduler on target deviceEnable io cost by &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;io.cost.qos, set cgroup io.weightStart two or more fio process to read or write on the target device, at least contains 1 direct and 1 buffer io, each one use different cgroupsWait 10-30 minutes</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>Kernel Dump 1 (Set hardlockup_panic&#x3D;1 by sysctl):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[ 1408.828715] Call Trace:</span><br><span class="line">[ 1408.828716]  &lt;TASK&gt;</span><br><span class="line">[ 1408.828718]  _raw_spin_lock_irq+0x26/0x30</span><br><span class="line">[ 1408.828722]  bfq_bio_merge+0x9f/0x160 [bfq]</span><br><span class="line">[ 1408.828727]  __blk_mq_sched_bio_merge+0x36/0x190</span><br><span class="line">[ 1408.828731]  blk_mq_submit_bio+0xd2/0x600</span><br><span class="line">[ 1408.828735]  __submit_bio+0x1dc/0x210</span><br><span class="line">[ 1408.828738]  submit_bio_noacct+0x263/0x2c0</span><br><span class="line">[ 1408.828741]  submit_bio+0x48/0x130</span><br><span class="line">[ 1408.828743]  iomap_submit_ioend.isra.0+0x52/0x80</span><br><span class="line">[ 1408.828745]  iomap_writepage_map+0x490/0x630</span><br><span class="line">[ 1408.828748]  iomap_do_writepage+0x75/0x230</span><br><span class="line">[ 1408.828750]  ? clear_page_dirty_for_io+0xdf/0x1d0</span><br><span class="line">[ 1408.828754]  write_cache_pages+0x184/0x450</span><br><span class="line">[ 1408.828756]  ? iomap_truncate_page+0x60/0x60</span><br><span class="line">[ 1408.828760]  iomap_writepages+0x20/0x40</span><br><span class="line">[ 1408.828762]  xfs_vm_writepages+0x84/0xb0 [xfs]</span><br><span class="line">[ 1408.828837]  do_writepages+0xc5/0x1c0</span><br><span class="line">[ 1408.828839]  ? __wb_calc_thresh+0x3e/0x120</span><br><span class="line">[ 1408.828842]  __writeback_single_inode+0x44/0x290</span><br><span class="line">[ 1408.828845]  writeback_sb_inodes+0x22d/0x4b0</span><br><span class="line">[ 1408.828849]  __writeback_inodes_wb+0x56/0xf0</span><br><span class="line">[ 1408.828852]  wb_writeback+0x1ce/0x290</span><br><span class="line">[ 1408.828855]  wb_workfn+0x31b/0x490</span><br><span class="line">[ 1408.828858]  ? psi_task_switch+0xc3/0x240</span><br><span class="line">[ 1408.828862]  process_one_work+0x22b/0x3d0</span><br><span class="line">[ 1408.828865]  worker_thread+0x4d/0x3f0</span><br><span class="line">[ 1408.828868]  ? process_one_work+0x3d0/0x3d0</span><br><span class="line">[ 1408.828870]  kthread+0x12a/0x150</span><br><span class="line">[ 1408.828872]  ? set_kthread_struct+0x40/0x40</span><br><span class="line">[ 1408.828874]  ret_from_fork+0x22/0x30</span><br><span class="line">[ 1408.828879]  &lt;/TASK&gt;</span><br><span class="line">[ 1408.829600] Kernel panic - not syncing: Hard LOCKUP</span><br><span class="line">[ 1408.829602] CPU: 26 PID: 0 Comm: swapper/26 Kdump: loaded Tainted: P          IOE K   5.15.0-26-generic #26</span><br><span class="line">[ 1408.829604] Hardware name: Dell Inc. PowerEdge C6420/0K2TT6, BIOS 2.4.8 11/27/2019</span><br><span class="line">[ 1408.829605] Call Trace:</span><br><span class="line">[ 1408.829606]  &lt;NMI&gt;</span><br><span class="line">[ 1408.829608]  dump_stack_lvl+0x4a/0x5f</span><br><span class="line">[ 1408.829615]  dump_stack+0x10/0x12</span><br><span class="line">[ 1408.829617]  panic+0x149/0x321</span><br><span class="line">[ 1408.829623]  nmi_panic.cold+0xc/0xc</span><br><span class="line">[ 1408.829626]  watchdog_overflow_callback.cold+0x5c/0x70</span><br><span class="line">[ 1408.829631]  __perf_event_overflow+0x57/0x100</span><br><span class="line">[ 1408.829634]  perf_event_overflow+0x14/0x20</span><br><span class="line">[ 1408.829637]  handle_pmi_common+0x1f3/0x2f0</span><br><span class="line">[ 1408.829643]  ? flush_tlb_one_kernel+0xe/0x20</span><br><span class="line">[ 1408.829647]  ? __set_pte_vaddr+0x37/0x40</span><br><span class="line">[ 1408.829650]  ? set_pte_vaddr_p4d+0x3d/0x50</span><br><span class="line">[ 1408.829652]  ? set_pte_vaddr+0x81/0xb0</span><br><span class="line">[ 1408.829653]  ? __native_set_fixmap+0x28/0x40</span><br><span class="line">[ 1408.829655]  ? native_set_fixmap+0x66/0x70</span><br><span class="line">[ 1408.829657]  ? ghes_copy_tofrom_phys+0x7c/0x120</span><br><span class="line">[ 1408.829663]  ? __ghes_peek_estatus.isra.0+0x4e/0xb0</span><br><span class="line">[ 1408.829666]  intel_pmu_handle_irq+0xf4/0x210</span><br><span class="line">[ 1408.829670]  perf_event_nmi_handler+0x2d/0x50</span><br><span class="line">[ 1408.829672]  nmi_handle+0x66/0x120</span><br><span class="line">[ 1408.829678]  default_do_nmi+0x45/0x110</span><br><span class="line">[ 1408.829681]  exc_nmi+0x175/0x190</span><br><span class="line">[ 1408.829683]  end_repeat_nmi+0x16/0x55</span><br><span class="line">[ 1408.829685] RIP: 0010:native_queued_spin_lock_slowpath+0x14f/0x220</span><br><span class="line">[ 1408.827472]  ? adjust_inuse_and_calc_cost+0x13a/0x250</span><br><span class="line">[ 1408.827475]  ioc_rqos_merge+0xef/0x260</span><br><span class="line">[ 1408.827478]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[ 1408.827481]  bio_attempt_back_merge+0x43/0xd0</span><br><span class="line">[ 1408.827484]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[ 1408.827486]  bfq_bio_merge+0xe2/0x160 [bfq]</span><br><span class="line">[ 1408.827491]  __blk_mq_sched_bio_merge+0x36/0x190</span><br><span class="line">[ 1408.827495]  blk_mq_submit_bio+0xd2/0x600</span><br><span class="line">[ 1408.827499]  __submit_bio+0x1dc/0x210</span><br><span class="line">[ 1408.827502]  ? get_user_pages_fast+0x24/0x40</span><br><span class="line">[ 1408.827507]  ? iov_iter_get_pages+0xc6/0x3f0</span><br><span class="line">[ 1408.827513]  submit_bio_noacct+0xac/0x2c0</span><br><span class="line">[ 1408.827516]  submit_bio+0x48/0x130</span><br><span class="line">[ 1408.827518]  iomap_dio_submit_bio+0x79/0x80</span><br><span class="line">[ 1408.827524]  iomap_dio_bio_iter+0x2d7/0x4a0</span><br><span class="line">[ 1408.827528]  __iomap_dio_rw+0x531/0x7c0</span><br><span class="line">[ 1408.827532]  iomap_dio_rw+0xe/0x30</span><br><span class="line">[ 1408.827535]  xfs_file_dio_write_aligned+0xa0/0x110 [xfs]</span><br><span class="line">[ 1408.827647]  xfs_file_write_iter+0x101/0x1a0 [xfs]</span><br><span class="line">[ 1408.827736]  aio_write+0x116/0x210</span><br><span class="line">[ 1408.827740]  ? update_load_avg+0x7c/0x640</span><br><span class="line">[ 1408.827744]  ? set_next_entity+0xb7/0x200</span><br><span class="line">[ 1408.827747]  __io_submit_one.constprop.0+0x40e/0x720</span><br><span class="line">[ 1408.827749]  ? __io_submit_one.constprop.0+0x40e/0x720</span><br><span class="line">[ 1408.827752]  ? __check_object_size+0x5d/0x150</span><br><span class="line">[ 1408.827755]  ? _copy_to_user+0x20/0x30</span><br><span class="line">[ 1408.827760]  ? aio_read_events+0x210/0x320</span><br><span class="line">[ 1408.827762]  io_submit_one+0xe3/0x550</span><br><span class="line">[ 1408.827764]  ? io_submit_one+0xe3/0x550</span><br><span class="line">[ 1408.827766]  ? audit_filter_rules.constprop.0+0x3b1/0x12e0</span><br><span class="line">[ 1408.827772]  __x64_sys_io_submit+0x8d/0x180</span><br><span class="line">[ 1408.827775]  ? syscall_trace_enter.isra.0+0x146/0x1c0</span><br><span class="line">[ 1408.827779]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 1408.827782]  ? exit_to_user_mode_prepare+0x3d/0x1c0</span><br><span class="line">[ 1408.827785]  ? syscall_exit_to_user_mode+0x27/0x50</span><br><span class="line">[ 1408.827788]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 1408.827790]  ? irqentry_exit+0x19/0x30</span><br><span class="line">[ 1408.827793]  ? sysvec_call_function_single+0x4e/0x90</span><br><span class="line">[ 1408.827795]  ? asm_sysvec_call_function_single+0xa/0x20</span><br><span class="line">[ 1408.827799]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br></pre></td></tr></table></figure>





<p>Kernel dump 2 :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[60977.577690] BUG: spinlock recursion on CPU#21, fio/11770</span><br><span class="line">[60977.583007]  lock: 0xffff92600e348c20, .magic: dead4ead, .owner: fio/11770, .owner_cpu: 21</span><br><span class="line">[60977.591275] CPU: 21 PID: 11770 Comm: fio Kdump: loaded Not tainted 5.15.0-26-generic #26</span><br><span class="line">[60977.599362] Hardware name: Supermicro SYS-6029TP-H-EI012/X11DPT-PS-EI012, BIOS 1.0.9.0 01/31/2018</span><br><span class="line">[60977.608229] Call Trace:</span><br><span class="line">[60977.610682]  &lt;IRQ&gt;</span><br><span class="line">[60977.612700]  dump_stack_lvl+0x58/0x7d</span><br><span class="line">[60977.616367]  dump_stack+0x10/0x12</span><br><span class="line">[60977.619687]  spin_dump.cold+0x24/0x39</span><br><span class="line">[60977.623359]  do_raw_spin_lock+0x9a/0xd0</span><br><span class="line">[60977.627198]  _raw_spin_lock_irqsave+0x7d/0x80</span><br><span class="line">[60977.631561]  bfq_finish_requeue_request+0x55/0x540 [bfq]</span><br><span class="line">[60977.636874]  blk_mq_free_request+0x3e/0x160</span><br><span class="line">[60977.641058]  __blk_mq_end_request+0x102/0x110</span><br><span class="line">[60977.645419]  scsi_end_request+0xce/0x190</span><br><span class="line">[60977.649345]  scsi_io_completion+0x7e/0x5d0</span><br><span class="line">[60977.653442]  scsi_finish_command+0xca/0x100</span><br><span class="line">[60977.657629]  scsi_complete+0x74/0xe0</span><br><span class="line">[60977.661212]  blk_complete_reqs+0x3b/0x50</span><br><span class="line">[60977.665135]  blk_done_softirq+0x1d/0x20</span><br><span class="line">[60977.668975]  __do_softirq+0xf7/0x31e</span><br><span class="line">[60977.672554]  irq_exit_rcu+0x79/0xa0</span><br><span class="line">[60977.676044]  sysvec_call_function_single+0x7c/0x90</span><br><span class="line">[60977.680837]  &lt;/IRQ&gt;</span><br><span class="line">[60977.682945]  &lt;TASK&gt;</span><br><span class="line">[60977.685051]  asm_sysvec_call_function_single+0x12/0x20</span><br><span class="line">[60977.690189] RIP: 0010:_raw_spin_unlock_irq+0x2a/0x30</span><br><span class="line">[60977.695155] Code: 0f 1f 44 00 00 55 48 89 e5 41 54 49 89 fc 48 8d 7f 18 48 8b 75 08 e8 75 6f 3d ff 4c 89 e7 e8 8d b0 3d ff fb 66 0f 1f 44 00 00 &lt;41&gt; 5c 5d c3 66 90 0f 1f 44 00 00 55 48 89 e5 41 54 49 89 fc 48 8d</span><br><span class="line">[60977.713902] RSP: 0018:ffffa0781992b670 EFLAGS: 00000246</span><br><span class="line">[60977.719128] RAX: 0000000000000015 RBX: 00000000001d9281 RCX: 0000000036d7555b</span><br><span class="line">[60977.726260] RDX: 000000007a3bfa68 RSI: ffff9260bca80d48 RDI: ffff92600fd9f0e0</span><br><span class="line">[60977.733392] RBP: ffffa0781992b678 R08: 00000000ffffffff R09: 00000000ffffffff</span><br><span class="line">[60977.740527] R10: 0000000000000001 R11: ffff9231c6d2cc00 R12: ffff92600fd9f0e0</span><br><span class="line">[60977.747661] R13: ffffa0781992b710 R14: 0000000000000001 R15: 000000000019007e</span><br><span class="line">[60977.754794]  adjust_inuse_and_calc_cost+0x164/0x250</span><br><span class="line">[60977.759673]  ioc_rqos_merge+0xef/0x260</span><br><span class="line">[60977.763425]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[60977.767091]  bio_attempt_back_merge+0x64/0xf0</span><br><span class="line">[60977.771451]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[60977.775982]  bfq_bio_merge+0xe2/0x150 [bfq]</span><br><span class="line">[60977.780168]  __blk_mq_sched_bio_merge+0x36/0x1b0</span><br><span class="line">[60977.784790]  blk_mq_submit_bio+0xd5/0x690</span><br><span class="line">[60977.788803]  __submit_bio+0x23d/0x270</span><br><span class="line">[60977.792465]  ? wake_up_page_bit+0xd3/0x100</span><br><span class="line">[60977.796568]  submit_bio_noacct+0x26c/0x2d0</span><br><span class="line">[60977.800664]  ? wake_up_page_bit+0xd3/0x100</span><br><span class="line">[60977.804764]  submit_bio+0x48/0x140</span><br><span class="line">[60977.808171]  iomap_submit_ioend.isra.0+0x52/0x80</span><br><span class="line">[60977.812790]  iomap_writepage_map+0x490/0x630</span><br><span class="line">[60977.817065]  iomap_do_writepage+0x8c/0x260</span><br><span class="line">[60977.821161]  ? clear_page_dirty_for_io+0x113/0x220</span><br><span class="line">[60977.825955]  write_cache_pages+0x19e/0x460</span><br><span class="line">[60977.830054]  ? iomap_truncate_page+0x60/0x60</span><br><span class="line">[60977.834330]  iomap_writepages+0x20/0x40</span><br><span class="line">[60977.838167]  xfs_vm_writepages+0x85/0xb0 [xfs]</span><br><span class="line">[60977.842718]  do_writepages+0xc6/0x1c0</span><br><span class="line">[60977.846384]  ? _raw_spin_unlock+0x23/0x30</span><br><span class="line">[60977.850398]  filemap_fdatawrite_wbc+0x7d/0xc0</span><br><span class="line">[60977.854756]  __filemap_fdatawrite_range+0x54/0x70</span><br><span class="line">[60977.859463]  generic_fadvise+0x299/0x2c0</span><br><span class="line">[60977.863387]  xfs_file_fadvise+0x23/0x80 [xfs]</span><br><span class="line">[60977.867807]  vfs_fadvise+0x1e/0x30</span><br><span class="line">[60977.871214]  ksys_fadvise64_64+0x41/0x80</span><br><span class="line">[60977.875140]  ? syscall_trace_enter.isra.0+0x16b/0x1e0</span><br><span class="line">[60977.880194]  __x64_sys_fadvise64+0x1e/0x30</span><br><span class="line">[60977.884291]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[60977.887870]  ? irqentry_exit_to_user_mode+0x9/0x20</span><br><span class="line">[60977.892665]  ? irqentry_exit+0x19/0x30</span><br><span class="line">[60977.896416]  ? exc_page_fault+0x94/0x1b0</span><br><span class="line">[60977.900343]  ? asm_exc_page_fault+0x8/0x30</span><br><span class="line">[60977.904444]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br><span class="line">[60977.909496] RIP: 0033:0x7f16f2c07d3e</span><br><span class="line">[60977.913076] Code: 10 10 00 f7 d8 64 89 02 b8 ff ff ff ff eb b3 e8 28 d8 01 00 0f 1f 84 00 00 00 00 00 f3 0f 1e fa 41 89 ca b8 dd 00 00 00 0f 05 &lt;89&gt; c2 f7 da 3d 00 f0 ff ff b8 00 00 00 00 0f 47 c2 c3 41 57 41 56</span><br><span class="line">[60977.931819] RSP: 002b:00007ffd83ec8338 EFLAGS: 00000246 ORIG_RAX: 00000000000000dd</span><br><span class="line">[60977.939388] RAX: ffffffffffffffda RBX: 00007f16effca890 RCX: 00007f16f2c07d3e</span><br><span class="line">[60977.946518] RDX: 0000000280000000 RSI: 0000000000000000 RDI: 0000000000000006</span><br><span class="line">[60977.953652] RBP: 0000000000000000 R08: 00007f16e8f2b028 R09: 0000000000000000</span><br><span class="line">[60977.960784] R10: 0000000000000004 R11: 0000000000000246 R12: 0000000280000000</span><br><span class="line">[60977.967918] R13: 00007f16e8c16c80 R14: 00007f16effca890 R15: 00007f16e8c16c80</span><br><span class="line">[60977.975053]  &lt;/TASK&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Kernel dump 3 (enable lockdep):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">[ 4398.422037] WARNING: inconsistent lock state</span><br><span class="line">[ 4398.426311] 5.15.0-26-generic #26 Not tainted</span><br><span class="line">[ 4398.430666] --------------------------------</span><br><span class="line">[ 4398.434939] inconsistent &#123;IN-HARDIRQ-W&#125; -&gt; &#123;HARDIRQ-ON-W&#125; usage.</span><br><span class="line">[ 4398.440947] fio/156503 [HC0[0]:SC0[0]:HE0:SE1] takes:</span><br><span class="line">[ 4398.445997] ffff8b5bd4771c38 (&amp;bfqd-&gt;lock)&#123;?.-.&#125;-&#123;2:2&#125;, at: bfq_bio_merge+0x9f/0x150 [bfq]</span><br><span class="line">[ 4398.454265] &#123;IN-HARDIRQ-W&#125; state was registered at:</span><br><span class="line">[ 4398.459148]   lock_acquire+0xd8/0x300</span><br><span class="line">[ 4398.462823]   _raw_spin_lock_irqsave+0x52/0xa0</span><br><span class="line">[ 4398.467279]   bfq_idle_slice_timer+0x2d/0xc0 [bfq]</span><br><span class="line">[ 4398.472079]   __hrtimer_run_queues+0x8b/0x420</span><br><span class="line">[ 4398.476438]   hrtimer_interrupt+0x109/0x230</span><br><span class="line">[ 4398.480621]   __sysvec_apic_timer_interrupt+0x78/0x1f0</span><br><span class="line">[ 4398.485761]   sysvec_apic_timer_interrupt+0x77/0x90</span><br><span class="line">[ 4398.490640]   asm_sysvec_apic_timer_interrupt+0x12/0x20</span><br><span class="line">[ 4398.495868]   lock_is_held_type+0x115/0x150</span><br><span class="line">[ 4398.500054]   rcu_read_lock_sched_held+0x5a/0x90</span><br><span class="line">[ 4398.504673]   lock_acquire+0x19f/0x300</span><br><span class="line">[ 4398.508426]   process_one_work+0x28d/0x5d0</span><br><span class="line">[ 4398.512525]   worker_thread+0x4a/0x3d0</span><br><span class="line">[ 4398.516276]   kthread+0x141/0x160</span><br><span class="line">[ 4398.519597]   ret_from_fork+0x22/0x30</span><br><span class="line">[ 4398.523289] irq event stamp: 1141506</span><br><span class="line">[ 4398.526869] hardirqs last  enabled at (1141505): [&lt;ffffffff880849b1&gt;] _raw_spin_unlock_irqrestore+0x51/0x70</span><br><span class="line">[ 4398.536601] hardirqs last disabled at (1141506): [&lt;ffffffff88084744&gt;] _raw_spin_lock_irq+0x74/0x90</span><br><span class="line">[ 4398.545556] softirqs last  enabled at (1139712): [&lt;ffffffff884002f5&gt;] __do_softirq+0x2f5/0x4d3</span><br><span class="line">[ 4398.554160] softirqs last disabled at (1139699): [&lt;ffffffff872c9556&gt;] irq_exit_rcu+0x96/0xc0</span><br><span class="line">[ 4398.562594] </span><br><span class="line">               other info that might help us debug this:</span><br><span class="line">[ 4398.569121]  Possible unsafe locking scenario:</span><br><span class="line">               </span><br><span class="line">[ 4398.575041]        CPU0</span><br><span class="line">[ 4398.577494]        ----</span><br><span class="line">[ 4398.579947]   lock(&amp;bfqd-&gt;lock);</span><br><span class="line">[ 4398.583188]   &lt;Interrupt&gt;</span><br><span class="line">[ 4398.585813]     lock(&amp;bfqd-&gt;lock);</span><br><span class="line">[ 4398.589219] </span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line">               </span><br><span class="line">[ 4398.595137] 2 locks held by fio/156503:</span><br><span class="line">[ 4398.598978]  #0: ffff8b5c653c4e28 (&amp;sb-&gt;s_type-&gt;i_mutex_key#14)&#123;++++&#125;-&#123;3:3&#125;, at: xfs_ilock+0x104/0x1b0 [xfs]</span><br><span class="line">[ 4398.608937]  #1: ffff8b5bd4771c38 (&amp;bfqd-&gt;lock)&#123;?.-.&#125;-&#123;2:2&#125;, at: bfq_bio_merge+0x9f/0x150 [bfq]</span><br><span class="line">[ 4398.617637] </span><br><span class="line">               stack backtrace:</span><br><span class="line">[ 4398.621999] CPU: 19 PID: 156503 Comm: fio Kdump: loaded Not tainted 5.15.0-26-generic #26</span><br><span class="line">[ 4398.630170] Hardware name: Supermicro SYS-6029TP-H-EI012/X11DPT-PS-EI012, BIOS 1.0.9.0 01/31/2018</span><br><span class="line">[ 4398.639036] Call Trace:</span><br><span class="line">[ 4398.641488]  &lt;TASK&gt;</span><br><span class="line">[ 4398.643596]  dump_stack_lvl+0x6e/0x9c</span><br><span class="line">[ 4398.647284]  dump_stack+0x10/0x12</span><br><span class="line">[ 4398.650605]  print_usage_bug.part.0+0x18e/0x19d</span><br><span class="line">[ 4398.655138]  mark_lock_irq.cold+0x11/0x2c</span><br><span class="line">[ 4398.659151]  ? stack_trace_save+0x4c/0x70</span><br><span class="line">[ 4398.663164]  ? save_trace+0x45/0x2f0</span><br><span class="line">[ 4398.666742]  mark_lock.part.0+0x11f/0x220</span><br><span class="line">[ 4398.670756]  mark_held_locks+0x54/0x80</span><br><span class="line">[ 4398.674510]  ? adjust_inuse_and_calc_cost+0x164/0x2c0</span><br><span class="line">[ 4398.679563]  lockdep_hardirqs_on_prepare+0x7f/0x1c0</span><br><span class="line">[ 4398.680859] patch_est_timer: disagrees about version of symbol module_layout</span><br><span class="line">[ 4398.684449]  ? _raw_spin_unlock_irq+0x28/0x40</span><br><span class="line">[ 4398.695856]  trace_hardirqs_on+0x21/0xe0</span><br><span class="line">[ 4398.699791]  _raw_spin_unlock_irq+0x28/0x40</span><br><span class="line">[ 4398.703974]  adjust_inuse_and_calc_cost+0x164/0x2c0</span><br><span class="line">[ 4398.708858]  ioc_rqos_merge+0xef/0x280</span><br><span class="line">[ 4398.712608]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[ 4398.716272]  bio_attempt_back_merge+0x63/0x160</span><br><span class="line">[ 4398.720722]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[ 4398.725256]  bfq_bio_merge+0xe2/0x150 [bfq]</span><br><span class="line">[ 4398.729448]  __blk_mq_sched_bio_merge+0x36/0x1b0</span><br><span class="line">[ 4398.734069]  blk_mq_submit_bio+0xd5/0x900</span><br><span class="line">[ 4398.738082]  __submit_bio+0x307/0x340</span><br><span class="line">[ 4398.741746]  ? get_user_pages_fast+0x24/0x40</span><br><span class="line">[ 4398.746018]  ? iov_iter_get_pages+0xc6/0x400</span><br><span class="line">[ 4398.750292]  submit_bio_noacct+0x26c/0x2d0</span><br><span class="line">[ 4398.754393]  submit_bio+0x48/0x140</span><br><span class="line">[ 4398.757797]  iomap_dio_submit_bio+0x7c/0x90</span><br><span class="line">[ 4398.761983]  iomap_dio_bio_iter+0x2da/0x4b0</span><br><span class="line">[ 4398.766172]  __iomap_dio_rw+0x514/0x830</span><br><span class="line">[ 4398.770012]  iomap_dio_rw+0xe/0x30</span><br><span class="line">[ 4398.773413]  xfs_file_dio_write_aligned+0xb9/0x1a0 [xfs]</span><br><span class="line">[ 4398.778821]  ? sched_clock_cpu+0x12/0xe0</span><br><span class="line">[ 4398.782749]  xfs_file_write_iter+0x101/0x1a0 [xfs]</span><br><span class="line">[ 4398.787613]  aio_write+0x131/0x310</span><br><span class="line">[ 4398.791019]  ? __fget_files+0xcf/0x1c0</span><br><span class="line">[ 4398.794771]  __io_submit_one.constprop.0+0x43a/0x570</span><br><span class="line">[ 4398.799740]  ? __io_submit_one.constprop.0+0x43a/0x570</span><br><span class="line">[ 4398.804885]  ? sched_clock_cpu+0x12/0xe0</span><br><span class="line">[ 4398.808819]  ? io_submit_one+0xd9/0x870</span><br><span class="line">[ 4398.812671]  io_submit_one+0x142/0x870</span><br><span class="line">[ 4398.816429]  ? io_submit_one+0x142/0x870</span><br><span class="line">[ 4398.820373]  __x64_sys_io_submit+0x97/0x2a0</span><br><span class="line">[ 4398.824569]  ? syscall_trace_enter.isra.0+0x186/0x250</span><br><span class="line">[ 4398.829632]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 4398.833217]  ? __x64_sys_io_cancel+0x250/0x250</span><br><span class="line">[ 4398.837660]  ? do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 4398.841412]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 4398.845165]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 4398.848921]  ? sysvec_call_function_single+0x4e/0x90</span><br><span class="line">[ 4398.853884]  ? asm_sysvec_call_function_single+0xa/0x20</span><br><span class="line">[ 4398.859110]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br><span class="line">[ 4398.864165] RIP: 0033:0x7fd43e139697</span><br><span class="line">[ 4398.867746] Code: 00 75 10 8b 47 0c 39 47 08 74 10 0f 1f 84 00 00 00 00 00 e9 bb ff ff ff 0f 1f 00 31 c0 c3 0f 1f 44 00 00 b8 d1 00 00 00 0f 05 &lt;c3&gt; 0f 1f 84 00 00 00 00 00 b8 d2 00 00 00 0f 05 c3 0f 1f 84 00 00</span><br><span class="line">[ 4398.886488] RSP: 002b:00007fd439a49cc8 EFLAGS: 00000202 ORIG_RAX: 00000000000000d1</span><br><span class="line">[ 4398.894057] RAX: ffffffffffffffda RBX: 00007fd43a24c000 RCX: 00007fd43e139697</span><br><span class="line">[ 4398.901187] RDX: 00007fd43400d530 RSI: 0000000000000001 RDI: 00007fd43eb24000</span><br><span class="line">[ 4398.908323] RBP: 00007fd43a24c000 R08: 00007fd43a7051f0 R09: 00000000000001f0</span><br><span class="line">[ 4398.915454] R10: 0000000004455000 R11: 0000000000000202 R12: 00007fd43400ccf0</span><br><span class="line">[ 4398.922587] R13: 00007fd43400d740 R14: 00007fd43400d530 R15: 00007fd43a251210</span><br><span class="line">[ 4398.929725]  &lt;/TASK&gt;</span><br></pre></td></tr></table></figure>



<p>Lock chain:</p>
<ol>
<li>bfq_bio_merge:</li>
</ol>
<p>​	spin_lock_irq(&amp;bfqd-&gt;lock);</p>
<p>​	blk_mq_sched_try_merge:</p>
<p>​		adjust_inuse_and_calc_cost:</p>
<p>​				spin_lock_irq(&amp;ioc-&gt;lock);</p>
<p>​				spin_unlock_irq(&amp;ioc-&gt;lock);</p>
<ol start="2">
<li>bfq_finish_requeue_request:</li>
</ol>
<p>​		spin_lock_irqsave(&amp;bfqd-&gt;lock, flags);</p>
<p>​		…</p>
<p>​		spin_unlock_irqrestore(&amp;bfqd-&gt;lock, flags);</p>
<p><img src="https://lh7-us.googleusercontent.com/bq2FPR6rf3vTi3qwBroUf_ukX2q8_kuRj8GbANgmURAwdcfd3c6QBivBGFvtvvADlqdTU4CbjvhIBrHzJefKR8UpE5WR7A0jZ7tFH5odAsfF8JjofHbi2vq8AFHgUT6cdfmcOxm0Tc0gyZCdXJGYfog" alt="img"></p>
<p>There is a process running on cpu and hold a lock spin_lock_irq(&amp;bfqd-&gt;lock), then the process to hold the second lock by spin_lock_irq(&amp;ioc-&gt;lock), after finish calculation, the process release the second lock spin_unlock_irq(&amp;ioc-&gt;lock), at this time the kernel allow irq, and a irq preempts the cpu and when run into function <em>bfq_finish_requeue_request,</em> it try to hold the first lock by spin_lock_irqsave(&amp;bfqd-&gt;lock, flags), but it is still hold by original process, so it is deadlock. The locked module can detect this case and reprot the risk into dmesg (stack 3). </p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>This kernel patch fix the issue in kernel 6.3.13 version:</p>
<p><em><a target="_blank" rel="noopener" href="https://lwn.net/Articles/937933/">https://lwn.net/Articles/937933/</a></em></p>
<p><a target="_blank" rel="noopener" href="https://www.spinics.net/lists/stable/msg669695.html"><em>https://www.spinics.net/lists/stable/msg669695.html</em></a></p>
<p>In this patch, the fix is using <em>spin_lock_irqsave</em> to replace <em>spin_lock_irq</em> in the function of “<em>adjust_inuse_and_calc_cost</em>” to block the irq when unlocked.</p>
<p>We will cherry-pick the patch into our 5.15 kernel.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2023-12-15-wa%20calculation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2023-12-15-wa%20calculation/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:46:27" itemprop="dateCreated datePublished" datetime="2024-03-10T12:46:27+08:00">2024-03-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<h2 id="title-what-is-wa-annd-how-is-it-calculatedupdate-2023-12-29-14-42-45tags-linuxcategories-system"><a href="#title-what-is-wa-annd-how-is-it-calculatedupdate-2023-12-29-14-42-45tags-linuxcategories-system" class="headerlink" title="title: what is wa annd how is it calculatedupdate: 2023-12-29 14:42:45tags: linuxcategories: system"></a>title: what is wa annd how is it calculated<br>update: 2023-12-29 14:42:45<br>tags: linux<br>categories: system</h2><h3 id="Question-wa-usage"><a href="#Question-wa-usage" class="headerlink" title="Question: wa usage"></a>Question: wa usage</h3><p>When you run top, you can see the usage of wa. What does it means and how it calculated?</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">Cpu(s):  0.1 us,  2.4 sy,  0.0 ni, 93.6 <span class="built_in">id</span>,  3.9 wa,  0.0 hi,  0.0 si,  0.0 st</span></span><br></pre></td></tr></table></figure>

<p>Values related to processor utilization are displayed on the third line. They provide insight into exactly what the CPUs are doing.</p>
<ul>
<li><code>us</code> is the percent of time spent running user processes.</li>
<li><code>sy</code> is the percent of time spent running the kernel.</li>
<li><code>ni</code> is the percent of time spent running processes with manually configured <a target="_blank" rel="noopener" href="https://www.redhat.com/sysadmin/manipulate-process-priority">nice values</a>.</li>
<li><code>id</code> is the percent of time idle (if high, CPU may be overworked).</li>
<li><strong><code>wa</code> is the percent of wait time (if high, CPU is waiting for I&#x2F;O access).</strong></li>
<li><code>hi</code> is the percent of time managing hardware interrupts.</li>
<li><code>si</code> is the percent of time managing software interrupts.</li>
<li><code>st</code> is the percent of virtual CPU time waiting for access to physical CPU.</li>
</ul>
<p>In the context of the <code>top</code> command in Unix-like operating systems, the “wa” field represents the percentage of time the CPU spends waiting for I&#x2F;O operations to complete. Specifically, it stands for “waiting for I&#x2F;O.”</p>
<p>The calculation includes the time the CPU is idle while waiting for data to be read from or written to storage devices such as hard drives or SSDs. High values in the “wa” field may indicate that the system is spending a significant amount of time waiting for I&#x2F;O operations to complete, which could be a bottleneck if not addressed.</p>
<p>The formula for calculating the “wa” value is as follows:</p>
<p><strong><code>wa %=(Time spent waiting for I/O / Total CPU time)×100</code></strong></p>
<p>Also we can use <code>vmstat 1</code> to watch the <code>wa</code> state in system, but it is the not the percent:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vmstat 1</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 5  9      0 25994684     24 64404172    0    0     1    16    0    0  4  3 93  0  0</span><br><span class="line"> 0 10      0 25994436     24 64404172    0    0 342776 341104 63906 52162  2 10 83  4  3</span><br><span class="line"> 0 10      0 25994188     24 64404172    0    0 350392 350968 65593 52742  2 12 80  3  3</span><br><span class="line"> 1  9      0 25994188     24 64404172    0    0 342656 341128 63793 51367  2 11 80  3  4</span><br><span class="line"> 0 10      0 25994188     24 64404172    0    0 350760 350216 65439 52811  2 10 81  3  4</span><br><span class="line"> 5  8      0 25993940     24 64404172    0    0 355224 358952 66762 52421  2 10 80  3  5</span><br><span class="line"> 0 10      0 25993444     24 64404172    0    0 350536 350576 64998 52346  1 10 81  3  4</span><br><span class="line"> 1 10      0 25992948     24 64404172    0    0 348344 347912 64709 51990  1 11 81  3  4</span><br><span class="line"> 2 10      0 25992700     24 64404172    0    0 351944 349616 65443 51371  2 11 80  3  5</span><br><span class="line"> 0 10      0 26000764     24 64404172    0    0 343368 345000 64589 51969  2 12 80  3  4</span><br><span class="line"> 1  9      0 26000516     24 64404172    0    0 348976 352352 65800 53079  1  9 84  3  3</span><br><span class="line"> 1  9      0 26000516     24 64404172    0    0 345520 341800 63737 51454  1  8 84  3  3</span><br><span class="line"> 1  9      0 26000516     24 64404172    0    0 349192 352336 65719 52241  2  9 82  3  4</span><br><span class="line"> 1  9      0 26000516     24 64404172    0    0 352384 355696 66567 52232  2 11 80  3  4</span><br><span class="line"> 8  5      0 26000268     24 64404172    0    0 346368 345496 64541 52114  2 12 80  3  3</span><br><span class="line"> 0 10      0 26000020     24 64404172    0    0 340064 341296 63603 51670  2 11 81  3  2</span><br><span class="line"> 0  0      0 26007496     24 64399156    0    0 306736 306040 57770 46495  2 10 82  3  3</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     0  853 1480  0  0 100  0  0</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     0  871 1553  0  0 100  0  0</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     0  748 1430  0  0 100  0  0</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     2  731 1399  0  0 100  0  0</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     0  695 1319  0  0 100  0  0</span><br><span class="line"> 0  0      0 26007588     24 64398828    0    0     0     0  743 1418  0  0 100  0  0</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Procs</span><br><span class="line">    r: The number of processes waiting for run time.</span><br><span class="line">    b: The number of processes in uninterruptible sleep.</span><br><span class="line">Memory</span><br><span class="line">    swpd: the amount of virtual memory used.</span><br><span class="line">    free: the amount of idle memory.</span><br><span class="line">    buff: the amount of memory used as buffers.</span><br><span class="line">    cache: the amount of memory used as cache.</span><br><span class="line">    inact: the amount of inactive memory. (-a option)</span><br><span class="line">    active: the amount of active memory. (-a option)</span><br><span class="line">Swap</span><br><span class="line">    si: Amount of memory swapped in from disk (/s).</span><br><span class="line">    so: Amount of memory swapped to disk (/s).</span><br><span class="line">IO</span><br><span class="line">    bi: Blocks received from a block device (blocks/s).</span><br><span class="line">    bo: Blocks sent to a block device (blocks/s).</span><br><span class="line">System</span><br><span class="line">    in: The number of interrupts per second, including the clock.</span><br><span class="line">    cs: The number of context switches per second.</span><br><span class="line">CPU</span><br><span class="line">    These are percentages of total CPU time.</span><br><span class="line">    us: Time spent running non-kernel code. (user time, including nice time)</span><br><span class="line">    sy: Time spent running kernel code. (system time)</span><br><span class="line">    id: Time spent idle. Prior to Linux 2.5.41, this includes IO-wait time.</span><br><span class="line">    wa: Time spent waiting for IO. Prior to Linux 2.5.41, included in idle.</span><br><span class="line">    st: Time stolen from a virtual machine. Prior to Linux 2.6.11, unknown.</span><br></pre></td></tr></table></figure>

<p>In summary, a high “wa” value in the output of <code>top</code> suggests that your system is spending a considerable amount of time waiting for I&#x2F;O operations to be completed, which could impact overall system performance. Investigating and optimizing disk I&#x2F;O can be beneficial in such cases, possibly by improving disk performance, optimizing file systems, or identifying and addressing specific I&#x2F;O-intensive processes. We can use <code>iotop</code> to find the high io or slow io processes in system:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Current DISK READ:     341.78 M/s | Current DISK WRITE:     340.53 M/s</span><br><span class="line">    TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">3487445 be/4 root       34.44 M/s   33.36 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487446 be/4 root       33.40 M/s   34.27 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487447 be/4 root       34.10 M/s   33.78 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487448 be/4 root       32.21 M/s   31.64 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487449 be/4 root       34.22 M/s   34.44 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487450 be/4 root       34.46 M/s   34.33 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487451 be/4 root       34.17 M/s   34.21 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487452 be/4 root       33.05 M/s   32.95 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487453 be/4 root       34.23 M/s   34.74 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">3487454 be/4 root       37.51 M/s   36.79 M/s  ?unavailable?  fio -filename=/mnt/hostroot/var/mnt/testfile -direct=1 -iodepth 64 -thread -rw=randrw -ioengine=libaio -bs=8k -size=20G -numjobs=10 -group_reporting --runtime=100 -name=mytest</span><br><span class="line">      1 be/4 root        0.00 B/s    0.00 B/s  ?unavailable?  systemd --switched-root --system --deserialize 29</span><br><span class="line">      2 be/4 root        0.00 B/s    0.00 B/s  ?unavailable?  [kthreadd]</span><br><span class="line">      3 be/4 root        0.00 B/s    0.00 B/s  ?unavailable?  [rcu_gp]</span><br><span class="line">      4 be/4 root        0.00 B/s    0.00 B/s  ?unavailable?  [rcu_par_gp]</span><br><span class="line">      6 be/4 root        0.00 B/s    0.00 B/s  ?unavailable?  [kworker/0:0H-events_highpri]</span><br></pre></td></tr></table></figure>

<h3 id="Code-tracing"><a href="#Code-tracing" class="headerlink" title="Code tracing"></a>Code tracing</h3><p>From strace the top command, the <code>wa</code>  value is get the status from <code>/proc/*/stat</code>. The <code>/proc/*/stat </code>is wrote by the proc ops and get the iowait time from <code>kernel_cpustat.cpustat[CPUTIME_IOWAIT]</code> accroding to the code <code>fs/proc/stat.c</code>. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">stat_proc_ops</span> =</span> &#123;</span><br><span class="line">	.proc_flags	= PROC_ENTRY_PERMANENT,</span><br><span class="line">	.proc_open	= stat_open,</span><br><span class="line">	.proc_read_iter	= seq_read_iter,</span><br><span class="line">	.proc_lseek	= seq_lseek,</span><br><span class="line">	.proc_release	= single_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">proc_stat_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	proc_create(<span class="string">&quot;stat&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;stat_proc_ops);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">stat_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size = <span class="number">1024</span> + <span class="number">128</span> * num_online_cpus();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* minimum size to display an interrupt count : 2 bytes */</span></span><br><span class="line">	size += <span class="number">2</span> * nr_irqs;</span><br><span class="line">	<span class="keyword">return</span> single_open_size(file, show_stat, <span class="literal">NULL</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">show_stat</span><span class="params">(<span class="keyword">struct</span> seq_file *p, <span class="type">void</span> *v)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  		iowait		+= get_iowait_time(&amp;kcpustat, i);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u64 <span class="title function_">get_iowait_time</span><span class="params">(<span class="keyword">struct</span> kernel_cpustat *kcs, <span class="type">int</span> cpu)</span></span><br><span class="line">&#123;</span><br><span class="line">	u64 iowait, iowait_usecs = <span class="number">-1ULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpu_online(cpu))</span><br><span class="line">		iowait_usecs = get_cpu_iowait_time_us(cpu, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iowait_usecs == <span class="number">-1ULL</span>)</span><br><span class="line">		<span class="comment">/* !NO_HZ or cpu offline so we can rely on cpustat.iowait */</span></span><br><span class="line">		iowait = kcs-&gt;cpustat[CPUTIME_IOWAIT];</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		iowait = iowait_usecs * NSEC_PER_USEC;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> iowait;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In the Linux kernel, the calculation of the “wa” (waiting for I&#x2F;O) value that is reported by tools like <code>top</code> is handled within the kernel’s scheduler. The specific code responsible for updating the CPU usage statistics can be found in the <code>kernel/sched/cputime.c</code> file.</p>
<p>One of the key functions related to this is <code>account_idle_time()</code>. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Account for idle time.</span></span><br><span class="line"><span class="comment"> * @cputime: the CPU time spent in idle wait</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">account_idle_time</span><span class="params">(u64 cputime)</span></span><br><span class="line">&#123;</span><br><span class="line">	u64 *cpustat = kcpustat_this_cpu-&gt;cpustat;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span> =</span> this_rq();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="type">atomic_read</span>(&amp;rq-&gt;nr_iowait) &gt; <span class="number">0</span>)</span><br><span class="line">		cpustat[CPUTIME_IOWAIT] += cputime;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		cpustat[CPUTIME_IDLE] += cputime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	u32 nr_iowait;		<span class="comment">/* number of blocked threads (waiting for I/O)    */</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>This function is part of the kernel’s scheduler and is responsible for updating the various CPU time statistics, including the time spent waiting for I&#x2F;O. The function takes into account different CPU states, such as idle time and time spent waiting for I&#x2F;O.When The blocked threads with waiting for I&#x2F;O, the cpu time accumulated into CPUTIME_IOWAIT.</p>
<p>Here is a basic outline of how the “wa” time is accounted for in the Linux kernel:</p>
<ol>
<li><strong>Idle time accounting:</strong> The kernel keeps track of the time the CPU spends in an idle state, waiting for tasks to execute.</li>
<li><strong>I&#x2F;O wait time accounting:</strong> When a process is waiting for I&#x2F;O operations (such as reading or writing to a disk), the kernel accounts for this time in the appropriate CPU state, including the “wa” time.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># block/fops.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> __blkdev_direct_IO(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *iter,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		set_current_state(TASK_UNINTERRUPTIBLE);</span><br><span class="line">		<span class="keyword">if</span> (!READ_ONCE(dio-&gt;waiter))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		blk_io_schedule();</span><br><span class="line">	&#125;</span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line">  ...</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># block/blk-core.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">blk_io_schedule</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Prevent hang_check timer from firing at us during very long I/O */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> timeout = sysctl_hung_task_timeout_secs * HZ / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (timeout)</span><br><span class="line">		io_schedule_timeout(timeout);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		io_schedule();</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(blk_io_schedule);</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kernel/sched/core.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This task is about to go to sleep on IO. Increment rq-&gt;nr_iowait so</span></span><br><span class="line"><span class="comment"> * that process accounting knows that this is a task in IO wait state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> __sched <span class="title function_">io_schedule_timeout</span><span class="params">(<span class="type">long</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> token;</span><br><span class="line">	<span class="type">long</span> ret;</span><br><span class="line"></span><br><span class="line">	token = io_schedule_prepare();</span><br><span class="line">	ret = schedule_timeout(timeout);</span><br><span class="line">	io_schedule_finish(token);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(io_schedule_timeout);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">io_schedule_prepare</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> old_iowait = current-&gt;in_iowait;</span><br><span class="line"></span><br><span class="line">	current-&gt;in_iowait = <span class="number">1</span>;</span><br><span class="line">	blk_flush_plug(current-&gt;plug, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">return</span> old_iowait;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">io_schedule_finish</span><span class="params">(<span class="type">int</span> token)</span></span><br><span class="line">&#123;</span><br><span class="line">	current-&gt;in_iowait = token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asmlinkage __visible <span class="type">void</span> __sched <span class="title function_">schedule</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> =</span> current;</span><br><span class="line"></span><br><span class="line">	sched_submit_work(tsk);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		preempt_disable();</span><br><span class="line">		__schedule(SM_NONE);</span><br><span class="line">		sched_preempt_enable_no_resched();</span><br><span class="line">	&#125; <span class="keyword">while</span> (need_resched());</span><br><span class="line">	sched_update_worker(tsk);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(schedule);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __sched notrace __schedule(<span class="type">unsigned</span> <span class="type">int</span> sched_mode)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">			<span class="keyword">if</span> (prev-&gt;in_iowait) &#123;</span><br><span class="line">				<span class="type">atomic_inc</span>(&amp;rq-&gt;nr_iowait);</span><br><span class="line">				delayacct_blkio_start();</span><br><span class="line">			&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kernel/time/timer.c</span></span><br><span class="line"><span class="type">signed</span> <span class="type">long</span> __sched <span class="title function_">schedule_timeout</span><span class="params">(<span class="type">signed</span> <span class="type">long</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">process_timer</span> <span class="title">timer</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> expire;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (timeout)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> MAX_SCHEDULE_TIMEOUT:</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * These two special cases are useful to be comfortable</span></span><br><span class="line"><span class="comment">		 * in the caller. Nothing more. We could take</span></span><br><span class="line"><span class="comment">		 * MAX_SCHEDULE_TIMEOUT from one of the negative value</span></span><br><span class="line"><span class="comment">		 * but I&#x27; d like to return a valid offset (&gt;=0) to allow</span></span><br><span class="line"><span class="comment">		 * the caller to do everything it want with the retval.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		schedule();</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">try_to_wake_up</span><span class="params">(<span class="keyword">struct</span> task_struct *p, <span class="type">unsigned</span> <span class="type">int</span> state, <span class="type">int</span> wake_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">   <span class="keyword">if</span> (task_cpu(p) != cpu) &#123;</span><br><span class="line">		<span class="keyword">if</span> (p-&gt;in_iowait) &#123;</span><br><span class="line">			delayacct_blkio_end(p);</span><br><span class="line">			<span class="type">atomic_dec</span>(&amp;task_rq(p)-&gt;nr_iowait);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		wake_flags |= WF_MIGRATED;</span><br><span class="line">		psi_ttwu_dequeue(p);</span><br><span class="line">		set_task_cpu(p, cpu);</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2023-12-15-blktrace%20block%20io%20lifecycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2023-12-15-blktrace%20block%20io%20lifecycle/" class="post-title-link" itemprop="url">blktrace block io lifecycle</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:46:14" itemprop="dateCreated datePublished" datetime="2024-03-10T12:46:14+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system/" itemprop="url" rel="index"><span itemprop="name">system</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Question-trace-the-life-of-IO-by-blktrace-blkparse"><a href="#Question-trace-the-life-of-IO-by-blktrace-blkparse" class="headerlink" title="Question: trace the life of IO by blktrace&#x2F;blkparse"></a>Question: trace the life of IO by blktrace&#x2F;blkparse</h3><p><a target="_blank" rel="noopener" href="https://linux.die.net/man/8/blktrace">blktrace</a></p>
<p><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/blkparse">blkparse</a></p>
<p>Investigate the blktrace implementation to understand the trace hook of the blk IO stack?</p>
<h3 id="blktrace-to-parse-the-block-io"><a href="#blktrace-to-parse-the-block-io" class="headerlink" title="blktrace to parse the block io"></a>blktrace to parse the block io</h3><p><code>blktrace</code> explores the Linux kernel tracepoint infrastructure to track requests in-flight through the block I&#x2F;O stack. It traces everything that goes through to block devices, while observing timing information. </p>
<p>First we using <code>dd</code> command to make a write IO (the read IO is the same). </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// write to a file with direct io by dd command</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=testfile bs=16k count=1024000 oflag=direct</span></span><br><span class="line">1024000+0 records in</span><br><span class="line">1024000+0 records out</span><br><span class="line">16777216000 bytes (17 GB, 16 GiB) copied, 111.433 s, 151 MB/s</span><br></pre></td></tr></table></figure>

<p>Using<code>blktrace</code> and <code>blkparse</code> analize results:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blktrace -d /dev/vda -o res</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blkparse -i res</span></span><br><span class="line">device  </span><br><span class="line">252,0   10        3     0.000238760       0  C  WS 49724200 + 32 [0]</span><br><span class="line">252,0    0       17     0.000261770 3418552  A  WS 48720712 + 32 &lt;- (253,0) 48718664</span><br><span class="line">252,0    0       18     0.000262000 3418552  A  WS 49724232 + 32 &lt;- (252,3) 48720712</span><br><span class="line">252,0    0       19     0.000262192 3418552  Q  WS 49724232 + 32 [dd]</span><br><span class="line">252,0    0       20     0.000263132 3418552  G  WS 49724232 + 32 [dd]</span><br><span class="line">252,0    0       21     0.000263335 3418552  P   N [dd]</span><br><span class="line">252,0    0       22     0.000263494 3418552  U   N [dd] 1</span><br><span class="line">252,0    0       23     0.000263719 3418552  I  WS 49724232 + 32 [dd]</span><br><span class="line">252,0    0       24     0.000264296 3418552  D  WS 49724232 + 32 [dd]</span><br><span class="line">252,0   10        4     0.000341566       0  C  WS 49724232 + 32 [0]</span><br><span class="line">252,0    0       25     0.000366914 3418552  A  WS 48720744 + 32 &lt;- (253,0) 48718696</span><br><span class="line">252,0    0       26     0.000367235 3418552  A  WS 49724264 + 32 &lt;- (252,3) 48720744</span><br><span class="line">252,0    0       27     0.000367410 3418552  Q  WS 49724264 + 32 [dd]</span><br><span class="line">252,0    0       28     0.000368423 3418552  G  WS 49724264 + 32 [dd]</span><br><span class="line">252,0    0       29     0.000368612 3418552  P   N [dd]</span><br><span class="line">252,0    0       30     0.000368797 3418552  U   N [dd] 1</span><br><span class="line">252,0    0       31     0.000369036 3418552  I  WS 49724264 + 32 [dd]</span><br><span class="line">252,0    0       32     0.000369730 3418552  D  WS 49724264 + 32 [dd]</span><br><span class="line">252,0   10        5     0.000453876       0  C  WS 49724264 + 32 [0]</span><br><span class="line">...</span><br><span class="line">252,0   10    91033     2.279081418 3405085  C  WS 50399976 + 32 [0]</span><br><span class="line">252,0   10   232460     5.618988454 3405085  C  WS 51349952 + 32 [0]</span><br><span class="line">252,0   10   318363     8.424729857 3405085  C  WM 39888904 + 16 [0]</span><br><span class="line">252,0   10   318364     8.424732534 3405085  C  WM 267886593 + 1 [0]</span><br><span class="line">252,0   10   318365     8.424734981 3405085  C  WM 267886600 + 16 [0]</span><br><span class="line">252,0   10   318366     8.424737948 3405085  C  WM 267925376 + 32 [0]</span><br><span class="line">252,0   10   318367     8.424750755 3405085  C  WM 267924512 + 32 [0]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Total (res):</span><br><span class="line"> Reads Queued:           0,        0KiB  Writes Queued:       70567,     1128MiB</span><br><span class="line"> Read Dispatches:        3,        0KiB  Write Dispatches:    70559,     1128MiB</span><br><span class="line"> Reads Requeued:         0               Writes Requeued:         0</span><br><span class="line"> Reads Completed:        3,        0KiB  Writes Completed:    70563,     1128MiB</span><br><span class="line"> Read Merges:            0,        0KiB  Write Merges:            6,       24KiB</span><br><span class="line"> IO unplugs:         70545               Timer unplugs:           0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tracing 267886608</span></span><br><span class="line">252,0    6       71     8.424115456   585  A  WM 267886608 + 8 &lt;- (252,3) 266883088</span><br><span class="line">252,0    6       72     8.424115630   585  Q  WM 267886608 + 8 [xfsaild/dm-0]</span><br><span class="line">252,0    6       73     8.424115962   585  M  WM 267886608 + 8 [xfsaild/dm-0]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tracing 4555007</span></span><br><span class="line">252,0    9        2     8.423915195 3374227  A WFSM 4555007 + 31 &lt;- (252,3) 3551487</span><br><span class="line">252,0    9        3     8.423915869 3374227  Q WFSM 4555007 + 31 [kworker/9:4]</span><br><span class="line">252,0    9        4     8.423918485 3374227  G WFSM 4555007 + 31 [kworker/9:4]</span><br><span class="line">252,0    9        5     8.423927401   240  D WSM 4555007 + 31 [kworker/9:1H]</span><br><span class="line">252,0   10   318350     8.424051685     0  C WSM 4555007 + 31 [0]</span><br><span class="line">252,0   10   318353     8.424169747     0  C WSM 4555007 [0]</span><br></pre></td></tr></table></figure>

<p>![*Screenshot 2023-12-25 at 13.37.09*](&#x2F;Users&#x2F;tashen&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;Screenshot 2023-12-25 at 13.37.09.png)</p>
<h4 id="ACTION-IDENTIFIERS"><a href="#ACTION-IDENTIFIERS" class="headerlink" title="ACTION IDENTIFIERS"></a>ACTION IDENTIFIERS</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">The following table shows the various actions which may be</span><br><span class="line">       output:</span><br><span class="line"></span><br><span class="line">       A      IO was remapped to a different device</span><br><span class="line"></span><br><span class="line">       B      IO bounced</span><br><span class="line"></span><br><span class="line">       C      IO completion</span><br><span class="line"></span><br><span class="line">       D      IO issued to driver</span><br><span class="line"></span><br><span class="line">       F      IO front merged with request on queue</span><br><span class="line"></span><br><span class="line">       G      Get request</span><br><span class="line"></span><br><span class="line">       I      IO inserted onto request queue</span><br><span class="line"></span><br><span class="line">       M      IO back merged with request on queue</span><br><span class="line"></span><br><span class="line">       P      Plug request</span><br><span class="line"></span><br><span class="line">       Q      IO handled by request queue code</span><br><span class="line"></span><br><span class="line">       S      Sleep request</span><br><span class="line"></span><br><span class="line">       T      Unplug due to timeout</span><br><span class="line"></span><br><span class="line">       U      Unplug request</span><br><span class="line"></span><br><span class="line">       X      Split</span><br></pre></td></tr></table></figure>

<p>The result is long and there only paste few of them. I try to trace an different sectors and behaviors of block layer.</p>
<p><code>blkparse</code> command still hard to know the total metrics and statistics, so we can use <code>btt</code> to see the statistic of whole table and picture, this is the part of results:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blkparse -q -i res   -d sda.blk.bin</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">btt -i sda.blk.bin</span></span><br><span class="line"></span><br><span class="line">==================== All Devices ====================</span><br><span class="line"></span><br><span class="line">            ALL           MIN           AVG           MAX           N</span><br><span class="line">--------------- ------------- ------------- ------------- -----------</span><br><span class="line"></span><br><span class="line">Q2Q               0.000001441   0.000119382   0.802839654       70564</span><br><span class="line">Q2G               0.000000497   0.000000797   0.000025123       70559</span><br><span class="line">G2I               0.000000406   0.000000654   0.000128249       70558</span><br><span class="line">Q2M               0.000000133   0.000000271   0.000000631           6</span><br><span class="line">I2D               0.000000411   0.000000663   0.000017267       70558</span><br><span class="line">M2D               0.000031518   0.000071988   0.000116699           6</span><br><span class="line">D2C               0.000064651   0.000079818   0.002640604       70565</span><br><span class="line">Q2C               0.000066315   0.000081939   0.002643331       70565</span><br><span class="line"></span><br><span class="line">==================== Device Overhead ====================</span><br><span class="line"></span><br><span class="line">       DEV |       Q2G       G2I       Q2M       I2D       D2C</span><br><span class="line">---------- | --------- --------- --------- --------- ---------</span><br><span class="line"> (252,  0) |   0.9723%   0.7983%   0.0000%   0.8096%  97.4121%</span><br><span class="line">---------- | --------- --------- --------- --------- ---------</span><br><span class="line">   Overall |   0.9723%   0.7983%   0.0000%   0.8096%  97.4121%</span><br><span class="line"></span><br><span class="line">==================== Device Merge Information ====================</span><br><span class="line"></span><br><span class="line">       DEV |       #Q       #D   Ratio |   BLKmin   BLKavg   BLKmax    Total</span><br><span class="line">---------- | -------- -------- ------- | -------- -------- -------- --------</span><br><span class="line"> (252,  0) |    70565    70559     1.0 |        1       31       32  2257605</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Q-------&gt;G------------&gt;I---------&gt;M-------------------&gt;D-----------------------------&gt;C</span><br><span class="line">|-Q time-|-Insert time-|</span><br><span class="line">|--------- merge time ------------|-merge with other IO|</span><br><span class="line">|----------------scheduler time time-------------------|---driver,adapter,storagetime--|</span><br><span class="line"></span><br><span class="line">|----------------------- await time in iostat output ----------------------------------|</span><br></pre></td></tr></table></figure>

<p>Q2Q — time between requests sent to the block layer </p>
<p>Q2G — time from a block I&#x2F;O is queued to the time it gets a request allocated for it</p>
<p>G2I — time from a request is allocated to the time it is inserted into the device’s queue </p>
<p>Q2M — time from a block I&#x2F;O is queued to the time it gets merged with an existing request </p>
<p>I2D — time from a request is inserted into the device’s queue to the time it is actually issued to the device (time the I&#x2F;O is “idle” on the request queue)</p>
<p>M2D — time from  a block I&#x2F;O is merged with an exiting request until the request is issued to the device </p>
<p>D2C — service time of the request by the device (time the I&#x2F;O is “active” in the driver and on the device)</p>
<p>Q2C — total time spent in the block layer  for a request</p>
<p>Actually the blktrace’s implement is using various linux kernel tracepoint to trace different phase of IO. Here are some of the key tracepoints used by <code>blktrace</code>:</p>
<ol>
<li><code>block_rq_insert</code>: This tracepoint is hit when a request is inserted into the request queue.(Q)</li>
<li><code>block_rq_issue</code>: This tracepoint is hit when a request is issued to the device.(I)</li>
<li><code>block_rq_complete</code>: This tracepoint is hit when a request is completed.(C)</li>
<li><code>block_bio_queue</code>: This tracepoint is hit when a bio is queued.(Q)</li>
<li><code>block_bio_backmerge</code>: This tracepoint is hit when a bio is being merged with the last bio in the request.</li>
<li><code>block_bio_frontmerge</code>: This tracepoint is hit when a bio is being merged with the first bio in the request.</li>
<li><code>block_bio_bounce</code>: This tracepoint is hit when a bio is bounced.</li>
<li><code>block_getrq</code>: This tracepoint is hit when get_request() is called to allocate a request.</li>
<li><code>block_sleeprq</code>: This tracepoint is hit when a process is going to sleep waiting for a request to be available.</li>
<li><code>block_plug</code>: This tracepoint is hit when a plug is inserted into the request queue.</li>
<li><code>block_unplug</code>: This tracepoint is hit when a plug is removed from the request queue.</li>
</ol>
<h3 id="Main-data-structure-in-block-layer"><a href="#Main-data-structure-in-block-layer" class="headerlink" title="Main data structure in block layer"></a>Main data structure in block layer</h3><p>To deepdiv the block layer, i read the code and finding as followes:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * main unit of I/O for the block layer and lower layers (ie drivers and</span></span><br><span class="line"><span class="comment"> * stacking drivers)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio</span>		*<span class="title">bi_next</span>;</span>	<span class="comment">/* request queue link */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">bi_bdev</span>;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span>       bi_rw; <span class="comment">/* read or write */</span></span><br><span class="line">  ...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>		*<span class="title">bi_io_vec</span>;</span>	<span class="comment">/* the actual vec list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bvec_iter</span>	<span class="title">bi_iter</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct bio_vec - a contiguous range of physical memory addresses</span></span><br><span class="line"><span class="comment"> * @bv_page:   First page associated with the address range.</span></span><br><span class="line"><span class="comment"> * @bv_len:    Number of bytes in the address range.</span></span><br><span class="line"><span class="comment"> * @bv_offset: Start of the address range relative to the start of @bv_page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The following holds for a bvec if n * PAGE_SIZE &lt; bv_offset + bv_len:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   nth_page(@bv_page, n) == @bv_page + n</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This holds because page_is_mergeable() checks the above property.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span>	*<span class="title">bv_page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bv_len;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bv_offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bvec_iter</span> &#123;</span></span><br><span class="line">	<span class="type">sector_t</span>		bi_sector;	<span class="comment">/* device address in 512 byte</span></span><br><span class="line"><span class="comment">						   sectors */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		bi_size;	<span class="comment">/* residual I/O count */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		bi_idx;		<span class="comment">/* current index into bvl_vec */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>            bi_bvec_done;	<span class="comment">/* number of bytes completed in</span></span><br><span class="line"><span class="comment">						   current bvec */</span></span><br><span class="line">&#125; __packed;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> &#123;</span></span><br><span class="line">	<span class="type">sector_t</span>		bd_start_sect;</span><br><span class="line">	<span class="type">sector_t</span>		bd_nr_sectors;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *	<span class="title">bd_disk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *	<span class="title">bd_queue</span>;</span></span><br><span class="line">  <span class="type">bool</span>			bd_has_submit_bio;</span><br><span class="line">  ...</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Try to put the fields that are referenced together in the same cacheline.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you modify this structure, make sure to update blk_rq_init() and</span></span><br><span class="line"><span class="comment"> * especially blk_mq_rq_ctx_init() to take care of the added fields.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *<span class="title">q</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bio</span> *<span class="title">bio</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio</span> *<span class="title">biotail</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queuelist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">request</span> *<span class="title">rq_next</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">mq_rq_state</span> <span class="title">state</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The hash is used inside the scheduler, and killed once the</span></span><br><span class="line"><span class="comment">	 * request reaches the dispatch list. The ipi_list is only used</span></span><br><span class="line"><span class="comment">	 * to queue the request for softirq completion, which is long</span></span><br><span class="line"><span class="comment">	 * after the request has been unhashed (and even removed from</span></span><br><span class="line"><span class="comment">	 * the dispatch list).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">hash</span>;</span>	<span class="comment">/* merge hash */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> <span class="title">ipi_list</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The rb_node is only used inside the io scheduler, requests</span></span><br><span class="line"><span class="comment">	 * are pruned when moved to the dispatch queue. So let the</span></span><br><span class="line"><span class="comment">	 * completion_data share space with the rb_node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span>	<span class="comment">/* sort/lookup */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> <span class="title">special_vec</span>;</span></span><br><span class="line">		<span class="type">void</span> *completion_data;</span><br><span class="line">	&#125;;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * completion callback.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rq_end_io_fn *end_io;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		*<span class="title">last_merge</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">elevator_queue</span>	*<span class="title">elevator</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rq_qos</span>		*<span class="title">rq_qos</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">blk_mq_ops</span>	*<span class="title">mq_ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">queue_limits</span>	<span class="title">limits</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * for flush operations</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_flush_queue</span>	*<span class="title">fq</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct blk_mq_hw_ctx - State for a hardware queue facing the hardware</span></span><br><span class="line"><span class="comment"> * block device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">blk_mq_hw_ctx</span> &#123;</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @queue: Pointer to the request queue that owns this hardware context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span>	*<span class="title">queue</span>;</span></span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @dispatch_busy: Number used by blk_mq_update_dispatch_busy() to</span></span><br><span class="line"><span class="comment">	 * decide if the hw_queue is busy using Exponential Weighted Moving</span></span><br><span class="line"><span class="comment">	 * Average algorithm.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		dispatch_busy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s3.bmp.ovh/imgs/2021/09/09b73ed1c3ac78a1.webp" alt="bio逻辑架构"></p>
<h3 id="code-flow-in-block-layer"><a href="#code-flow-in-block-layer" class="headerlink" title="code flow in block layer"></a>code flow in block layer</h3><p><img src="https://pic2.zhimg.com/80/v2-5b898fe018554749f56c270e77261a4d_1440w.webp" alt="img"></p>
<p>Bio -&gt;  Request -&gt; plug request list -&gt; staging request queue in sheduler -&gt; hardware request queue</p>
<p>![Screenshot 2023-12-25 at 13.54.30](&#x2F;Users&#x2F;tashen&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;Screenshot 2023-12-25 at 13.54.30.png)</p>
<p>![Screenshot 2023-12-25 at 13.57.23](&#x2F;Users&#x2F;tashen&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;Screenshot 2023-12-25 at 13.57.23.png)</p>
<p>These pictures records the total main code and function flow from the filessystem to block layer and to driver layder. It also prints the tracepoint mapping to the acation in output of the blktrace  where they trace from. By these tracepoint, we can understand the block io process flow more clearly. </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-repair-thinpool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-repair-thinpool/" class="post-title-link" itemprop="url">repair-thinpool</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Repair-thin-pool-document"><a href="#Repair-thin-pool-document" class="headerlink" title="Repair thin-pool document"></a>Repair thin-pool document</h1><h3 id="Use-lvm-repair"><a href="#Use-lvm-repair" class="headerlink" title="Use lvm repair"></a>Use lvm repair</h3><p>If you would have latest lvm2 tools - you could have tried:</p>
<ol>
<li><p>deactive if pool is active, before deactive pool, you must to deactive the volumes created from pool. if volume is created by lvm, just umount volume and lvchange, but if volume is created by devicemapper, need manual remove volume and record the deviceId deviceName and table to activate volume. Deactive, actually, is the process of remove the file link of &#x2F;dev&#x2F;vg&#x2F;volume and* &#x2F;dev&#x2F;mapper&#x2F;vg-volume.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvchange -an vg</span><br></pre></td></tr></table></figure>
</li>
<li><p>repair meta and active pool</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvconvert --repair  vg/pool</span><br></pre></td></tr></table></figure>
</li>
<li><p>active pool</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvchange -ay vg</span><br></pre></td></tr></table></figure>

<p>Below are the steps which happen while running the consistency check:</p>
<ol>
<li>Creates a new, repaired copy of the metadata.<br>lvconvert runs the thin_repair command to read damaged metadata from<br>the existing pool metadata LV, and writes a new repaired copy to the<br>VG’s pmspare LV.</li>
<li>Replaces the thin pool metadata LV.<br>If step 1 is successful, the thin pool metadata LV is replaced with<br>the pmspare LV containing the corrected metadata. The previous thin<br>pool metadata LV, containing the damaged metadata, becomes visible<br>with the new name ThinPoolLV_tmetaN (where N is 0,1,…).</li>
</ol>
<p>but in my lvm (version 2.02.166(2)-RHEL7 (2016-11-16)), repair will not create new pmspare, it will direct use free vg to create new meta:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tosqatest4 ~]# lvs -a silver_vg</span><br><span class="line">  LV                                VG        Attr       LSize   Pool                      Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  convoy_Linear_silver_data         silver_vg twi-aotz-- 894.25g                                  0.04   0.01                            </span><br><span class="line">  convoy_Linear_silver_data_meta0   silver_vg -wi-a-----   9.31g                                                                         </span><br><span class="line">  [convoy_Linear_silver_data_tdata] silver_vg Twi-ao---- 894.25g                                                                         </span><br><span class="line">  [convoy_Linear_silver_data_tmeta] silver_vg ewi-ao----   9.31g                                                                         </span><br><span class="line">  thinvolume                        silver_vg Vwi-aotz--   1.00g convoy_Linear_silver_data        40.04</span><br></pre></td></tr></table></figure>

<p>So pmspare device just a free space device nor a mirror of metadata, if not, we can add pv to vg for repair.</p>
<h3 id="Use-manual-repair"><a href="#Use-manual-repair" class="headerlink" title="Use manual repair"></a>Use manual repair</h3><p>With older tools - you need to go in these manual step:</p>
<ol>
<li><p>create temporary small LV</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -an -Zn -L10 --name temp vg</span><br></pre></td></tr></table></figure>
</li>
<li><p>replace pool’s metadata volume with this tempLV</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvconvert --thinpool vg/pool  --poolmetadata temp</span><br></pre></td></tr></table></figure></li>
</ol>
<p>(say ‘y’ to swap)</p>
<ol>
<li><p>activate &amp; repair metadata from ‘temp’ volume - you will likely need another volume where to store repaire metadata -</p>
<p>so create:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -Lat_least_as_big_as_temp  --name repaired  vg</span><br><span class="line">lvchage -ay vg/temp</span><br><span class="line">thin_repair -i /dev/vg/temp  /dev/vg/repaired</span><br></pre></td></tr></table></figure>

<p>if everything when fine - compare visualy ‘transaction_id’ of repaired metadata (thin_dump &#x2F;dev&#x2F;vg&#x2F;repaired)</p>
<ol>
<li><p>swap deactivated repaired volume back to your thin-pool</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvchange -an vg/repaired</span><br><span class="line">lvconvert --thinpool vg/pool --poolmetadata repaired</span><br></pre></td></tr></table></figure></li>
</ol>
<p>try to activate pool - if it doesn’t work report more problems.</p>
<h2 id="Metadata-space-exhaustion"><a href="#Metadata-space-exhaustion" class="headerlink" title="Metadata space exhaustion"></a>Metadata space exhaustion</h2><p>Metadata space exhaustion can lead to inconsistent thin pool metadata<br>and inconsistent file systems, so the response requires offline<br>checking and repair.</p>
<ol>
<li><p>Deactivate the thin pool LV, or reboot the system if this is not</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">possible.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Repair thin pool with lvconvert –repair.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">See &quot;Metadata check and repair&quot;.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extend pool metadata space with lvextend VG&#x2F;ThinPoolLV_tmeta.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">See &quot;Manually manage free metadata space of a thin pool LV&quot;.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check and repair file system with fsck.</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-raid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-raid/" class="post-title-link" itemprop="url">raid</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RAID"><a href="#RAID" class="headerlink" title="RAID"></a>RAID</h1><p>RAID是用于增加数据存储的性能和可靠性的技术。全程为Redundant Array of Inexpensive Disks（廉价磁盘冗余阵列）</p>
<ul>
<li>RAID 0 - strping</li>
<li>RAID 1 - mirroring</li>
<li>RAID 5 - striping with parity</li>
<li>RAID 6 - striping with double parity</li>
<li>RAID 10 - combining mirroring and striping</li>
</ul>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>mdadm目前是Linux标准RAID管理工具, 能够支持多种模式，可以对RAID进行创建，管理，添加和移除设备等，还能查看RAID设备的详细信息。功能非常强大。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$yum install mdadm -y</span><br><span class="line">$git clone git://neil.brown.name/mdadm</span><br></pre></td></tr></table></figure>



<p>devicemapper 也能创建RAID设备.</p>
<p>用dd创建4个镜像作为loop设备</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$dd if=/dev/zero of=disk1.img bs=512 count=4096000</span><br><span class="line">$losetup /dev/loop2 disk1.img</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="RAID-level-0-–-Striping"><a href="#RAID-level-0-–-Striping" class="headerlink" title="RAID level 0 – Striping"></a>RAID level 0 – Striping</h3><p><a target="_blank" rel="noopener" href="http://www.prepressure.com/images/raid-level-0-striping.svg"><img src="http://www.prepressure.com/images/raid-level-0-striping.svg" alt="image"></a></p>
<p>Raid 0 将数据进行条带化，同时向多个磁盘(至少2个)写数据.不做数据冗余，理想的情况，每个磁盘使用单独的控制器管理。</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li><p>读写性能好，没有数据冗余。</p>
</li>
<li><p>所有磁盘都有用.</p>
</li>
<li><p>容易实现.</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4></li>
<li><p>没有容错机制</p>
<h4 id="mdadm"><a href="#mdadm" class="headerlink" title="mdadm"></a>mdadm</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create --verbose /dev/md0 --level=stripe --raid-devices=2 /dev/loop2 /dev/loop3</span><br><span class="line">mdadm --manage --stop /dev/md0</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$fdisk -l</span><br><span class="line">...</span><br><span class="line">Disk /dev/md0: 4192 MB, 4192206848 bytes, 8187904 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 524288 bytes / 1048576 bytes</span><br><span class="line"></span><br><span class="line">$lsblk</span><br><span class="line">NAME  MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT</span><br><span class="line">...</span><br><span class="line">loop2  7:2    0     2G  0 loop  </span><br><span class="line">└─md0  9:0    0   3.9G  0 raid0 </span><br><span class="line">loop3  7:3    0     2G  0 loop  </span><br><span class="line">└─md0  9:0    0   3.9G  0 raid0</span><br></pre></td></tr></table></figure>



<h4 id="devicemapper"><a href="#devicemapper" class="headerlink" title="devicemapper"></a>devicemapper</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建4设备组成的raid0设备，16384000是4个设备总的Sector数量， 0 是每个设备的偏移量</span><br><span class="line">$dmsetup create test-raid0 --table &#x27;0 16384000 striped 4 128 /dev/loop4 0 /dev/loop5 0 /dev/loop6 0 /dev/loop7 0&#x27;</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$lsblk</span><br><span class="line">loop4         7:4    0     2G  0 loop  </span><br><span class="line">└─test-raid0  253:23   0   7.8G  0 dm    </span><br><span class="line">loop5         7:5    0     2G  0 loop  </span><br><span class="line">└─test-raid0  53:23   0   7.8G  0 dm    </span><br><span class="line">loop6         7:6    0     2G  0 loop  </span><br><span class="line">└─test-raid0  253:23   0   7.8G  0 dm    </span><br><span class="line">loop7         7:7    0     2G  0 loop  </span><br><span class="line">└─test-raid0  253:23   0   7.8G  0 dm</span><br><span class="line"></span><br><span class="line">$fdisk -l</span><br><span class="line">...</span><br><span class="line">Disk /dev/mapper/test-raid0: 8388 MB, 8388608000 bytes, 16384000 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 65536 bytes / 262144 bytes</span><br><span class="line"></span><br><span class="line">$dmsetup status test-raid0</span><br><span class="line">0 16384000 striped 4 7:4 7:5 7:6 7:7 1 AAAA</span><br></pre></td></tr></table></figure>



<h3 id="RAID-level-1-–-Mirroring"><a href="#RAID-level-1-–-Mirroring" class="headerlink" title="RAID level 1 – Mirroring"></a>RAID level 1 – Mirroring</h3><h3 id=""><a href="#" class="headerlink" title=""></a><a target="_blank" rel="noopener" href="http://www.prepressure.com/images/raid-level-1-mirroring.svg"><img src="http://www.prepressure.com/images/raid-level-1-mirroring.svg" alt="image"></a></h3><p>RAID 1 数据存储两次，如果一个drive挂了，控制器会使用另外一个drive或者直接拷贝另一个drive的数据给它。</p>
<p>RAID 1的优缺点很明显，值得一提的的是，它不能保证热交换磁盘，也就是说，当一块盘坏了之后，需要将计算机停机，然后才能更换磁盘。</p>
<h4 id="mdadm-1"><a href="#mdadm-1" class="headerlink" title="mdadm"></a>mdadm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$mdadm --create --verbose /dev/md0 --level=mirror --raid-devices=2 /dev/loop2 /dev/loop3</span><br></pre></td></tr></table></figure>

<h4 id="devicemapper-1"><a href="#devicemapper-1" class="headerlink" title="devicemapper"></a>devicemapper</h4><p>devicemapper中mirror与raid1是有差别的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 4096000是单个设备的sector数量，因为mirror没有扩大容量，2是设备数量， - 表示没有metadata 设备</span><br><span class="line">$dmsetup create test-raid1 --table &#x27;0 4096000 raid raid1 3 0 region_size 1024 2 - /dev/loop4 - /dev/loop5&#x27;</span><br><span class="line">//下面的是有metadata设备的raid1创建</span><br><span class="line">$dmsetup create test-raid1 --table &#x27;0 4096000 raid raid1 3 0 region_size 1024 2 /dev/loop4 /dev/loop5 /dev/loop6 /dev/loop7&#x27;</span><br><span class="line"></span><br><span class="line">$dmsetup status test-raid1</span><br><span class="line">0 4096000 raid raid1 2 AA 4096000/4096000 idle 0</span><br></pre></td></tr></table></figure>



<h3 id="RAID-level-5"><a href="#RAID-level-5" class="headerlink" title="RAID level 5"></a>RAID level 5</h3><p>最为普遍的RAID方式。要求至少3个drive，其中一个drive的一个磁盘作为奇偶校验盘，其他块做striping。所有奇偶校验盘会广泛分布在所有drive上。当有某个盘挂掉后，可以利用其他块以及奇偶校验盘来恢复数据，但如果同一个块中有两个设备挂掉，那么整个RAID就挂了。也就是说，RAID5能够支持单drive失败。<a target="_blank" rel="noopener" href="http://www.prepressure.com/images/raid-level-5-striping-with-parity.svg"><br><img src="http://www.prepressure.com/images/raid-level-5-striping-with-parity.svg" alt="image"></a></p>
<p>RAID5的优点是兼顾了读写性能和安全性，能够支持单drive的失败情况。缺点在于实现比较复杂，恢复数据比较慢，如果在恢复的过程中其他drive也发生故障，那么整个RAID就挂了。</p>
<h4 id="mdadm-2"><a href="#mdadm-2" class="headerlink" title="mdadm"></a>mdadm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// spare device指定备用磁盘，创建3块盘的RAID5</span><br><span class="line">$mdadm --create --verbose /dev/md1 --level=5 --raid-devices=3 /dev/loop4 /dev/loop5 /dev/loop6 --spare-devices=1 /dev/loop7</span><br></pre></td></tr></table></figure>

<p>查看信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$mdadm --detail /dev/md1/dev/md1:        Version : 1.2  Creation Time : Tue Mar  7 16:57:39 2017     Raid Level : raid5     Array Size : 4093952 (3.90 GiB 4.19 GB)  Used Dev Size : 2046976 (1999.34 MiB 2096.10 MB)   Raid Devices : 3  Total Devices : 4    Persistence : Superblock is persistent    Update Time : Tue Mar  7 16:57:57 2017          State : clean  Active Devices : 3Working Devices : 4 Failed Devices : 0  Spare Devices : 1         Layout : left-symmetric     Chunk Size : 512K           Name : st-integrat-node00:1  (local to host st-integrat-node00)           UUID : 071d2e75:2029e9a2:2e427dd9:d2ab804f         Events : 18    Number   Major   Minor   RaidDevice State       0       7        4        0      active sync   /dev/loop4       1       7        5        1      active sync   /dev/loop5       4       7        6        2      active sync   /dev/loop6       3       7        7        -      spare   /dev/loop7`</span><br></pre></td></tr></table></figure>

<h4 id="device-mapper"><a href="#device-mapper" class="headerlink" title="device-mapper"></a>device-mapper</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 这里创建了没有metadata设备的4个设备的raid5，因此大小是3倍磁盘扇区大小，有一个作为奇偶校验。 </span><br><span class="line">$dmsetup create test-raid5 --table &#x27;0 12288000 raid raid5_ls 3 64 region_size 1024 4 - /dev/loop4 - /dev/loop5 - /dev/loop6 - /dev/loop7&#x27;</span><br><span class="line">// metadata设备的创建过程和前面RAID1的类似，这里略过。</span><br><span class="line">//devicemapper还可以创建degraded RAID5,只需将最后一个设备置为 - 即可。</span><br><span class="line">$dmsetup create test-raid5 --table &#x27;0 12288000 raid raid5_ls 3 64 region_size 1024 4 - /dev/loop4 - /dev/loop5 - - -</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// resync 表示正在同步， 4096000/4096000表示全部同步完成。</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">dmsetup status test-raid5</span></span><br><span class="line">0 12288000 raid raid5_ls 4 aaaa 2048064/4096000 resync 0</span><br><span class="line">0 12288000 raid raid5_ls 4 AAAA 4096000/4096000 idle 0</span><br><span class="line">//同步过程中也是可以删除设备的</span><br></pre></td></tr></table></figure>

<h3 id="RAID-level-6-–-Striping-with-double-parity"><a href="#RAID-level-6-–-Striping-with-double-parity" class="headerlink" title="RAID level 6 – Striping with double parity"></a>RAID level 6 – Striping with double parity</h3><p><a target="_blank" rel="noopener" href="http://www.prepressure.com/images/raid-level-6-striping-with-dual-parity.svg"><img src="http://www.prepressure.com/images/raid-level-6-striping-with-dual-parity.svg" alt="image"></a><br>RAID6改进了RAID5，使用了两块奇偶校验盘，<br>RAID6的创建过程和RAID5相似.</p>
<h3 id="RAID-level-10-–-combining-RAID-1-RAID-0"><a href="#RAID-level-10-–-combining-RAID-1-RAID-0" class="headerlink" title="RAID level 10 – combining RAID 1 &amp; RAID 0"></a>RAID level 10 – combining RAID 1 &amp; RAID 0</h3><p>RAID10可以看做是RAID1和RAID0的结合。<br><a target="_blank" rel="noopener" href="http://www.prepressure.com/images/raid-level-1-and-0-striping-mirroring.svg"><img src="http://www.prepressure.com/images/raid-level-1-and-0-striping-mirroring.svg" alt="image"></a></p>
<p>RAID10的优点在于恢复数据速度很快，但相比与RAID5和6，使用设备的代价更大。</p>
<h4 id="mdadm-3"><a href="#mdadm-3" class="headerlink" title="mdadm"></a>mdadm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$mdadm --create --verbose /dev/md1 --level=10 --raid-devices=4 /dev/loop4 /dev/loop5 /dev/loop6 /dev/loop7</span><br><span class="line">mdadm: layout defaults to n2</span><br><span class="line">mdadm: layout defaults to n2</span><br><span class="line">mdadm: chunk size defaults to 512K</span><br><span class="line">mdadm: size set to 2046976K</span><br><span class="line">mdadm: Defaulting to version 1.2 metadata</span><br><span class="line">mdadm: array /dev/md1 started.</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$mdadm --detail /dev/md1</span><br><span class="line">/dev/md1:</span><br><span class="line">        Version : 1.2</span><br><span class="line">  Creation Time : Tue Mar  7 17:44:43 2017</span><br><span class="line">     Raid Level : raid10</span><br><span class="line">     Array Size : 4093952 (3.90 GiB 4.19 GB)</span><br><span class="line">  Used Dev Size : 2046976 (1999.34 MiB 2096.10 MB)</span><br><span class="line">   Raid Devices : 4</span><br><span class="line">  Total Devices : 4</span><br><span class="line">    Persistence : Superblock is persistent</span><br><span class="line"></span><br><span class="line">    Update Time : Tue Mar  7 17:45:04 2017</span><br><span class="line">          State : clean </span><br><span class="line"> Active Devices : 4</span><br><span class="line">Working Devices : 4</span><br><span class="line"> Failed Devices : 0</span><br><span class="line">  Spare Devices : 0</span><br><span class="line"></span><br><span class="line">         Layout : near=2</span><br><span class="line">     Chunk Size : 512K</span><br><span class="line"></span><br><span class="line">           Name : st-integrat-node00:1  (local to host st-integrat-node00)</span><br><span class="line">           UUID : 643b371a:eeadc82d:7d4effee:cf00411c</span><br><span class="line">         Events : 17</span><br><span class="line"></span><br><span class="line">    Number   Major   Minor   RaidDevice State</span><br><span class="line">       0       7        4        0      active sync set-A   /dev/loop4</span><br><span class="line">       1       7        5        1      active sync set-B   /dev/loop5</span><br><span class="line">       2       7        6        2      active sync set-A   /dev/loop6</span><br><span class="line">       3       7        7        3      active sync set-B   /dev/loop7</span><br></pre></td></tr></table></figure>



<h4 id="device-mapper-1"><a href="#device-mapper-1" class="headerlink" title="device-mapper"></a>device-mapper</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建4个drive的RAID10，一半做镜像，所以大小为2倍drive sector大小。</span><br><span class="line">$dmsetup create test-raid10 --table &#x27;0 8192000 raid raid10 3 64 region_size 1024 4 - /dev/loop4 - /dev/loop5 - /dev/loop6 - /dev/loop7&#x27;</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$dmsetup status test-raid10</span><br><span class="line">0 8192000 raid raid10 4 AAAA 8192000/8192000 idle 0</span><br></pre></td></tr></table></figure>



<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li>[1] RAID, <a target="_blank" rel="noopener" href="https://www.prepressure.com/library/technology/raid/">https://www.prepressure.com/library/technology/raid/</a></li>
<li>[2] Device-mapper, <a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Device-mapper">https://wiki.gentoo.org/wiki/Device-mapper</a></li>
<li>[3] RAID-Setup, <a target="_blank" rel="noopener" href="https://raid.wiki.kernel.org/index.php/RAID_setup">https://raid.wiki.kernel.org/index.php/RAID_setup</a></li>
<li>[4] dm-raid, <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/device-mapper/dm-raid.txt">https://www.kernel.org/doc/Documentation/device-mapper/dm-raid.txt</a></li>
<li>[5] How To Create RAID Arrays with mdadm on Ubuntu 16.04, <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-create-raid-arrays-with-mdadm-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-create-raid-arrays-with-mdadm-on-ubuntu-16-04</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-kmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-kmp/" class="post-title-link" itemprop="url">kmp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>KMP算法用于做字符串匹配, 是计算机中经常用到的算法. 大多数都文章比较难懂, 这里参考了<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2013/05/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm.html">阮一封</a>的博客文章, 比较通俗易懂, 但是没有详细解释Next表怎么具体算出来, 只是给出了概念的解释. 这里给出更完整的算法实现和解释.</p>
<h4 id="基本思想"><a href="#基本思想" class="headerlink" title="基本思想"></a>基本思想</h4><p>KMP的基本思想非常简单, 举例来说, 现在判断字符串”ABCDABD”是否在字符串”BBC ABCDAB ABCDABCDABDE”中.</p>
<ol>
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050103.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050103.png" alt="img"></a></p>
<p>首先，字符串”BBC ABCDAB ABCDABCDABDE”的第一个字符与搜索词”ABCDABD”的第一个字符，进行比较。因为B与A不匹配，所以搜索词后移一位。</p>
<ol start="2">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050104.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050104.png" alt="img"></a></p>
<p>因为B与A不匹配，搜索词再往后移。</p>
<ol start="3">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050105.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050105.png" alt="img"></a></p>
<p>就这样，直到字符串有一个字符，与搜索词的第一个字符相同为止。</p>
<ol start="4">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050106.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050106.png" alt="img"></a></p>
<p>接着比较字符串和搜索词的下一个字符，还是相同。</p>
<ol start="5">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png" alt="img"></a></p>
<p>直到字符串有一个字符，与搜索词对应的字符不相同为止。</p>
<ol start="6">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050108.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050108.png" alt="img"></a></p>
<p>这时，最自然的反应是，将搜索词整个后移一位，再从头逐个比较。这样做虽然可行，但是效率很差，因为你要把”搜索位置”移到已经比较过的位置，重比一遍。</p>
<ol start="7">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png" alt="img"></a></p>
<p>一个基本事实是，当空格与D不匹配时，你其实知道前面六个字符是”ABCDAB”。KMP算法的想法是，设法利用这个已知信息，不要把”搜索位置”移回已经比较过的位置，继续把它向后移，这样就提高了效率。</p>
<ol start="8">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050109.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050109.png" alt="img"></a></p>
<p>怎么做到这一点呢？可以针对搜索词，算出一张《部分匹配表》（Partial Match Table）。这张表是如何产生的，后面再介绍，这里只要会用就可以了。</p>
<ol start="9">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050107.png" alt="img"></a></p>
<p>已知空格与D不匹配时，前面六个字符”ABCDAB”是匹配的。查表可知，最后一个匹配字符B对应的”部分匹配值”为2，因此按照下面的公式算出向后移动的位数：</p>
<blockquote>
<p>　　移动位数 &#x3D; 已匹配的字符数 - 对应的部分匹配值</p>
</blockquote>
<p>因为 6 - 2 等于4，所以将搜索词向后移动4位。</p>
<ol start="10">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050110.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050110.png" alt="img"></a></p>
<p>因为空格与Ｃ不匹配，搜索词还要继续往后移。这时，已匹配的字符数为2（”AB”），对应的”部分匹配值”为0。所以，移动位数 &#x3D; 2 - 0，结果为 2，于是将搜索词向后移2位。</p>
<ol start="11">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050111.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050111.png" alt="img"></a></p>
<p>因为空格与A不匹配，继续后移一位。</p>
<ol start="12">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050112.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050112.png" alt="img"></a></p>
<p>逐位比较，直到发现C与D不匹配。于是，移动位数 &#x3D; 6 - 2，继续将搜索词向后移动4位。</p>
<ol start="13">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050113.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050113.png" alt="img"></a></p>
<p>逐位比较，直到搜索词的最后一位，发现完全匹配，于是搜索完成。如果还要继续搜索（即找出全部匹配），移动位数 &#x3D; 7 - 0，再将搜索词向后移动7位，这里就不再重复了。</p>
<ol start="14">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050114.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050114.png" alt="img"></a></p>
<p>下面介绍《部分匹配表》是如何产生的。</p>
<p>首先，要了解两个概念：”前缀”和”后缀”。 “前缀”指除了最后一个字符以外，一个字符串的全部头部组合；”后缀”指除了第一个字符以外，一个字符串的全部尾部组合。</p>
<ol start="15">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050109.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050109.png" alt="img"></a></p>
<p>“部分匹配值”就是”前缀”和”后缀”的最长的共有元素的长度。以”ABCDABD”为例，</p>
<blockquote>
<p>　　－　“A”的前缀和后缀都为空集，共有元素的长度为0；</p>
<p>　　－　“AB”的前缀为[A]，后缀为[B]，共有元素的长度为0；</p>
<p>　　－　“ABC”的前缀为[A, AB]，后缀为[BC, C]，共有元素的长度0；</p>
<p>　　－　“ABCD”的前缀为[A, AB, ABC]，后缀为[BCD, CD, D]，共有元素的长度为0；</p>
<p>　　－　“ABCDA”的前缀为[A, AB, ABC, ABCD]，后缀为[BCDA, CDA, DA, A]，共有元素为”A”，长度为1；</p>
<p>　　－　“ABCDAB”的前缀为[A, AB, ABC, ABCD, ABCDA]，后缀为[BCDAB, CDAB, DAB, AB, B]，共有元素为”AB”，长度为2；</p>
<p>　　－　“ABCDABD”的前缀为[A, AB, ABC, ABCD, ABCDA, ABCDAB]，后缀为[BCDABD, CDABD, DABD, ABD, BD, D]，共有元素的长度为0。</p>
</blockquote>
<ol start="16">
<li></li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050112.png"><img src="http://www.ruanyifeng.com/blogimg/asset/201305/bg2013050112.png" alt="img"></a></p>
<p>“部分匹配”的实质是，有时候，字符串头部和尾部会有重复。比如，”ABCDAB”之中有两个”AB”，那么它的”部分匹配值”就是2（”AB”的长度）。搜索词移动的时候，第一个”AB”向后移动4位（字符串长度-部分匹配值），就可以来到第二个”AB”的位置。</p>
<p>####算法实现</p>
<p>从上述思想来看, KMP的核心在于计算Next(部分匹配表)表, 其他的就是按照一个公式去移动而已. 我们来看看这个表用算法如何构造. 从15我们知道, Next就是”部分匹配值”就是”前缀”和”后缀”的最长的共有元素的长度.</p>
<p>我们先用最直观的做法来写这段代码, 然后再来优化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func Next(str string) []int &#123;</span><br><span class="line">    length := len(str)</span><br><span class="line">    next := make([]int, length) // next数组</span><br><span class="line">    for q := 1; q &lt; length; q++ &#123;</span><br><span class="line">        m := 0</span><br><span class="line">        for k := 0; k &lt; q; k++ &#123;</span><br><span class="line">            if str[:k+1] == str[q-k:q+1] &amp;&amp; k+1 &gt; m&#123; //如果前缀等于后缀, 并且长度是最长的, 就替换m</span><br><span class="line">                m = k+1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        next[q] = m // m是写入next数组, 循环q</span><br><span class="line">    &#125;</span><br><span class="line">    return next</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码将next数组计算出来, 符合正常的code思路, 但是复杂度是O(n^2), 显然不符合KMP的思想. 我们来做一些优化. 首先, 按照next的特性, 每次不需要回溯到0, 而是充分利用next特性回溯到已经匹配的字串, 如果不中再去找上一个, 算法见:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func Next(str string) []int &#123;</span><br><span class="line">    length := len(str)</span><br><span class="line">    next := make([]int, length)</span><br><span class="line">    next[0] = 0 // 初始化为0, 表示没有</span><br><span class="line">    for q := 1; q &lt; length; q++ &#123;</span><br><span class="line">        k := next[q - 1] // 只需要退回到前一个的next[q-1]位置, 而不用回到0</span><br><span class="line">        for k &gt; 0 &amp;&amp; str[k] != str[q] &#123; // 如果后一个位置不相等, 再往前回溯</span><br><span class="line">            k = next[k] // 为什么这里不直接跳回到0呢, 因为next[k]表示前面已经匹配的, 而不需要退到起点, 先从最大长度往前回溯</span><br><span class="line">        &#125;</span><br><span class="line">        if str[k] == str[q] &#123;</span><br><span class="line">            // 如果下一个字符相等, 将将k + 1, 由于前面的字串肯定是相等的, 不需要在比较</span><br><span class="line">            next[q] = k + 1</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            next[q] = 0 // 如果不相等</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return next</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改进后的算法时间复杂度为O(2n)</p>
<p>这种写法看起来不是很美观, 但是可读性更强, 有点写法会将初始值为-1, 然后将k :&#x3D; next[q - 1] 和 k &#x3D; next[k]合在一起, 把 next[q] &#x3D; k + 1和 next[q] &#x3D; 0也合在一起, 这种”炫技” 行为我个人是非常不喜欢的, 看起来简洁但是将算法思想隐藏了, 可理解性很差. 同样我也不喜欢用任何lamda写法, 除非语言层面对此有性能优化, 否则只是用来恶心看代码的人.</p>
<p>按照这个思想写KMP的算法就非常简单了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func kmp(str1, str2 string) bool &#123;</span><br><span class="line">    next := Next(str2)</span><br><span class="line">    i := 0 // i 是str1的index</span><br><span class="line">    j := 0 // j 是str2的index</span><br><span class="line">    length := len(str1)</span><br><span class="line">    for i &lt; length &#123;</span><br><span class="line">        if str1[i+j] == str2[j] &#123;</span><br><span class="line">            j++</span><br><span class="line">            if j == len(str2) &#123;</span><br><span class="line">                // 完全匹配</span><br><span class="line">                return true</span><br><span class="line">            &#125;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if j == 0 &#123; // j==0 字节i++ 跳过</span><br><span class="line">            i++</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            i = i + j - next[j-1]//移动位数 = 已匹配的字符数 - 对应的部分匹配值</span><br><span class="line">            j = next[j - 1] // j回溯到记录位置</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>KMP算法的复杂度为O(M+N), 其他写法会更简洁, 但是同样为了可读性, 情愿写的罗嗦一点.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    str1 := &quot;BBC ABCDAB ABCDABCDABDE&quot;</span><br><span class="line">    str := &quot;ABCDABD&quot;</span><br><span class="line">    fmt.Println(kmp(str1, str))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>带上术例子进行计算, 总共循环次数为15次, 其中计算next数组总共只计算了7次.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-lvconvert-down/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-lvconvert-down/" class="post-title-link" itemprop="url">lvconvert-down</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system/" itemprop="url" rel="index"><span itemprop="name">system</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>记录一个kernel bug.</p>
<p>在组建中调用了lvconvert生成存储池, 但是测试告诉我过程失败并且机器重启了, 通过抓kdump生成以下日志:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[  983.179047] BUG kmalloc-256(4:099fef32f6df55082271a9ab572acec8251aa754a14a60444d7ce4cb110be56f) (Tainted: G    B          ------------ T): Objects remaining in kmalloc-256(4:099fef32f6df55082271a9ab572acec8251aa754a14a60444d7ce4cb110be56f</span><br><span class="line">[  983.179890] -----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[  983.180762] INFO: Slab 0xffffea000cae8840 objects=16 used=9 fp=0xffff88032ba21b00 flags=0x2fffff00000080</span><br><span class="line">[  983.181181] CPU: 3 PID: 25070 Comm: lvconvert Tainted: G    B          ------------ T 3.10.0-327.el7.x86_64 #1</span><br><span class="line">[  983.181182] Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011</span><br><span class="line">[  983.181183]  ffffea000cae8840 00000000c255adbf ffff88018d43baa8 ffffffff816351f1</span><br><span class="line">[  983.181186]  ffff88018d43bb80 ffffffff811beac4 0000000000000020 ffff88018d43bb90</span><br><span class="line">[  983.181188]  ffff88018d43bb40 656a624f00000000 616d657220737463 6e6920676e696e69</span><br><span class="line">[  983.181190] Call Trace:</span><br><span class="line">[  983.181195]  [&lt;ffffffff816351f1&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[  983.181203]  [&lt;ffffffff811beac4&gt;] slab_err+0xb4/0xe0</span><br><span class="line">[  983.181206]  [&lt;ffffffff811c1f33&gt;] ? __kmalloc+0x1f3/0x230</span><br><span class="line">[  983.181208]  [&lt;ffffffff811c316b&gt;] ? kmem_cache_close+0x12b/0x2f0</span><br><span class="line">[  983.181210]  [&lt;ffffffff811c318c&gt;] kmem_cache_close+0x14c/0x2f0</span><br><span class="line">[  983.181212]  [&lt;ffffffff811c35c4&gt;] __kmem_cache_shutdown+0x14/0x80</span><br><span class="line">[  983.181215]  [&lt;ffffffff8118ceaf&gt;] kmem_cache_destroy+0x3f/0xe0</span><br><span class="line">[  983.181217]  [&lt;ffffffff811d4949&gt;] kmem_cache_destroy_memcg_children+0x89/0xb0</span><br><span class="line">[  983.181221]  [&lt;ffffffff8118ce84&gt;] kmem_cache_destroy+0x14/0xe0</span><br><span class="line">[  983.181231]  [&lt;ffffffff8121705e&gt;] bioset_free+0xce/0x110</span><br><span class="line">[  983.181250]  [&lt;ffffffffa0002fa0&gt;] __dm_destroy+0x1b0/0x340 [dm_mod]</span><br><span class="line">[  983.181257]  [&lt;ffffffffa00047e3&gt;] dm_destroy+0x13/0x20 [dm_mod]</span><br><span class="line">[  983.181263]  [&lt;ffffffffa000a34e&gt;] dev_remove+0x11e/0x180 [dm_mod]</span><br><span class="line">[  983.181268]  [&lt;ffffffffa000a230&gt;] ? dev_suspend+0x250/0x250 [dm_mod]</span><br><span class="line">[  983.181274]  [&lt;ffffffffa000aa25&gt;] ctl_ioctl+0x255/0x500 [dm_mod]</span><br><span class="line">[  983.181278]  [&lt;ffffffff81271b94&gt;] ? SYSC_semtimedop+0x264/0xd10</span><br><span class="line">[  983.181287]  [&lt;ffffffffa000ace3&gt;] dm_ctl_ioctl+0x13/0x20 [dm_mod]</span><br><span class="line">[  983.181289]  [&lt;ffffffff811f1ef5&gt;] do_vfs_ioctl+0x2e5/0x4c0</span><br><span class="line">[  983.181292]  [&lt;ffffffff811e05ee&gt;] ? ____fput+0xe/0x10</span><br><span class="line">[  983.181294]  [&lt;ffffffff811f2171&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[  983.181298]  [&lt;ffffffff81645909&gt;] system_call_fastpath+0x16/0x1b</span><br></pre></td></tr></table></figure>

<p>看起来是lvconvert过程中缓存分配出现错误, 查到这一步基本无从下手了, 只能google搜索. 在docker项目中发现有相似的情况<a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/29879">https://github.com/moby/moby/issues/29879</a>, 出问题的三个网址都是3.10的kernel, 回到说是kernel问题, 升到4.16.7-1.el7.elrepo.x86_64没有问题.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-docker-start-failed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-docker-start-failed/" class="post-title-link" itemprop="url">docker-start-failed</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>make build过程中忽然出现错误:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Sending build context to Docker daemon   220 MB</span><br><span class="line">Step 1 : FROM warpdrive:tos-release-1-5</span><br><span class="line"> ---&gt; 769306738d96</span><br><span class="line">Step 2 : COPY . /go/src/github.com/transwarp/warpdrive/</span><br><span class="line"> ---&gt; 07c99697b16e</span><br><span class="line">Removing intermediate container 127c0e71a84b</span><br><span class="line">Successfully built 07c99697b16e</span><br><span class="line">/usr/bin/docker: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux.go:245: running exec setns process for init caused \\\&quot;exit status 6\\\&quot;\&quot;\n&quot;.</span><br><span class="line">FATA[0301] exit status 125                              </span><br><span class="line">make: *** [build] Error 1</span><br></pre></td></tr></table></figure>

<p>尝试run 07c99697b16e报同样的错, 查看docker日志, 出现<code>&quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux .go:245: running exec setns process for init caused \\\&quot;exit status 6\\\&quot;\&quot;\n&quot;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">8月 21 15:29:01 zhenghc-tos dockerd[2517]: time=&quot;2018-08-21T15:29:01.778212288+08:00&quot; level=error msg=&quot;Handler for POST /v1.24/containers/79a0906242e0180dfd7aeff30e9fb179f7b7c37f0ba20533f83b4cd40b409d2a/start returned error: invali</span><br><span class="line">d header field value \&quot;oci runtime error: container_linux.go:247: starting container process caused \\\&quot;process_linux.go:245: running exec setns process for init caused \\\\\\\&quot;exit status 6\\\\\\\&quot;\\\&quot;\\n\&quot;&quot;</span><br><span class="line">8月 21 15:51:08 zhenghc-tos dockerd[2517]: time=&quot;2018-08-21T15:51:08.075631868+08:00&quot; level=error msg=&quot;containerd: start container&quot; error=&quot;oci runtime error: container_linux.go:247: starting container process caused \&quot;process_linux</span><br><span class="line">.go:245: running exec setns process for init caused \\\&quot;exit status 6\\\&quot;\&quot;\n&quot; id=b93539a02f27cc1ad0114552643d8e0c942fba053dc8cd3980cb8f24cf61ff25</span><br><span class="line">8月 21 15:51:08 zhenghc-tos dockerd[2517]: time=&quot;2018-08-21T15:51:08.092002257+08:00&quot; level=error msg=&quot;Create container failed with error: invalid header field value \&quot;oci runtime error: container_linux.go:247: starting container p</span><br><span class="line">rocess caused \\\&quot;process_linux.go:245: running exec setns process for init caused \\\\\\\&quot;exit status 6\\\\\\\&quot;\\\&quot;\\n\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>发现Docker比较卡, 于是清理了大量的images, 删掉了所有未运行的container, 再清理了系统缓存, 问题解决了, 但深层次的问题没弄清楚, 尽管清了缓存, 但是清完其实缓存差距不大, docker 也没有显示资源问题, 另外一个点就是, 只有这个image是进不去的, 其他的Images是可以run -it的, 而且在做<code>COPY . /go/src/github.com/transwarp/warpdrive/</code>这一步时间等的比较长.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc/issues/1130">https://github.com/opencontainers/runc/issues/1130</a> 记录了相关的问题, 说runc的问题.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-k8s-cgroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-k8s-cgroup/" class="post-title-link" itemprop="url">k8s-cgroup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>问题:</p>
<ol>
<li>k8s中cpu的request和limit中设置”0.5”和”100m”表示什么意思?</li>
<li>一个4核8线程的cpu, 设置cpu为”1”的limit实际的限制多少?</li>
<li>cpu中request和limit使用上有什么区别?</li>
<li>cgroup中是如何限制的?</li>
</ol>
<h4 id="Linux-Cgroup"><a href="#Linux-Cgroup" class="headerlink" title="Linux Cgroup"></a>Linux Cgroup</h4><p>众所周知, kubernetes和docker中对cpu, memory进行了使用限制, 用于内存和cpu的资源使用隔离. 而底层使用的是linux cgroup技术. 内存比较简单, 本文主要讲cpu的cgroup.</p>
<p>在cgroup里面，跟CPU相关的子系统有<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v1/cpusets.txt">cpusets</a>、<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v1/cpuacct.txt">cpuacct</a>和<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt">cpu</a>。</p>
<p>其中cpuset主要用于设置CPU的亲和性，可以限制cgroup中的进程只能在指定的CPU上运行，或者不能在指定的CPU上运行，同时cpuset还能设置内存的亲和性。设置亲和性一般只在比较特殊的情况才用得着，所以这里不做介绍。</p>
<p>cpuacct包含当前cgroup所使用的CPU的统计信息，信息量较少，有兴趣可以去看看它的文档，这里不做介绍。</p>
<p>本篇只介绍<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu#sect-cfs">cpu子系统</a>，包括怎么限制cgroup的CPU使用上限及相对于其它cgroup的相对值。</p>
<h5 id="创建子cgroup"><a href="#创建子cgroup" class="headerlink" title="创建子cgroup"></a>创建子cgroup</h5><p>在ubuntu下，systemd已经帮我们mount好了cpu子系统，我们只需要在相应的目录下创建子目录就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#从这里的输出可以看到，cpuset被挂载在了/sys/fs/cgroup/cpuset，</span><br><span class="line">#而cpu和cpuacct一起挂载到了/sys/fs/cgroup/cpu,cpuacct下面</span><br><span class="line">dev@ubuntu:~$ mount|grep cpu</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line"></span><br><span class="line">#进入/sys/fs/cgroup/cpu,cpuacct并创建子cgroup</span><br><span class="line">dev@ubuntu:~$ cd /sys/fs/cgroup/cpu,cpuacct</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct$ sudo mkdir test</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct$ cd test</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ ls</span><br><span class="line">cgroup.clone_children  cpuacct.stat   cpuacct.usage_percpu  cpu.cfs_quota_us  cpu.stat           tasks</span><br><span class="line">cgroup.procs           cpuacct.usage  cpu.cfs_period_us     cpu.shares        notify_on_release</span><br></pre></td></tr></table></figure>

<p>我们只需要关注cpu.开头的文件</p>
<h5 id="cpu-subsystem"><a href="#cpu-subsystem" class="headerlink" title="cpu subsystem"></a>cpu subsystem</h5><p>cpu子系统调度cpu到cgroups中, 目前有两种调度策略:</p>
<ul>
<li><em>Completely Fair Scheduler (CFS)</em> —-将cpu时间划分成合适的份额, 按比例和权重分配给cgroup.cfs可以设置相对权重和绝对权重, 目前k8s用的是这个调度策略.</li>
<li><em>Real-Time scheduler (RT)</em> —RT调度器与CFS中的绝对权重控制相似, 不过仅用于实时任务. 可以在运行时进行实时调整参数.</li>
</ul>
<ol>
<li>Completely Fair Scheduler (CFS):</li>
</ol>
<ul>
<li><p>强制绝对控制参数:</p>
<p>cpu.cfs_period_us &amp; cpu.cfs_quota_us</p>
</li>
</ul>
<p> cfs_period_us用来配置时间周期长度，cfs_quota_us用来配置当前cgroup在设置的周期长度内所能使用的CPU时间数，两个文件配合起来设置CPU的使用上限。两个文件的单位都是微秒（us），cfs_period_us的取值范围为1毫秒（ms）到1秒（s），cfs_quota_us的取值大于1ms即可，如果cfs_quota_us的值为-1（默认值），表示不受cpu时间的限制。下面是几个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.限制只能使用1个CPU（每250ms能使用250ms的CPU时间）</span><br><span class="line">    # echo 250000 &gt; cpu.cfs_quota_us /* quota = 250ms */</span><br><span class="line">    # echo 250000 &gt; cpu.cfs_period_us /* period = 250ms */</span><br><span class="line"></span><br><span class="line">2.限制使用2个CPU（内核）（每500ms能使用1000ms的CPU时间，即使用两个内核）</span><br><span class="line">    # echo 1000000 &gt; cpu.cfs_quota_us /* quota = 1000ms */</span><br><span class="line">    # echo 500000 &gt; cpu.cfs_period_us /* period = 500ms */</span><br><span class="line"></span><br><span class="line">3.限制使用1个CPU的20%（每50ms能使用10ms的CPU时间，即使用一个CPU核心的20%）</span><br><span class="line">    # echo 10000 &gt; cpu.cfs_quota_us /* quota = 10ms */</span><br><span class="line">    # echo 50000 &gt; cpu.cfs_period_us /* period = 50ms */</span><br></pre></td></tr></table></figure>

<p> cpu.stat:</p>
<p>包含了下面三项统计结果</p>
<ul>
<li>nr_periods： 表示过去了多少个cpu.cfs_period_us里面配置的时间周期</li>
<li>nr_throttled： 在上面的这些周期中，有多少次是受到了限制（即cgroup中的进程在指定的时间周期中用光了它的配额）</li>
<li>throttled_time: cgroup中的进程被限制使用CPU持续了多长时间(纳秒)</li>
<li>相对控制参数: cpu.shares</li>
</ul>
<p>shares用来设置CPU的相对值，并且是针对所有的CPU（内核），默认值是1024，假如系统中有两个cgroup，分别是A和B，A的shares值是1024，B的shares值是512，那么A将获得1024&#x2F;(1204+512)&#x3D;66%的CPU资源，而B将获得33%的CPU资源。shares有两个特点：</p>
<ul>
<li>如果A不忙，没有使用到66%的CPU时间，那么剩余的CPU时间将会被系统分配给B，即B的CPU使用率可以超过33%</li>
<li>如果添加了一个新的cgroup C，且它的shares值是1024，那么A的限额变成了1024&#x2F;(1204+512+1024)&#x3D;40%，B的变成了20%</li>
</ul>
<p>从上面两个特点可以看出：</p>
<ul>
<li>在闲的时候，shares基本上不起作用，只有在CPU忙的时候起作用，这是一个优点。</li>
<li>由于shares是一个绝对值，需要和其它cgroup的值进行比较才能得到自己的相对限额，而在一个部署很多容器的机器上，cgroup的数量是变化的，所以这个限额也是变化的，自己设置了一个高的值，但别人可能设置了一个更高的值，所以这个功能没法精确的控制CPU使用率。</li>
</ul>
<ol start="2">
<li>Real-Time scheduler (RT):</li>
</ol>
<p>cpu.rt_period_us: 周期时间, us, 同cfs</p>
<p>cpu.rt_runtime_us: 最长持续周期, us. 例如设置rt_runtime_us &#x3D; 200000, rt_period_us &#x3D; 1000000, 这就是说如果node有2cpu, 那么每秒钟占用时间就是2*0.2 &#x3D; 0.4s. 这个也是绝对时间.</p>
<h5 id="运行事例"><a href="#运行事例" class="headerlink" title="运行事例:"></a>运行事例:</h5><p>以cfs为例.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#继续使用上面创建的子cgroup： test</span><br><span class="line">#设置只能使用1个cpu的20%的时间</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 50000 &gt; cpu.cfs_period_us&quot;</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 10000 &gt; cpu.cfs_quota_us&quot;</span><br><span class="line"></span><br><span class="line">#将当前bash加入到该cgroup</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ echo $$</span><br><span class="line">5456</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 5456 &gt; cgroup.procs&quot;</span><br><span class="line"></span><br><span class="line">#在bash中启动一个死循环来消耗cpu，正常情况下应该使用100%的cpu（即消耗一个内核）</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ while :; do echo test &gt; /dev/null; done</span><br><span class="line"></span><br><span class="line">#--------------------------重新打开一个shell窗口----------------------</span><br><span class="line">#通过top命令可以看到5456的CPU使用率为20%左右，说明被限制住了</span><br><span class="line">#不过这时系统的%us+%sy在10%左右，那是因为我测试的机器上cpu是双核的，</span><br><span class="line">#所以系统整体的cpu使用率为10%左右</span><br><span class="line">dev@ubuntu:~$ top</span><br><span class="line">Tasks: 139 total,   2 running, 137 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  5.6 us,  6.2 sy,  0.0 ni, 88.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :   499984 total,    15472 free,    81488 used,   403024 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.   383332 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 5456 dev       20   0   22640   5472   3524 R  20.3  1.1   0:04.62 bash</span><br><span class="line"></span><br><span class="line">#这时可以看到被限制的统计结果</span><br><span class="line">dev@ubuntu:~$ cat /sys/fs/cgroup/cpu,cpuacct/test/cpu.stat</span><br><span class="line">nr_periods 1436</span><br><span class="line">nr_throttled 1304</span><br><span class="line">throttled_time 51542291833</span><br></pre></td></tr></table></figure>

<h4 id="kubernetes-资源控制机制"><a href="#kubernetes-资源控制机制" class="headerlink" title="kubernetes 资源控制机制"></a>kubernetes 资源控制机制</h4><p>kubernetes使用runc作为runtime, runc中通过cpuGroup对cpu子系统的的调度进行设置. 其中Set()用于初始设置, Apply()方法用于动态更改设置, . 原理就是往上述的指定文件写入相应条目和数字. 没有什么可说的.</p>
<p>内存的Set():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">func (s *MemoryGroup) Set(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">	if err := setMemoryAndSwap(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.KernelMemory != 0 &#123;</span><br><span class="line">		if err := setKernelMemory(path, cgroup.Resources.KernelMemory); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.MemoryReservation != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.soft_limit_in_bytes&quot;, strconv.FormatInt(cgroup.Resources.MemoryReservation, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.KernelMemoryTCP != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.kmem.tcp.limit_in_bytes&quot;, strconv.FormatInt(cgroup.Resources.KernelMemoryTCP, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.OomKillDisable &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.oom_control&quot;, &quot;1&quot;); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.MemorySwappiness == nil || int64(*cgroup.Resources.MemorySwappiness) == -1 &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125; else if *cgroup.Resources.MemorySwappiness &lt;= 100 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.swappiness&quot;, strconv.FormatUint(*cgroup.Resources.MemorySwappiness, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		return fmt.Errorf(&quot;invalid value:%d. valid memory swappiness range is 0-100&quot;, *cgroup.Resources.MemorySwappiness)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内存Apply():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (s *MemoryGroup) Apply(d *cgroupData) (err error) &#123;</span><br><span class="line">	path, err := d.path(&quot;memory&quot;)</span><br><span class="line">	if err != nil &amp;&amp; !cgroups.IsNotFound(err) &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125; else if path == &quot;&quot; &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	if memoryAssigned(d.config) &#123;</span><br><span class="line">		if _, err := os.Stat(path); os.IsNotExist(err) &#123;</span><br><span class="line">			if err := os.MkdirAll(path, 0755); err != nil &#123;</span><br><span class="line">				return err</span><br><span class="line">			&#125;</span><br><span class="line">			// 只有内核内存可以动态设置</span><br><span class="line">			if err := EnableKernelMemoryAccounting(path); err != nil &#123;</span><br><span class="line">				return err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func EnableKernelMemoryAccounting(path string) error &#123;</span><br><span class="line">	// Check if kernel memory is enabled</span><br><span class="line">	// We have to limit the kernel memory here as it won&#x27;t be accounted at all</span><br><span class="line">	// until a limit is set on the cgroup and limit cannot be set once the</span><br><span class="line">	// cgroup has children, or if there are already tasks in the cgroup.</span><br><span class="line">	for _, i := range []int64&#123;1, -1&#125; &#123;</span><br><span class="line">		if err := setKernelMemory(path, i); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpu的Set():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func (s *CpuGroup) Set(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">    // 设置CFS </span><br><span class="line">	if cgroup.Resources.CpuShares != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.shares&quot;, strconv.FormatUint(cgroup.Resources.CpuShares, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuPeriod != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.cfs_period_us&quot;, strconv.FormatUint(cgroup.Resources.CpuPeriod, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuQuota != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.cfs_quota_us&quot;, strconv.FormatInt(cgroup.Resources.CpuQuota, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	// 设置RT</span><br><span class="line">	if err := s.SetRtSched(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *CpuGroup) SetRtSched(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">	if cgroup.Resources.CpuRtPeriod != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.rt_period_us&quot;, strconv.FormatUint(cgroup.Resources.CpuRtPeriod, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuRtRuntime != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.rt_runtime_us&quot;, strconv.FormatInt(cgroup.Resources.CpuRtRuntime, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpu的Apply() 只能设置RT:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (s *CpuGroup) Apply(d *cgroupData) error &#123;</span><br><span class="line">	// We always want to join the cpu group, to allow fair cpu scheduling</span><br><span class="line">	// on a container basis</span><br><span class="line">	path, err := d.path(&quot;cpu&quot;)</span><br><span class="line">	if err != nil &amp;&amp; !cgroups.IsNotFound(err) &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	return s.ApplyDir(path, d.config, d.pid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *CpuGroup) ApplyDir(path string, cgroup *configs.Cgroup, pid int) error &#123;</span><br><span class="line">	// This might happen if we have no cpu cgroup mounted.</span><br><span class="line">	// Just do nothing and don&#x27;t fail.</span><br><span class="line">	if path == &quot;&quot; &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	if err := os.MkdirAll(path, 0755); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	// We should set the real-Time group scheduling settings before moving</span><br><span class="line">	// in the process because if the process is already in SCHED_RR mode</span><br><span class="line">	// and no RT bandwidth is set, adding it will fail.</span><br><span class="line">	if err := s.SetRtSched(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	// because we are not using d.join we need to place the pid into the procs file</span><br><span class="line">	// unlike the other subsystems</span><br><span class="line">	if err := cgroups.WriteCgroupProc(path, pid); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="K8s-Limits-Request-代码分析"><a href="#K8s-Limits-Request-代码分析" class="headerlink" title="K8s Limits &amp; Request 代码分析"></a>K8s Limits &amp; Request 代码分析</h5><p>k8s中管理cgroup的结构体在k8s.io&#x2F;kubernetes&#x2F;pkg&#x2F;kubelet&#x2F;cm&#x2F;cgroup_manager_linux.go中:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// cgroupManagerImpl implements the CgroupManager interface.</span><br><span class="line">// Its a stateless object which can be used to</span><br><span class="line">// update,create or delete any number of cgroups</span><br><span class="line">// It uses the Libcontainer raw fs cgroup manager for cgroup management.</span><br><span class="line">type cgroupManagerImpl struct &#123;</span><br><span class="line">	// subsystems holds information about all the</span><br><span class="line">	// mounted cgroup subsystems on the node</span><br><span class="line">	subsystems *CgroupSubsystems</span><br><span class="line">	// simplifies interaction with libcontainer and its cgroup managers</span><br><span class="line">	adapter *libcontainerAdapter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看下Update方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// Update updates the cgroup with the specified Cgroup Configuration</span><br><span class="line">func (m *cgroupManagerImpl) Update(cgroupConfig *CgroupConfig) error &#123;</span><br><span class="line">	...</span><br><span class="line">	// 提取cgroup资源参数</span><br><span class="line">	resourceConfig := cgroupConfig.ResourceParameters</span><br><span class="line">	resources := m.toResources(resourceConfig)</span><br><span class="line"></span><br><span class="line">	cgroupPaths := m.buildCgroupPaths(cgroupConfig.Name)</span><br><span class="line"></span><br><span class="line">	// 获得cgroupfs的位置.</span><br><span class="line">	abstractCgroupFsName := string(cgroupConfig.Name)</span><br><span class="line">	abstractParent := CgroupName(path.Dir(abstractCgroupFsName))</span><br><span class="line">	abstractName := CgroupName(path.Base(abstractCgroupFsName))</span><br><span class="line"></span><br><span class="line">	driverParent := m.adapter.adaptName(abstractParent, false)</span><br><span class="line">	driverName := m.adapter.adaptName(abstractName, false)</span><br><span class="line"></span><br><span class="line">	// 获取systemd的绝对位置</span><br><span class="line">	if m.adapter.cgroupManagerType == libcontainerSystemd &#123;</span><br><span class="line">		driverName = m.adapter.adaptName(cgroupConfig.Name, false)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 初始化cgroup配置</span><br><span class="line">	libcontainerCgroupConfig := &amp;libcontainerconfigs.Cgroup&#123;</span><br><span class="line">		Name:      driverName,</span><br><span class="line">		Parent:    driverParent,</span><br><span class="line">		Resources: resources,</span><br><span class="line">		Paths:     cgroupPaths,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    // 设置cgroup配置</span><br><span class="line">	if err := setSupportedSubsystems(libcontainerCgroupConfig); err != nil &#123;</span><br><span class="line">		return fmt.Errorf(&quot;failed to set supported cgroup subsystems for cgroup %v: %v&quot;, cgroupConfig.Name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看下参数是如何提取的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func (m *cgroupManagerImpl) toResources(resourceConfig *ResourceConfig) *libcontainerconfigs.Resources &#123;</span><br><span class="line">	resources := &amp;libcontainerconfigs.Resources&#123;&#125;</span><br><span class="line">	if resourceConfig == nil &#123;</span><br><span class="line">		return resources</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.Memory != nil &#123;</span><br><span class="line">		resources.Memory = *resourceConfig.Memory</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuShares != nil &#123;</span><br><span class="line">		resources.CpuShares = *resourceConfig.CpuShares</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuQuota != nil &#123;</span><br><span class="line">		resources.CpuQuota = *resourceConfig.CpuQuota</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuPeriod != nil &#123;</span><br><span class="line">		resources.CpuPeriod = *resourceConfig.CpuPeriod</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// huge page参数提取, 略过</span><br><span class="line">	if utilfeature.DefaultFeatureGate.Enabled(kubefeatures.HugePages) &#123;</span><br><span class="line">    ...</span><br><span class="line">	return resources</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在来看看CpuShare, CpuQuota, 和CpuPeriod都来字哪里:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// ResourceConfigForPod takes the input pod and outputs the cgroup resource config.</span><br><span class="line">func ResourceConfigForPod(pod *v1.Pod) *ResourceConfig &#123;</span><br><span class="line">	// sum requests and limits.</span><br><span class="line">	reqs, limits := resource.PodRequestsAndLimits(pod)</span><br><span class="line"></span><br><span class="line">	cpuRequests := int64(0)</span><br><span class="line">	cpuLimits := int64(0)</span><br><span class="line">	memoryLimits := int64(0)</span><br><span class="line">	if request, found := reqs[v1.ResourceCPU]; found &#123;</span><br><span class="line">		cpuRequests = request.MilliValue()</span><br><span class="line">	&#125;</span><br><span class="line">	if limit, found := limits[v1.ResourceCPU]; found &#123;</span><br><span class="line">		cpuLimits = limit.MilliValue()</span><br><span class="line">	&#125;</span><br><span class="line">	if limit, found := limits[v1.ResourceMemory]; found &#123;</span><br><span class="line">		memoryLimits = limit.Value()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// convert to CFS values</span><br><span class="line">	cpuShares := MilliCPUToShares(cpuRequests)</span><br><span class="line">	cpuQuota, cpuPeriod := MilliCPUToQuota(cpuLimits)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MilliCPUToShares converts the milliCPU to CFS shares.</span><br><span class="line">func MilliCPUToShares(milliCPU int64) uint64 &#123;</span><br><span class="line">	if milliCPU == 0 &#123;</span><br><span class="line">		// Docker converts zero milliCPU to unset, which maps to kernel default</span><br><span class="line">		// for unset: 1024. Return 2 here to really match kernel default for</span><br><span class="line">		// zero milliCPU.</span><br><span class="line">		return MinShares</span><br><span class="line">	&#125;</span><br><span class="line">	// Conceptually (milliCPU / milliCPUToCPU) * sharesPerCPU, but factored to improve rounding.</span><br><span class="line">	shares := (milliCPU * SharesPerCPU) / MilliCPUToCPU</span><br><span class="line">	if shares &lt; MinShares &#123;</span><br><span class="line">		return MinShares</span><br><span class="line">	&#125;</span><br><span class="line">	return uint64(shares)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MilliCPUToQuota converts milliCPU to CFS quota and period values.</span><br><span class="line">func MilliCPUToQuota(milliCPU int64) (quota int64, period uint64) &#123;</span><br><span class="line">	// CFS quota is measured in two values:</span><br><span class="line">	//  - cfs_period_us=100ms (the amount of time to measure usage across)</span><br><span class="line">	//  - cfs_quota=20ms (the amount of cpu time allowed to be used across a period)</span><br><span class="line">	// so in the above example, you are limited to 20% of a single CPU</span><br><span class="line">	// for multi-cpu environments, you just scale equivalent amounts</span><br><span class="line"></span><br><span class="line">	if milliCPU == 0 &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// we set the period to 100ms by default</span><br><span class="line">	period = QuotaPeriod</span><br><span class="line"></span><br><span class="line">	// we then convert your milliCPU to a value normalized over a period</span><br><span class="line">	quota = (milliCPU * QuotaPeriod) / MilliCPUToCPU</span><br><span class="line"></span><br><span class="line">	// quota needs to be a minimum of 1ms.</span><br><span class="line">	if quota &lt; MinQuotaPeriod &#123;</span><br><span class="line">		quota = MinQuotaPeriod</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	// Taken from lmctfy https://github.com/google/lmctfy/blob/master/lmctfy/controllers/cpu_controller.cc</span><br><span class="line">	MinShares     = 2</span><br><span class="line">	SharesPerCPU  = 1024</span><br><span class="line">	MilliCPUToCPU = 1000</span><br><span class="line"></span><br><span class="line">	// 100000 is equivalent to 100ms</span><br><span class="line">	QuotaPeriod    = 100000</span><br><span class="line">	MinQuotaPeriod = 1000</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>设置的代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func setSupportedSubsystems(cgroupConfig *libcontainerconfigs.Cgroup) error &#123;</span><br><span class="line">	for _, sys := range getSupportedSubsystems() &#123;</span><br><span class="line">		if _, ok := cgroupConfig.Paths[sys.Name()]; !ok &#123;</span><br><span class="line">			return fmt.Errorf(&quot;Failed to find subsystem mount for subsystem: %v&quot;, sys.Name())</span><br><span class="line">		&#125;</span><br><span class="line">        // 调用前面的cgroup.Set()方法</span><br><span class="line">		if err := sys.Set(cgroupConfig.Paths[sys.Name()], cgroupConfig); err != nil &#123;</span><br><span class="line">			return fmt.Errorf(&quot;Failed to set config for supported subsystems : %v&quot;, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码很明显了:</p>
<p>Request -&gt; cpu.shares</p>
<p>Limits -&gt; cpu.quota(CFS或者RT)</p>
<p>QuotaPeriod 为100ms</p>
<p>所以当Request设置0.5(0.5 <em>1024&#x3D;512), 等价于设置500m(500</em> 1024&#x2F;1000&#x3D;512), 也就是512.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.shares </span><br><span class="line">512</span><br></pre></td></tr></table></figure>

<p>当Limit设置1(1 <em>1000</em> 100000&#x2F;1000&#x3D;100000), 等价于1000m(1000 * 100000 &#x2F; 1000 &#x3D; 100000 ), 也就是quota&#x3D;100000, period&#x3D;100000.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.cfs_quota_us </span><br><span class="line">100000</span><br><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.cfs_period_us </span><br><span class="line">100000</span><br></pre></td></tr></table></figure>

<p>至此所有路走通.</p>
<h4 id="值得注意的点"><a href="#值得注意的点" class="headerlink" title="值得注意的点"></a>值得注意的点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The CPU resource is measured in cpu units. One cpu, in Kubernetes, is equivalent to:</span><br><span class="line"></span><br><span class="line">    1 AWS vCPU</span><br><span class="line">    1 GCP Core</span><br><span class="line">    1 Azure vCore</span><br><span class="line">    1 Hyperthread on a bare-metal Intel processor with Hyperthreading</span><br></pre></td></tr></table></figure>

<p>从文档来看所以4核8线程对k8s来讲就是8核.</p>
<p>如果只设置了request没有设置limit, 意味着一个pod可以任意使用node资源, 如果没有其他pod创建. 如果集群管理员设置了<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#limitrange-v1-core/">LimitRange</a>, 那么当pod没有设置limit的时候就会使用LimitRange里设置的值作为默认.</p>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><ol>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#what-if-you-specify-a-container-s-request-but-not-its-limit">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#what-if-you-specify-a-container-s-request-but-not-its-limit</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008323952">https://segmentfault.com/a/1190000008323952</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-go-sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/10/2018-10-12-go-sort/" class="post-title-link" itemprop="url">go-sort</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Go排序实现在&#x2F;src&#x2F;go4.org&#x2F;sort&#x2F;sort.go中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">func Sort(data Interface) &#123;</span><br><span class="line">	n := data.Len()</span><br><span class="line">	if fs, ok := data.(*funcs); ok &#123;</span><br><span class="line">		quickSort_func(fs.lessSwap, 0, n, maxDepth(n))</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		quickSort(data, 0, n, maxDepth(n))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func quickSort(data Interface, a, b, maxDepth int) &#123;</span><br><span class="line">	for b-a &gt; 12 &#123; // Use ShellSort for slices &lt;= 12 elements</span><br><span class="line">		if maxDepth == 0 &#123;</span><br><span class="line">			heapSort(data, a, b)</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		maxDepth--</span><br><span class="line">		mlo, mhi := doPivot(data, a, b)</span><br><span class="line">		// Avoiding recursion on the larger subproblem guarantees</span><br><span class="line">		// a stack depth of at most lg(b-a).</span><br><span class="line">		if mlo-a &lt; b-mhi &#123;</span><br><span class="line">			quickSort(data, a, mlo, maxDepth)</span><br><span class="line">			a = mhi // i.e., quickSort(data, mhi, b)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			quickSort(data, mhi, b, maxDepth)</span><br><span class="line">			b = mlo // i.e., quickSort(data, a, mlo)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if b-a &gt; 1 &#123;</span><br><span class="line">		// Do ShellSort pass with gap 6</span><br><span class="line">		// It could be written in this simplified form cause b-a &lt;= 12</span><br><span class="line">		for i := a + 6; i &lt; b; i++ &#123;</span><br><span class="line">			if data.Less(i, i-6) &#123;</span><br><span class="line">				data.Swap(i, i-6)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		insertionSort(data, a, b)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">// Insertion sort</span><br><span class="line">func insertionSort(data Interface, a, b int) &#123;</span><br><span class="line">	for i := a + 1; i &lt; b; i++ &#123;</span><br><span class="line">		for j := i; j &gt; a &amp;&amp; data.Less(j, j-1); j-- &#123;</span><br><span class="line">			data.Swap(j, j-1)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>quickSort和quickSort_func基本相同, 子不过自己定义的比较方法, 这里不在赘述.</p>
<p>可以看到主体是quickSort, 所以不保证稳定排序, 当数据量小于等于12时. 退化为希尔排序, 但希尔排序只做了一次gap为6, 之后再次退化为了简单插入排序. 这部分实现非常简单, i从前往后, j从i往前, 每次比较j-1和j, 将小的换到前面.</p>
<p>当数据量大于12时, 根据maxDepth是否为0决定使用对排序还是使用快速排序, maxDepth计算:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// maxDepth returns a threshold at which quicksort should switch</span><br><span class="line">// to heapsort. It returns 2*ceil(lg(n+1)).</span><br><span class="line">func maxDepth(n int) int &#123;</span><br><span class="line">	var depth int</span><br><span class="line">	for i := n; i &gt; 0; i &gt;&gt;= 1 &#123;</span><br><span class="line">		depth++</span><br><span class="line">	&#125;</span><br><span class="line">	return depth * 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回的是目前树高度的2倍. 每进行一轮快速排序的partition(doPivot), 这个数值就减1, 当减为0, 此时认为数据已经比较有序, 如果数据长度依然大于12, 改为堆排序效率更高.</p>
<p>这里先看快速排序的主体部分, 再来看堆排序的实现. partition是快排的思想核心, 他实现在doPivot中:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doPivot</span><span class="params">(data Interface, lo, hi <span class="type">int</span>)</span></span> (midlo, midhi <span class="type">int</span>) &#123;</span><br><span class="line">	m := lo + (hi-lo)/<span class="number">2</span> <span class="comment">// 避免整数溢出</span></span><br><span class="line">	<span class="keyword">if</span> hi-lo &gt; <span class="number">40</span> &#123; 如果长度大于<span class="number">40</span>, 使用Tukey ninther法</span><br><span class="line">		<span class="comment">// Tukey&#x27;s ``Ninther,&#x27;&#x27; median of three medians of three.</span></span><br><span class="line">		s := (hi - lo) / <span class="number">8</span></span><br><span class="line">		medianOfThree(data, lo, lo+s, lo+<span class="number">2</span>*s)</span><br><span class="line">		medianOfThree(data, m, m-s, m+s)</span><br><span class="line">		medianOfThree(data, hi<span class="number">-1</span>, hi<span class="number">-1</span>-s, hi<span class="number">-1</span><span class="number">-2</span>*s)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// medianOfThree 保证lo, m hi-1三个值是从小到大的</span></span><br><span class="line">	medianOfThree(data, lo, m, hi<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Invariants are:</span></span><br><span class="line">	<span class="comment">//	data[lo] = pivot (set up by ChoosePivot)</span></span><br><span class="line">	<span class="comment">//	data[lo &lt; i &lt; a] &lt; pivot</span></span><br><span class="line">	<span class="comment">//	data[a &lt;= i &lt; b] &lt;= pivot</span></span><br><span class="line">	<span class="comment">//	data[b &lt;= i &lt; c] unexamined</span></span><br><span class="line">	<span class="comment">//	data[c &lt;= i &lt; hi-1] &gt; pivot</span></span><br><span class="line">	<span class="comment">//	data[hi-1] &gt;= pivot</span></span><br><span class="line">	pivot := lo</span><br><span class="line">	a, c := lo+<span class="number">1</span>, hi<span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到第一个比起始值点大的Index</span></span><br><span class="line">	<span class="keyword">for</span> ; a &lt; c &amp;&amp; data.Less(a, pivot); a++ &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	b := a</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; !data.Less(pivot, b); b++ &#123; <span class="comment">// data[b] &lt;= pivot</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; data.Less(pivot, c<span class="number">-1</span>); c-- &#123; <span class="comment">// data[c-1] &gt; pivot</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> b &gt;= c &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// data[b] &gt; pivot; data[c-1] &lt;= pivot</span></span><br><span class="line">		data.Swap(b, c<span class="number">-1</span>)</span><br><span class="line">		b++</span><br><span class="line">		c--</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If hi-c&lt;3 then there are duplicates (by property of median of nine).</span></span><br><span class="line">	<span class="comment">// Let be a bit more conservative, and set border to 5.</span></span><br><span class="line">	protect := hi-c &lt; <span class="number">5</span></span><br><span class="line">	<span class="keyword">if</span> !protect &amp;&amp; hi-c &lt; (hi-lo)/<span class="number">4</span> &#123;</span><br><span class="line">		<span class="comment">// Lets test some points for equality to pivot</span></span><br><span class="line">		dups := <span class="number">0</span></span><br><span class="line">		<span class="keyword">if</span> !data.Less(pivot, hi<span class="number">-1</span>) &#123; <span class="comment">// data[hi-1] = pivot</span></span><br><span class="line">			data.Swap(c, hi<span class="number">-1</span>)</span><br><span class="line">			c++</span><br><span class="line">			dups++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !data.Less(b<span class="number">-1</span>, pivot) &#123; <span class="comment">// data[b-1] = pivot</span></span><br><span class="line">			b--</span><br><span class="line">			dups++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// m-lo = (hi-lo)/2 &gt; 6</span></span><br><span class="line">		<span class="comment">// b-lo &gt; (hi-lo)*3/4-1 &gt; 8</span></span><br><span class="line">		<span class="comment">// ==&gt; m &lt; b ==&gt; data[m] &lt;= pivot</span></span><br><span class="line">		<span class="keyword">if</span> !data.Less(m, pivot) &#123; <span class="comment">// data[m] = pivot</span></span><br><span class="line">			data.Swap(m, b<span class="number">-1</span>)</span><br><span class="line">			b--</span><br><span class="line">			dups++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// if at least 2 points are equal to pivot, assume skewed distribution</span></span><br><span class="line">		protect = dups &gt; <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> protect &#123;</span><br><span class="line">		<span class="comment">// Protect against a lot of duplicates</span></span><br><span class="line">		<span class="comment">// Add invariant:</span></span><br><span class="line">		<span class="comment">//	data[a &lt;= i &lt; b] unexamined</span></span><br><span class="line">		<span class="comment">//	data[b &lt;= i &lt; c] = pivot</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; !data.Less(b<span class="number">-1</span>, pivot); b-- &#123; <span class="comment">// data[b] == pivot</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; data.Less(a, pivot); a++ &#123; <span class="comment">// data[a] &lt; pivot</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> a &gt;= b &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// data[a] == pivot; data[b-1] &lt; pivot</span></span><br><span class="line">			data.Swap(a, b<span class="number">-1</span>)</span><br><span class="line">			a++</span><br><span class="line">			b--</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Swap pivot into middle</span></span><br><span class="line">	data.Swap(pivot, b<span class="number">-1</span>)</span><br><span class="line">	<span class="keyword">return</span> b - <span class="number">1</span>, c</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// medianOfThree moves the median of the three values data[m0], data[m1], data[m2] into data[m1].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">medianOfThree</span><span class="params">(data Interface, m1, m0, m2 <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// sort 3 elements</span></span><br><span class="line">	<span class="keyword">if</span> data.Less(m1, m0) &#123;</span><br><span class="line">		data.Swap(m1, m0)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// data[m0] &lt;= data[m1]</span></span><br><span class="line">	<span class="keyword">if</span> data.Less(m2, m1) &#123;</span><br><span class="line">		data.Swap(m2, m1)</span><br><span class="line">		<span class="comment">// data[m0] &lt;= data[m2] &amp;&amp; data[m1] &lt; data[m2]</span></span><br><span class="line">		<span class="keyword">if</span> data.Less(m1, m0) &#123;</span><br><span class="line">			data.Swap(m1, m0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 保证 data[m0] &lt;= data[m1] &lt;= data[m2]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
