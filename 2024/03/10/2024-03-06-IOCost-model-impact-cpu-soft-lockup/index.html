<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Reproduceenvironment: 5.15 kernel way: Enable cgroup v2 and bfq, set bfq as scheduler on target deviceEnable io cost by &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;io.cost.qos, set cgroup io.weightStart two or">
<meta property="og:type" content="article">
<meta property="og:title" content="IOCost model impact cpu soft lockup">
<meta property="og:url" content="http://example.com/2024/03/10/2024-03-06-IOCost-model-impact-cpu-soft-lockup/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Reproduceenvironment: 5.15 kernel way: Enable cgroup v2 and bfq, set bfq as scheduler on target deviceEnable io cost by &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;io.cost.qos, set cgroup io.weightStart two or">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://lh7-us.googleusercontent.com/bq2FPR6rf3vTi3qwBroUf_ukX2q8_kuRj8GbANgmURAwdcfd3c6QBivBGFvtvvADlqdTU4CbjvhIBrHzJefKR8UpE5WR7A0jZ7tFH5odAsfF8JjofHbi2vq8AFHgUT6cdfmcOxm0Tc0gyZCdXJGYfog">
<meta property="article:published_time" content="2024-03-10T04:51:59.406Z">
<meta property="article:modified_time" content="2024-03-10T04:51:59.406Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lh7-us.googleusercontent.com/bq2FPR6rf3vTi3qwBroUf_ukX2q8_kuRj8GbANgmURAwdcfd3c6QBivBGFvtvvADlqdTU4CbjvhIBrHzJefKR8UpE5WR7A0jZ7tFH5odAsfF8JjofHbi2vq8AFHgUT6cdfmcOxm0Tc0gyZCdXJGYfog">


<link rel="canonical" href="http://example.com/2024/03/10/2024-03-06-IOCost-model-impact-cpu-soft-lockup/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2024/03/10/2024-03-06-IOCost-model-impact-cpu-soft-lockup/","path":"2024/03/10/2024-03-06-IOCost-model-impact-cpu-soft-lockup/","title":"IOCost model impact cpu soft lockup"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>IOCost model impact cpu soft lockup | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reproduce"><span class="nav-number">1.</span> <span class="nav-text">Reproduce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debug"><span class="nav-number">2.</span> <span class="nav-text">Debug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution"><span class="nav-number">3.</span> <span class="nav-text">Solution</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2024-03-06-IOCost-model-impact-cpu-soft-lockup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="IOCost model impact cpu soft lockup | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          IOCost model impact cpu soft lockup
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:51:59" itemprop="dateCreated datePublished" datetime="2024-03-10T12:51:59+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system/" itemprop="url" rel="index"><span itemprop="name">system</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h3><p><em>environment</em>:</p>
<p>5.15 kernel</p>
<p><em>way</em>:</p>
<p>Enable cgroup v2 and bfq, set bfq as scheduler on target deviceEnable io cost by &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;io.cost.qos, set cgroup io.weightStart two or more fio process to read or write on the target device, at least contains 1 direct and 1 buffer io, each one use different cgroupsWait 10-30 minutes</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>Kernel Dump 1 (Set hardlockup_panic&#x3D;1 by sysctl):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[ 1408.828715] Call Trace:</span><br><span class="line">[ 1408.828716]  &lt;TASK&gt;</span><br><span class="line">[ 1408.828718]  _raw_spin_lock_irq+0x26/0x30</span><br><span class="line">[ 1408.828722]  bfq_bio_merge+0x9f/0x160 [bfq]</span><br><span class="line">[ 1408.828727]  __blk_mq_sched_bio_merge+0x36/0x190</span><br><span class="line">[ 1408.828731]  blk_mq_submit_bio+0xd2/0x600</span><br><span class="line">[ 1408.828735]  __submit_bio+0x1dc/0x210</span><br><span class="line">[ 1408.828738]  submit_bio_noacct+0x263/0x2c0</span><br><span class="line">[ 1408.828741]  submit_bio+0x48/0x130</span><br><span class="line">[ 1408.828743]  iomap_submit_ioend.isra.0+0x52/0x80</span><br><span class="line">[ 1408.828745]  iomap_writepage_map+0x490/0x630</span><br><span class="line">[ 1408.828748]  iomap_do_writepage+0x75/0x230</span><br><span class="line">[ 1408.828750]  ? clear_page_dirty_for_io+0xdf/0x1d0</span><br><span class="line">[ 1408.828754]  write_cache_pages+0x184/0x450</span><br><span class="line">[ 1408.828756]  ? iomap_truncate_page+0x60/0x60</span><br><span class="line">[ 1408.828760]  iomap_writepages+0x20/0x40</span><br><span class="line">[ 1408.828762]  xfs_vm_writepages+0x84/0xb0 [xfs]</span><br><span class="line">[ 1408.828837]  do_writepages+0xc5/0x1c0</span><br><span class="line">[ 1408.828839]  ? __wb_calc_thresh+0x3e/0x120</span><br><span class="line">[ 1408.828842]  __writeback_single_inode+0x44/0x290</span><br><span class="line">[ 1408.828845]  writeback_sb_inodes+0x22d/0x4b0</span><br><span class="line">[ 1408.828849]  __writeback_inodes_wb+0x56/0xf0</span><br><span class="line">[ 1408.828852]  wb_writeback+0x1ce/0x290</span><br><span class="line">[ 1408.828855]  wb_workfn+0x31b/0x490</span><br><span class="line">[ 1408.828858]  ? psi_task_switch+0xc3/0x240</span><br><span class="line">[ 1408.828862]  process_one_work+0x22b/0x3d0</span><br><span class="line">[ 1408.828865]  worker_thread+0x4d/0x3f0</span><br><span class="line">[ 1408.828868]  ? process_one_work+0x3d0/0x3d0</span><br><span class="line">[ 1408.828870]  kthread+0x12a/0x150</span><br><span class="line">[ 1408.828872]  ? set_kthread_struct+0x40/0x40</span><br><span class="line">[ 1408.828874]  ret_from_fork+0x22/0x30</span><br><span class="line">[ 1408.828879]  &lt;/TASK&gt;</span><br><span class="line">[ 1408.829600] Kernel panic - not syncing: Hard LOCKUP</span><br><span class="line">[ 1408.829602] CPU: 26 PID: 0 Comm: swapper/26 Kdump: loaded Tainted: P          IOE K   5.15.0-26-generic #26</span><br><span class="line">[ 1408.829604] Hardware name: Dell Inc. PowerEdge C6420/0K2TT6, BIOS 2.4.8 11/27/2019</span><br><span class="line">[ 1408.829605] Call Trace:</span><br><span class="line">[ 1408.829606]  &lt;NMI&gt;</span><br><span class="line">[ 1408.829608]  dump_stack_lvl+0x4a/0x5f</span><br><span class="line">[ 1408.829615]  dump_stack+0x10/0x12</span><br><span class="line">[ 1408.829617]  panic+0x149/0x321</span><br><span class="line">[ 1408.829623]  nmi_panic.cold+0xc/0xc</span><br><span class="line">[ 1408.829626]  watchdog_overflow_callback.cold+0x5c/0x70</span><br><span class="line">[ 1408.829631]  __perf_event_overflow+0x57/0x100</span><br><span class="line">[ 1408.829634]  perf_event_overflow+0x14/0x20</span><br><span class="line">[ 1408.829637]  handle_pmi_common+0x1f3/0x2f0</span><br><span class="line">[ 1408.829643]  ? flush_tlb_one_kernel+0xe/0x20</span><br><span class="line">[ 1408.829647]  ? __set_pte_vaddr+0x37/0x40</span><br><span class="line">[ 1408.829650]  ? set_pte_vaddr_p4d+0x3d/0x50</span><br><span class="line">[ 1408.829652]  ? set_pte_vaddr+0x81/0xb0</span><br><span class="line">[ 1408.829653]  ? __native_set_fixmap+0x28/0x40</span><br><span class="line">[ 1408.829655]  ? native_set_fixmap+0x66/0x70</span><br><span class="line">[ 1408.829657]  ? ghes_copy_tofrom_phys+0x7c/0x120</span><br><span class="line">[ 1408.829663]  ? __ghes_peek_estatus.isra.0+0x4e/0xb0</span><br><span class="line">[ 1408.829666]  intel_pmu_handle_irq+0xf4/0x210</span><br><span class="line">[ 1408.829670]  perf_event_nmi_handler+0x2d/0x50</span><br><span class="line">[ 1408.829672]  nmi_handle+0x66/0x120</span><br><span class="line">[ 1408.829678]  default_do_nmi+0x45/0x110</span><br><span class="line">[ 1408.829681]  exc_nmi+0x175/0x190</span><br><span class="line">[ 1408.829683]  end_repeat_nmi+0x16/0x55</span><br><span class="line">[ 1408.829685] RIP: 0010:native_queued_spin_lock_slowpath+0x14f/0x220</span><br><span class="line">[ 1408.827472]  ? adjust_inuse_and_calc_cost+0x13a/0x250</span><br><span class="line">[ 1408.827475]  ioc_rqos_merge+0xef/0x260</span><br><span class="line">[ 1408.827478]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[ 1408.827481]  bio_attempt_back_merge+0x43/0xd0</span><br><span class="line">[ 1408.827484]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[ 1408.827486]  bfq_bio_merge+0xe2/0x160 [bfq]</span><br><span class="line">[ 1408.827491]  __blk_mq_sched_bio_merge+0x36/0x190</span><br><span class="line">[ 1408.827495]  blk_mq_submit_bio+0xd2/0x600</span><br><span class="line">[ 1408.827499]  __submit_bio+0x1dc/0x210</span><br><span class="line">[ 1408.827502]  ? get_user_pages_fast+0x24/0x40</span><br><span class="line">[ 1408.827507]  ? iov_iter_get_pages+0xc6/0x3f0</span><br><span class="line">[ 1408.827513]  submit_bio_noacct+0xac/0x2c0</span><br><span class="line">[ 1408.827516]  submit_bio+0x48/0x130</span><br><span class="line">[ 1408.827518]  iomap_dio_submit_bio+0x79/0x80</span><br><span class="line">[ 1408.827524]  iomap_dio_bio_iter+0x2d7/0x4a0</span><br><span class="line">[ 1408.827528]  __iomap_dio_rw+0x531/0x7c0</span><br><span class="line">[ 1408.827532]  iomap_dio_rw+0xe/0x30</span><br><span class="line">[ 1408.827535]  xfs_file_dio_write_aligned+0xa0/0x110 [xfs]</span><br><span class="line">[ 1408.827647]  xfs_file_write_iter+0x101/0x1a0 [xfs]</span><br><span class="line">[ 1408.827736]  aio_write+0x116/0x210</span><br><span class="line">[ 1408.827740]  ? update_load_avg+0x7c/0x640</span><br><span class="line">[ 1408.827744]  ? set_next_entity+0xb7/0x200</span><br><span class="line">[ 1408.827747]  __io_submit_one.constprop.0+0x40e/0x720</span><br><span class="line">[ 1408.827749]  ? __io_submit_one.constprop.0+0x40e/0x720</span><br><span class="line">[ 1408.827752]  ? __check_object_size+0x5d/0x150</span><br><span class="line">[ 1408.827755]  ? _copy_to_user+0x20/0x30</span><br><span class="line">[ 1408.827760]  ? aio_read_events+0x210/0x320</span><br><span class="line">[ 1408.827762]  io_submit_one+0xe3/0x550</span><br><span class="line">[ 1408.827764]  ? io_submit_one+0xe3/0x550</span><br><span class="line">[ 1408.827766]  ? audit_filter_rules.constprop.0+0x3b1/0x12e0</span><br><span class="line">[ 1408.827772]  __x64_sys_io_submit+0x8d/0x180</span><br><span class="line">[ 1408.827775]  ? syscall_trace_enter.isra.0+0x146/0x1c0</span><br><span class="line">[ 1408.827779]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 1408.827782]  ? exit_to_user_mode_prepare+0x3d/0x1c0</span><br><span class="line">[ 1408.827785]  ? syscall_exit_to_user_mode+0x27/0x50</span><br><span class="line">[ 1408.827788]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 1408.827790]  ? irqentry_exit+0x19/0x30</span><br><span class="line">[ 1408.827793]  ? sysvec_call_function_single+0x4e/0x90</span><br><span class="line">[ 1408.827795]  ? asm_sysvec_call_function_single+0xa/0x20</span><br><span class="line">[ 1408.827799]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br></pre></td></tr></table></figure>





<p>Kernel dump 2 :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[60977.577690] BUG: spinlock recursion on CPU#21, fio/11770</span><br><span class="line">[60977.583007]  lock: 0xffff92600e348c20, .magic: dead4ead, .owner: fio/11770, .owner_cpu: 21</span><br><span class="line">[60977.591275] CPU: 21 PID: 11770 Comm: fio Kdump: loaded Not tainted 5.15.0-26-generic #26</span><br><span class="line">[60977.599362] Hardware name: Supermicro SYS-6029TP-H-EI012/X11DPT-PS-EI012, BIOS 1.0.9.0 01/31/2018</span><br><span class="line">[60977.608229] Call Trace:</span><br><span class="line">[60977.610682]  &lt;IRQ&gt;</span><br><span class="line">[60977.612700]  dump_stack_lvl+0x58/0x7d</span><br><span class="line">[60977.616367]  dump_stack+0x10/0x12</span><br><span class="line">[60977.619687]  spin_dump.cold+0x24/0x39</span><br><span class="line">[60977.623359]  do_raw_spin_lock+0x9a/0xd0</span><br><span class="line">[60977.627198]  _raw_spin_lock_irqsave+0x7d/0x80</span><br><span class="line">[60977.631561]  bfq_finish_requeue_request+0x55/0x540 [bfq]</span><br><span class="line">[60977.636874]  blk_mq_free_request+0x3e/0x160</span><br><span class="line">[60977.641058]  __blk_mq_end_request+0x102/0x110</span><br><span class="line">[60977.645419]  scsi_end_request+0xce/0x190</span><br><span class="line">[60977.649345]  scsi_io_completion+0x7e/0x5d0</span><br><span class="line">[60977.653442]  scsi_finish_command+0xca/0x100</span><br><span class="line">[60977.657629]  scsi_complete+0x74/0xe0</span><br><span class="line">[60977.661212]  blk_complete_reqs+0x3b/0x50</span><br><span class="line">[60977.665135]  blk_done_softirq+0x1d/0x20</span><br><span class="line">[60977.668975]  __do_softirq+0xf7/0x31e</span><br><span class="line">[60977.672554]  irq_exit_rcu+0x79/0xa0</span><br><span class="line">[60977.676044]  sysvec_call_function_single+0x7c/0x90</span><br><span class="line">[60977.680837]  &lt;/IRQ&gt;</span><br><span class="line">[60977.682945]  &lt;TASK&gt;</span><br><span class="line">[60977.685051]  asm_sysvec_call_function_single+0x12/0x20</span><br><span class="line">[60977.690189] RIP: 0010:_raw_spin_unlock_irq+0x2a/0x30</span><br><span class="line">[60977.695155] Code: 0f 1f 44 00 00 55 48 89 e5 41 54 49 89 fc 48 8d 7f 18 48 8b 75 08 e8 75 6f 3d ff 4c 89 e7 e8 8d b0 3d ff fb 66 0f 1f 44 00 00 &lt;41&gt; 5c 5d c3 66 90 0f 1f 44 00 00 55 48 89 e5 41 54 49 89 fc 48 8d</span><br><span class="line">[60977.713902] RSP: 0018:ffffa0781992b670 EFLAGS: 00000246</span><br><span class="line">[60977.719128] RAX: 0000000000000015 RBX: 00000000001d9281 RCX: 0000000036d7555b</span><br><span class="line">[60977.726260] RDX: 000000007a3bfa68 RSI: ffff9260bca80d48 RDI: ffff92600fd9f0e0</span><br><span class="line">[60977.733392] RBP: ffffa0781992b678 R08: 00000000ffffffff R09: 00000000ffffffff</span><br><span class="line">[60977.740527] R10: 0000000000000001 R11: ffff9231c6d2cc00 R12: ffff92600fd9f0e0</span><br><span class="line">[60977.747661] R13: ffffa0781992b710 R14: 0000000000000001 R15: 000000000019007e</span><br><span class="line">[60977.754794]  adjust_inuse_and_calc_cost+0x164/0x250</span><br><span class="line">[60977.759673]  ioc_rqos_merge+0xef/0x260</span><br><span class="line">[60977.763425]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[60977.767091]  bio_attempt_back_merge+0x64/0xf0</span><br><span class="line">[60977.771451]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[60977.775982]  bfq_bio_merge+0xe2/0x150 [bfq]</span><br><span class="line">[60977.780168]  __blk_mq_sched_bio_merge+0x36/0x1b0</span><br><span class="line">[60977.784790]  blk_mq_submit_bio+0xd5/0x690</span><br><span class="line">[60977.788803]  __submit_bio+0x23d/0x270</span><br><span class="line">[60977.792465]  ? wake_up_page_bit+0xd3/0x100</span><br><span class="line">[60977.796568]  submit_bio_noacct+0x26c/0x2d0</span><br><span class="line">[60977.800664]  ? wake_up_page_bit+0xd3/0x100</span><br><span class="line">[60977.804764]  submit_bio+0x48/0x140</span><br><span class="line">[60977.808171]  iomap_submit_ioend.isra.0+0x52/0x80</span><br><span class="line">[60977.812790]  iomap_writepage_map+0x490/0x630</span><br><span class="line">[60977.817065]  iomap_do_writepage+0x8c/0x260</span><br><span class="line">[60977.821161]  ? clear_page_dirty_for_io+0x113/0x220</span><br><span class="line">[60977.825955]  write_cache_pages+0x19e/0x460</span><br><span class="line">[60977.830054]  ? iomap_truncate_page+0x60/0x60</span><br><span class="line">[60977.834330]  iomap_writepages+0x20/0x40</span><br><span class="line">[60977.838167]  xfs_vm_writepages+0x85/0xb0 [xfs]</span><br><span class="line">[60977.842718]  do_writepages+0xc6/0x1c0</span><br><span class="line">[60977.846384]  ? _raw_spin_unlock+0x23/0x30</span><br><span class="line">[60977.850398]  filemap_fdatawrite_wbc+0x7d/0xc0</span><br><span class="line">[60977.854756]  __filemap_fdatawrite_range+0x54/0x70</span><br><span class="line">[60977.859463]  generic_fadvise+0x299/0x2c0</span><br><span class="line">[60977.863387]  xfs_file_fadvise+0x23/0x80 [xfs]</span><br><span class="line">[60977.867807]  vfs_fadvise+0x1e/0x30</span><br><span class="line">[60977.871214]  ksys_fadvise64_64+0x41/0x80</span><br><span class="line">[60977.875140]  ? syscall_trace_enter.isra.0+0x16b/0x1e0</span><br><span class="line">[60977.880194]  __x64_sys_fadvise64+0x1e/0x30</span><br><span class="line">[60977.884291]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[60977.887870]  ? irqentry_exit_to_user_mode+0x9/0x20</span><br><span class="line">[60977.892665]  ? irqentry_exit+0x19/0x30</span><br><span class="line">[60977.896416]  ? exc_page_fault+0x94/0x1b0</span><br><span class="line">[60977.900343]  ? asm_exc_page_fault+0x8/0x30</span><br><span class="line">[60977.904444]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br><span class="line">[60977.909496] RIP: 0033:0x7f16f2c07d3e</span><br><span class="line">[60977.913076] Code: 10 10 00 f7 d8 64 89 02 b8 ff ff ff ff eb b3 e8 28 d8 01 00 0f 1f 84 00 00 00 00 00 f3 0f 1e fa 41 89 ca b8 dd 00 00 00 0f 05 &lt;89&gt; c2 f7 da 3d 00 f0 ff ff b8 00 00 00 00 0f 47 c2 c3 41 57 41 56</span><br><span class="line">[60977.931819] RSP: 002b:00007ffd83ec8338 EFLAGS: 00000246 ORIG_RAX: 00000000000000dd</span><br><span class="line">[60977.939388] RAX: ffffffffffffffda RBX: 00007f16effca890 RCX: 00007f16f2c07d3e</span><br><span class="line">[60977.946518] RDX: 0000000280000000 RSI: 0000000000000000 RDI: 0000000000000006</span><br><span class="line">[60977.953652] RBP: 0000000000000000 R08: 00007f16e8f2b028 R09: 0000000000000000</span><br><span class="line">[60977.960784] R10: 0000000000000004 R11: 0000000000000246 R12: 0000000280000000</span><br><span class="line">[60977.967918] R13: 00007f16e8c16c80 R14: 00007f16effca890 R15: 00007f16e8c16c80</span><br><span class="line">[60977.975053]  &lt;/TASK&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Kernel dump 3 (enable lockdep):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">[ 4398.422037] WARNING: inconsistent lock state</span><br><span class="line">[ 4398.426311] 5.15.0-26-generic #26 Not tainted</span><br><span class="line">[ 4398.430666] --------------------------------</span><br><span class="line">[ 4398.434939] inconsistent &#123;IN-HARDIRQ-W&#125; -&gt; &#123;HARDIRQ-ON-W&#125; usage.</span><br><span class="line">[ 4398.440947] fio/156503 [HC0[0]:SC0[0]:HE0:SE1] takes:</span><br><span class="line">[ 4398.445997] ffff8b5bd4771c38 (&amp;bfqd-&gt;lock)&#123;?.-.&#125;-&#123;2:2&#125;, at: bfq_bio_merge+0x9f/0x150 [bfq]</span><br><span class="line">[ 4398.454265] &#123;IN-HARDIRQ-W&#125; state was registered at:</span><br><span class="line">[ 4398.459148]   lock_acquire+0xd8/0x300</span><br><span class="line">[ 4398.462823]   _raw_spin_lock_irqsave+0x52/0xa0</span><br><span class="line">[ 4398.467279]   bfq_idle_slice_timer+0x2d/0xc0 [bfq]</span><br><span class="line">[ 4398.472079]   __hrtimer_run_queues+0x8b/0x420</span><br><span class="line">[ 4398.476438]   hrtimer_interrupt+0x109/0x230</span><br><span class="line">[ 4398.480621]   __sysvec_apic_timer_interrupt+0x78/0x1f0</span><br><span class="line">[ 4398.485761]   sysvec_apic_timer_interrupt+0x77/0x90</span><br><span class="line">[ 4398.490640]   asm_sysvec_apic_timer_interrupt+0x12/0x20</span><br><span class="line">[ 4398.495868]   lock_is_held_type+0x115/0x150</span><br><span class="line">[ 4398.500054]   rcu_read_lock_sched_held+0x5a/0x90</span><br><span class="line">[ 4398.504673]   lock_acquire+0x19f/0x300</span><br><span class="line">[ 4398.508426]   process_one_work+0x28d/0x5d0</span><br><span class="line">[ 4398.512525]   worker_thread+0x4a/0x3d0</span><br><span class="line">[ 4398.516276]   kthread+0x141/0x160</span><br><span class="line">[ 4398.519597]   ret_from_fork+0x22/0x30</span><br><span class="line">[ 4398.523289] irq event stamp: 1141506</span><br><span class="line">[ 4398.526869] hardirqs last  enabled at (1141505): [&lt;ffffffff880849b1&gt;] _raw_spin_unlock_irqrestore+0x51/0x70</span><br><span class="line">[ 4398.536601] hardirqs last disabled at (1141506): [&lt;ffffffff88084744&gt;] _raw_spin_lock_irq+0x74/0x90</span><br><span class="line">[ 4398.545556] softirqs last  enabled at (1139712): [&lt;ffffffff884002f5&gt;] __do_softirq+0x2f5/0x4d3</span><br><span class="line">[ 4398.554160] softirqs last disabled at (1139699): [&lt;ffffffff872c9556&gt;] irq_exit_rcu+0x96/0xc0</span><br><span class="line">[ 4398.562594] </span><br><span class="line">               other info that might help us debug this:</span><br><span class="line">[ 4398.569121]  Possible unsafe locking scenario:</span><br><span class="line">               </span><br><span class="line">[ 4398.575041]        CPU0</span><br><span class="line">[ 4398.577494]        ----</span><br><span class="line">[ 4398.579947]   lock(&amp;bfqd-&gt;lock);</span><br><span class="line">[ 4398.583188]   &lt;Interrupt&gt;</span><br><span class="line">[ 4398.585813]     lock(&amp;bfqd-&gt;lock);</span><br><span class="line">[ 4398.589219] </span><br><span class="line">                *** DEADLOCK ***</span><br><span class="line">               </span><br><span class="line">[ 4398.595137] 2 locks held by fio/156503:</span><br><span class="line">[ 4398.598978]  #0: ffff8b5c653c4e28 (&amp;sb-&gt;s_type-&gt;i_mutex_key#14)&#123;++++&#125;-&#123;3:3&#125;, at: xfs_ilock+0x104/0x1b0 [xfs]</span><br><span class="line">[ 4398.608937]  #1: ffff8b5bd4771c38 (&amp;bfqd-&gt;lock)&#123;?.-.&#125;-&#123;2:2&#125;, at: bfq_bio_merge+0x9f/0x150 [bfq]</span><br><span class="line">[ 4398.617637] </span><br><span class="line">               stack backtrace:</span><br><span class="line">[ 4398.621999] CPU: 19 PID: 156503 Comm: fio Kdump: loaded Not tainted 5.15.0-26-generic #26</span><br><span class="line">[ 4398.630170] Hardware name: Supermicro SYS-6029TP-H-EI012/X11DPT-PS-EI012, BIOS 1.0.9.0 01/31/2018</span><br><span class="line">[ 4398.639036] Call Trace:</span><br><span class="line">[ 4398.641488]  &lt;TASK&gt;</span><br><span class="line">[ 4398.643596]  dump_stack_lvl+0x6e/0x9c</span><br><span class="line">[ 4398.647284]  dump_stack+0x10/0x12</span><br><span class="line">[ 4398.650605]  print_usage_bug.part.0+0x18e/0x19d</span><br><span class="line">[ 4398.655138]  mark_lock_irq.cold+0x11/0x2c</span><br><span class="line">[ 4398.659151]  ? stack_trace_save+0x4c/0x70</span><br><span class="line">[ 4398.663164]  ? save_trace+0x45/0x2f0</span><br><span class="line">[ 4398.666742]  mark_lock.part.0+0x11f/0x220</span><br><span class="line">[ 4398.670756]  mark_held_locks+0x54/0x80</span><br><span class="line">[ 4398.674510]  ? adjust_inuse_and_calc_cost+0x164/0x2c0</span><br><span class="line">[ 4398.679563]  lockdep_hardirqs_on_prepare+0x7f/0x1c0</span><br><span class="line">[ 4398.680859] patch_est_timer: disagrees about version of symbol module_layout</span><br><span class="line">[ 4398.684449]  ? _raw_spin_unlock_irq+0x28/0x40</span><br><span class="line">[ 4398.695856]  trace_hardirqs_on+0x21/0xe0</span><br><span class="line">[ 4398.699791]  _raw_spin_unlock_irq+0x28/0x40</span><br><span class="line">[ 4398.703974]  adjust_inuse_and_calc_cost+0x164/0x2c0</span><br><span class="line">[ 4398.708858]  ioc_rqos_merge+0xef/0x280</span><br><span class="line">[ 4398.712608]  __rq_qos_merge+0x31/0x50</span><br><span class="line">[ 4398.716272]  bio_attempt_back_merge+0x63/0x160</span><br><span class="line">[ 4398.720722]  blk_mq_sched_try_merge+0x147/0x1d0</span><br><span class="line">[ 4398.725256]  bfq_bio_merge+0xe2/0x150 [bfq]</span><br><span class="line">[ 4398.729448]  __blk_mq_sched_bio_merge+0x36/0x1b0</span><br><span class="line">[ 4398.734069]  blk_mq_submit_bio+0xd5/0x900</span><br><span class="line">[ 4398.738082]  __submit_bio+0x307/0x340</span><br><span class="line">[ 4398.741746]  ? get_user_pages_fast+0x24/0x40</span><br><span class="line">[ 4398.746018]  ? iov_iter_get_pages+0xc6/0x400</span><br><span class="line">[ 4398.750292]  submit_bio_noacct+0x26c/0x2d0</span><br><span class="line">[ 4398.754393]  submit_bio+0x48/0x140</span><br><span class="line">[ 4398.757797]  iomap_dio_submit_bio+0x7c/0x90</span><br><span class="line">[ 4398.761983]  iomap_dio_bio_iter+0x2da/0x4b0</span><br><span class="line">[ 4398.766172]  __iomap_dio_rw+0x514/0x830</span><br><span class="line">[ 4398.770012]  iomap_dio_rw+0xe/0x30</span><br><span class="line">[ 4398.773413]  xfs_file_dio_write_aligned+0xb9/0x1a0 [xfs]</span><br><span class="line">[ 4398.778821]  ? sched_clock_cpu+0x12/0xe0</span><br><span class="line">[ 4398.782749]  xfs_file_write_iter+0x101/0x1a0 [xfs]</span><br><span class="line">[ 4398.787613]  aio_write+0x131/0x310</span><br><span class="line">[ 4398.791019]  ? __fget_files+0xcf/0x1c0</span><br><span class="line">[ 4398.794771]  __io_submit_one.constprop.0+0x43a/0x570</span><br><span class="line">[ 4398.799740]  ? __io_submit_one.constprop.0+0x43a/0x570</span><br><span class="line">[ 4398.804885]  ? sched_clock_cpu+0x12/0xe0</span><br><span class="line">[ 4398.808819]  ? io_submit_one+0xd9/0x870</span><br><span class="line">[ 4398.812671]  io_submit_one+0x142/0x870</span><br><span class="line">[ 4398.816429]  ? io_submit_one+0x142/0x870</span><br><span class="line">[ 4398.820373]  __x64_sys_io_submit+0x97/0x2a0</span><br><span class="line">[ 4398.824569]  ? syscall_trace_enter.isra.0+0x186/0x250</span><br><span class="line">[ 4398.829632]  do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 4398.833217]  ? __x64_sys_io_cancel+0x250/0x250</span><br><span class="line">[ 4398.837660]  ? do_syscall_64+0x5c/0xc0</span><br><span class="line">[ 4398.841412]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 4398.845165]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[ 4398.848921]  ? sysvec_call_function_single+0x4e/0x90</span><br><span class="line">[ 4398.853884]  ? asm_sysvec_call_function_single+0xa/0x20</span><br><span class="line">[ 4398.859110]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br><span class="line">[ 4398.864165] RIP: 0033:0x7fd43e139697</span><br><span class="line">[ 4398.867746] Code: 00 75 10 8b 47 0c 39 47 08 74 10 0f 1f 84 00 00 00 00 00 e9 bb ff ff ff 0f 1f 00 31 c0 c3 0f 1f 44 00 00 b8 d1 00 00 00 0f 05 &lt;c3&gt; 0f 1f 84 00 00 00 00 00 b8 d2 00 00 00 0f 05 c3 0f 1f 84 00 00</span><br><span class="line">[ 4398.886488] RSP: 002b:00007fd439a49cc8 EFLAGS: 00000202 ORIG_RAX: 00000000000000d1</span><br><span class="line">[ 4398.894057] RAX: ffffffffffffffda RBX: 00007fd43a24c000 RCX: 00007fd43e139697</span><br><span class="line">[ 4398.901187] RDX: 00007fd43400d530 RSI: 0000000000000001 RDI: 00007fd43eb24000</span><br><span class="line">[ 4398.908323] RBP: 00007fd43a24c000 R08: 00007fd43a7051f0 R09: 00000000000001f0</span><br><span class="line">[ 4398.915454] R10: 0000000004455000 R11: 0000000000000202 R12: 00007fd43400ccf0</span><br><span class="line">[ 4398.922587] R13: 00007fd43400d740 R14: 00007fd43400d530 R15: 00007fd43a251210</span><br><span class="line">[ 4398.929725]  &lt;/TASK&gt;</span><br></pre></td></tr></table></figure>



<p>Lock chain:</p>
<ol>
<li>bfq_bio_merge:</li>
</ol>
<p>​	spin_lock_irq(&amp;bfqd-&gt;lock);</p>
<p>​	blk_mq_sched_try_merge:</p>
<p>​		adjust_inuse_and_calc_cost:</p>
<p>​				spin_lock_irq(&amp;ioc-&gt;lock);</p>
<p>​				spin_unlock_irq(&amp;ioc-&gt;lock);</p>
<ol start="2">
<li>bfq_finish_requeue_request:</li>
</ol>
<p>​		spin_lock_irqsave(&amp;bfqd-&gt;lock, flags);</p>
<p>​		…</p>
<p>​		spin_unlock_irqrestore(&amp;bfqd-&gt;lock, flags);</p>
<p><img src="https://lh7-us.googleusercontent.com/bq2FPR6rf3vTi3qwBroUf_ukX2q8_kuRj8GbANgmURAwdcfd3c6QBivBGFvtvvADlqdTU4CbjvhIBrHzJefKR8UpE5WR7A0jZ7tFH5odAsfF8JjofHbi2vq8AFHgUT6cdfmcOxm0Tc0gyZCdXJGYfog" alt="img"></p>
<p>There is a process running on cpu and hold a lock spin_lock_irq(&amp;bfqd-&gt;lock), then the process to hold the second lock by spin_lock_irq(&amp;ioc-&gt;lock), after finish calculation, the process release the second lock spin_unlock_irq(&amp;ioc-&gt;lock), at this time the kernel allow irq, and a irq preempts the cpu and when run into function <em>bfq_finish_requeue_request,</em> it try to hold the first lock by spin_lock_irqsave(&amp;bfqd-&gt;lock, flags), but it is still hold by original process, so it is deadlock. The locked module can detect this case and reprot the risk into dmesg (stack 3). </p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>This kernel patch fix the issue in kernel 6.3.13 version:</p>
<p><em><a target="_blank" rel="noopener" href="https://lwn.net/Articles/937933/">https://lwn.net/Articles/937933/</a></em></p>
<p><a target="_blank" rel="noopener" href="https://www.spinics.net/lists/stable/msg669695.html"><em>https://www.spinics.net/lists/stable/msg669695.html</em></a></p>
<p>In this patch, the fix is using <em>spin_lock_irqsave</em> to replace <em>spin_lock_irq</em> in the function of “<em>adjust_inuse_and_calc_cost</em>” to block the irq when unlocked.</p>
<p>We will cherry-pick the patch into our 5.15 kernel.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/03/10/2018-10-12-raid/" rel="prev" title="raid">
                  <i class="fa fa-angle-left"></i> raid
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/03/10/2023-12-15-blktrace-block-io-lifecycle/" rel="next" title="blktrace block io lifecycle">
                  blktrace block io lifecycle <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
