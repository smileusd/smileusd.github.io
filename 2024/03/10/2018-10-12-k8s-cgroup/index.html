<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="问题:  k8s中cpu的request和limit中设置”0.5”和”100m”表示什么意思? 一个4核8线程的cpu, 设置cpu为”1”的limit实际的限制多少? cpu中request和limit使用上有什么区别? cgroup中是如何限制的?  Linux Cgroup众所周知, kubernetes和docker中对cpu, memory进行了使用限制, 用于内存和cpu的资源使用隔">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-cgroup">
<meta property="og:url" content="http://example.com/2024/03/10/2018-10-12-k8s-cgroup/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="问题:  k8s中cpu的request和limit中设置”0.5”和”100m”表示什么意思? 一个4核8线程的cpu, 设置cpu为”1”的limit实际的限制多少? cpu中request和limit使用上有什么区别? cgroup中是如何限制的?  Linux Cgroup众所周知, kubernetes和docker中对cpu, memory进行了使用限制, 用于内存和cpu的资源使用隔">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-03-10T04:35:02.953Z">
<meta property="article:modified_time" content="2024-03-10T04:35:02.953Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2024/03/10/2018-10-12-k8s-cgroup/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2024/03/10/2018-10-12-k8s-cgroup/","path":"2024/03/10/2018-10-12-k8s-cgroup/","title":"k8s-cgroup"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s-cgroup | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux-Cgroup"><span class="nav-number">1.</span> <span class="nav-text">Linux Cgroup</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90cgroup"><span class="nav-number">1.1.</span> <span class="nav-text">创建子cgroup</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cpu-subsystem"><span class="nav-number">1.2.</span> <span class="nav-text">cpu subsystem</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E4%BA%8B%E4%BE%8B"><span class="nav-number">1.3.</span> <span class="nav-text">运行事例:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6%E6%9C%BA%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">kubernetes 资源控制机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#K8s-Limits-Request-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">K8s Limits &amp; Request 代码分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%80%BC%E5%BE%97%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9"><span class="nav-number">3.</span> <span class="nav-text">值得注意的点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">4.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/10/2018-10-12-k8s-cgroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="k8s-cgroup | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s-cgroup
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-10 12:35:02" itemprop="dateCreated datePublished" datetime="2024-03-10T12:35:02+08:00">2024-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>问题:</p>
<ol>
<li>k8s中cpu的request和limit中设置”0.5”和”100m”表示什么意思?</li>
<li>一个4核8线程的cpu, 设置cpu为”1”的limit实际的限制多少?</li>
<li>cpu中request和limit使用上有什么区别?</li>
<li>cgroup中是如何限制的?</li>
</ol>
<h4 id="Linux-Cgroup"><a href="#Linux-Cgroup" class="headerlink" title="Linux Cgroup"></a>Linux Cgroup</h4><p>众所周知, kubernetes和docker中对cpu, memory进行了使用限制, 用于内存和cpu的资源使用隔离. 而底层使用的是linux cgroup技术. 内存比较简单, 本文主要讲cpu的cgroup.</p>
<p>在cgroup里面，跟CPU相关的子系统有<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v1/cpusets.txt">cpusets</a>、<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v1/cpuacct.txt">cpuacct</a>和<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt">cpu</a>。</p>
<p>其中cpuset主要用于设置CPU的亲和性，可以限制cgroup中的进程只能在指定的CPU上运行，或者不能在指定的CPU上运行，同时cpuset还能设置内存的亲和性。设置亲和性一般只在比较特殊的情况才用得着，所以这里不做介绍。</p>
<p>cpuacct包含当前cgroup所使用的CPU的统计信息，信息量较少，有兴趣可以去看看它的文档，这里不做介绍。</p>
<p>本篇只介绍<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu#sect-cfs">cpu子系统</a>，包括怎么限制cgroup的CPU使用上限及相对于其它cgroup的相对值。</p>
<h5 id="创建子cgroup"><a href="#创建子cgroup" class="headerlink" title="创建子cgroup"></a>创建子cgroup</h5><p>在ubuntu下，systemd已经帮我们mount好了cpu子系统，我们只需要在相应的目录下创建子目录就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#从这里的输出可以看到，cpuset被挂载在了/sys/fs/cgroup/cpuset，</span><br><span class="line">#而cpu和cpuacct一起挂载到了/sys/fs/cgroup/cpu,cpuacct下面</span><br><span class="line">dev@ubuntu:~$ mount|grep cpu</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line"></span><br><span class="line">#进入/sys/fs/cgroup/cpu,cpuacct并创建子cgroup</span><br><span class="line">dev@ubuntu:~$ cd /sys/fs/cgroup/cpu,cpuacct</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct$ sudo mkdir test</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct$ cd test</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ ls</span><br><span class="line">cgroup.clone_children  cpuacct.stat   cpuacct.usage_percpu  cpu.cfs_quota_us  cpu.stat           tasks</span><br><span class="line">cgroup.procs           cpuacct.usage  cpu.cfs_period_us     cpu.shares        notify_on_release</span><br></pre></td></tr></table></figure>

<p>我们只需要关注cpu.开头的文件</p>
<h5 id="cpu-subsystem"><a href="#cpu-subsystem" class="headerlink" title="cpu subsystem"></a>cpu subsystem</h5><p>cpu子系统调度cpu到cgroups中, 目前有两种调度策略:</p>
<ul>
<li><em>Completely Fair Scheduler (CFS)</em> —-将cpu时间划分成合适的份额, 按比例和权重分配给cgroup.cfs可以设置相对权重和绝对权重, 目前k8s用的是这个调度策略.</li>
<li><em>Real-Time scheduler (RT)</em> —RT调度器与CFS中的绝对权重控制相似, 不过仅用于实时任务. 可以在运行时进行实时调整参数.</li>
</ul>
<ol>
<li>Completely Fair Scheduler (CFS):</li>
</ol>
<ul>
<li><p>强制绝对控制参数:</p>
<p>cpu.cfs_period_us &amp; cpu.cfs_quota_us</p>
</li>
</ul>
<p> cfs_period_us用来配置时间周期长度，cfs_quota_us用来配置当前cgroup在设置的周期长度内所能使用的CPU时间数，两个文件配合起来设置CPU的使用上限。两个文件的单位都是微秒（us），cfs_period_us的取值范围为1毫秒（ms）到1秒（s），cfs_quota_us的取值大于1ms即可，如果cfs_quota_us的值为-1（默认值），表示不受cpu时间的限制。下面是几个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.限制只能使用1个CPU（每250ms能使用250ms的CPU时间）</span><br><span class="line">    # echo 250000 &gt; cpu.cfs_quota_us /* quota = 250ms */</span><br><span class="line">    # echo 250000 &gt; cpu.cfs_period_us /* period = 250ms */</span><br><span class="line"></span><br><span class="line">2.限制使用2个CPU（内核）（每500ms能使用1000ms的CPU时间，即使用两个内核）</span><br><span class="line">    # echo 1000000 &gt; cpu.cfs_quota_us /* quota = 1000ms */</span><br><span class="line">    # echo 500000 &gt; cpu.cfs_period_us /* period = 500ms */</span><br><span class="line"></span><br><span class="line">3.限制使用1个CPU的20%（每50ms能使用10ms的CPU时间，即使用一个CPU核心的20%）</span><br><span class="line">    # echo 10000 &gt; cpu.cfs_quota_us /* quota = 10ms */</span><br><span class="line">    # echo 50000 &gt; cpu.cfs_period_us /* period = 50ms */</span><br></pre></td></tr></table></figure>

<p> cpu.stat:</p>
<p>包含了下面三项统计结果</p>
<ul>
<li>nr_periods： 表示过去了多少个cpu.cfs_period_us里面配置的时间周期</li>
<li>nr_throttled： 在上面的这些周期中，有多少次是受到了限制（即cgroup中的进程在指定的时间周期中用光了它的配额）</li>
<li>throttled_time: cgroup中的进程被限制使用CPU持续了多长时间(纳秒)</li>
<li>相对控制参数: cpu.shares</li>
</ul>
<p>shares用来设置CPU的相对值，并且是针对所有的CPU（内核），默认值是1024，假如系统中有两个cgroup，分别是A和B，A的shares值是1024，B的shares值是512，那么A将获得1024&#x2F;(1204+512)&#x3D;66%的CPU资源，而B将获得33%的CPU资源。shares有两个特点：</p>
<ul>
<li>如果A不忙，没有使用到66%的CPU时间，那么剩余的CPU时间将会被系统分配给B，即B的CPU使用率可以超过33%</li>
<li>如果添加了一个新的cgroup C，且它的shares值是1024，那么A的限额变成了1024&#x2F;(1204+512+1024)&#x3D;40%，B的变成了20%</li>
</ul>
<p>从上面两个特点可以看出：</p>
<ul>
<li>在闲的时候，shares基本上不起作用，只有在CPU忙的时候起作用，这是一个优点。</li>
<li>由于shares是一个绝对值，需要和其它cgroup的值进行比较才能得到自己的相对限额，而在一个部署很多容器的机器上，cgroup的数量是变化的，所以这个限额也是变化的，自己设置了一个高的值，但别人可能设置了一个更高的值，所以这个功能没法精确的控制CPU使用率。</li>
</ul>
<ol start="2">
<li>Real-Time scheduler (RT):</li>
</ol>
<p>cpu.rt_period_us: 周期时间, us, 同cfs</p>
<p>cpu.rt_runtime_us: 最长持续周期, us. 例如设置rt_runtime_us &#x3D; 200000, rt_period_us &#x3D; 1000000, 这就是说如果node有2cpu, 那么每秒钟占用时间就是2*0.2 &#x3D; 0.4s. 这个也是绝对时间.</p>
<h5 id="运行事例"><a href="#运行事例" class="headerlink" title="运行事例:"></a>运行事例:</h5><p>以cfs为例.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#继续使用上面创建的子cgroup： test</span><br><span class="line">#设置只能使用1个cpu的20%的时间</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 50000 &gt; cpu.cfs_period_us&quot;</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 10000 &gt; cpu.cfs_quota_us&quot;</span><br><span class="line"></span><br><span class="line">#将当前bash加入到该cgroup</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ echo $$</span><br><span class="line">5456</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ sudo sh -c &quot;echo 5456 &gt; cgroup.procs&quot;</span><br><span class="line"></span><br><span class="line">#在bash中启动一个死循环来消耗cpu，正常情况下应该使用100%的cpu（即消耗一个内核）</span><br><span class="line">dev@ubuntu:/sys/fs/cgroup/cpu,cpuacct/test$ while :; do echo test &gt; /dev/null; done</span><br><span class="line"></span><br><span class="line">#--------------------------重新打开一个shell窗口----------------------</span><br><span class="line">#通过top命令可以看到5456的CPU使用率为20%左右，说明被限制住了</span><br><span class="line">#不过这时系统的%us+%sy在10%左右，那是因为我测试的机器上cpu是双核的，</span><br><span class="line">#所以系统整体的cpu使用率为10%左右</span><br><span class="line">dev@ubuntu:~$ top</span><br><span class="line">Tasks: 139 total,   2 running, 137 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  5.6 us,  6.2 sy,  0.0 ni, 88.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :   499984 total,    15472 free,    81488 used,   403024 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.   383332 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 5456 dev       20   0   22640   5472   3524 R  20.3  1.1   0:04.62 bash</span><br><span class="line"></span><br><span class="line">#这时可以看到被限制的统计结果</span><br><span class="line">dev@ubuntu:~$ cat /sys/fs/cgroup/cpu,cpuacct/test/cpu.stat</span><br><span class="line">nr_periods 1436</span><br><span class="line">nr_throttled 1304</span><br><span class="line">throttled_time 51542291833</span><br></pre></td></tr></table></figure>

<h4 id="kubernetes-资源控制机制"><a href="#kubernetes-资源控制机制" class="headerlink" title="kubernetes 资源控制机制"></a>kubernetes 资源控制机制</h4><p>kubernetes使用runc作为runtime, runc中通过cpuGroup对cpu子系统的的调度进行设置. 其中Set()用于初始设置, Apply()方法用于动态更改设置, . 原理就是往上述的指定文件写入相应条目和数字. 没有什么可说的.</p>
<p>内存的Set():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">func (s *MemoryGroup) Set(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">	if err := setMemoryAndSwap(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.KernelMemory != 0 &#123;</span><br><span class="line">		if err := setKernelMemory(path, cgroup.Resources.KernelMemory); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.MemoryReservation != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.soft_limit_in_bytes&quot;, strconv.FormatInt(cgroup.Resources.MemoryReservation, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if cgroup.Resources.KernelMemoryTCP != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.kmem.tcp.limit_in_bytes&quot;, strconv.FormatInt(cgroup.Resources.KernelMemoryTCP, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.OomKillDisable &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.oom_control&quot;, &quot;1&quot;); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.MemorySwappiness == nil || int64(*cgroup.Resources.MemorySwappiness) == -1 &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125; else if *cgroup.Resources.MemorySwappiness &lt;= 100 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;memory.swappiness&quot;, strconv.FormatUint(*cgroup.Resources.MemorySwappiness, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		return fmt.Errorf(&quot;invalid value:%d. valid memory swappiness range is 0-100&quot;, *cgroup.Resources.MemorySwappiness)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内存Apply():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (s *MemoryGroup) Apply(d *cgroupData) (err error) &#123;</span><br><span class="line">	path, err := d.path(&quot;memory&quot;)</span><br><span class="line">	if err != nil &amp;&amp; !cgroups.IsNotFound(err) &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125; else if path == &quot;&quot; &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	if memoryAssigned(d.config) &#123;</span><br><span class="line">		if _, err := os.Stat(path); os.IsNotExist(err) &#123;</span><br><span class="line">			if err := os.MkdirAll(path, 0755); err != nil &#123;</span><br><span class="line">				return err</span><br><span class="line">			&#125;</span><br><span class="line">			// 只有内核内存可以动态设置</span><br><span class="line">			if err := EnableKernelMemoryAccounting(path); err != nil &#123;</span><br><span class="line">				return err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func EnableKernelMemoryAccounting(path string) error &#123;</span><br><span class="line">	// Check if kernel memory is enabled</span><br><span class="line">	// We have to limit the kernel memory here as it won&#x27;t be accounted at all</span><br><span class="line">	// until a limit is set on the cgroup and limit cannot be set once the</span><br><span class="line">	// cgroup has children, or if there are already tasks in the cgroup.</span><br><span class="line">	for _, i := range []int64&#123;1, -1&#125; &#123;</span><br><span class="line">		if err := setKernelMemory(path, i); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpu的Set():</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func (s *CpuGroup) Set(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">    // 设置CFS </span><br><span class="line">	if cgroup.Resources.CpuShares != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.shares&quot;, strconv.FormatUint(cgroup.Resources.CpuShares, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuPeriod != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.cfs_period_us&quot;, strconv.FormatUint(cgroup.Resources.CpuPeriod, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuQuota != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.cfs_quota_us&quot;, strconv.FormatInt(cgroup.Resources.CpuQuota, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	// 设置RT</span><br><span class="line">	if err := s.SetRtSched(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *CpuGroup) SetRtSched(path string, cgroup *configs.Cgroup) error &#123;</span><br><span class="line">	if cgroup.Resources.CpuRtPeriod != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.rt_period_us&quot;, strconv.FormatUint(cgroup.Resources.CpuRtPeriod, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if cgroup.Resources.CpuRtRuntime != 0 &#123;</span><br><span class="line">		if err := writeFile(path, &quot;cpu.rt_runtime_us&quot;, strconv.FormatInt(cgroup.Resources.CpuRtRuntime, 10)); err != nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpu的Apply() 只能设置RT:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (s *CpuGroup) Apply(d *cgroupData) error &#123;</span><br><span class="line">	// We always want to join the cpu group, to allow fair cpu scheduling</span><br><span class="line">	// on a container basis</span><br><span class="line">	path, err := d.path(&quot;cpu&quot;)</span><br><span class="line">	if err != nil &amp;&amp; !cgroups.IsNotFound(err) &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	return s.ApplyDir(path, d.config, d.pid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *CpuGroup) ApplyDir(path string, cgroup *configs.Cgroup, pid int) error &#123;</span><br><span class="line">	// This might happen if we have no cpu cgroup mounted.</span><br><span class="line">	// Just do nothing and don&#x27;t fail.</span><br><span class="line">	if path == &quot;&quot; &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	if err := os.MkdirAll(path, 0755); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	// We should set the real-Time group scheduling settings before moving</span><br><span class="line">	// in the process because if the process is already in SCHED_RR mode</span><br><span class="line">	// and no RT bandwidth is set, adding it will fail.</span><br><span class="line">	if err := s.SetRtSched(path, cgroup); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line">	// because we are not using d.join we need to place the pid into the procs file</span><br><span class="line">	// unlike the other subsystems</span><br><span class="line">	if err := cgroups.WriteCgroupProc(path, pid); err != nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="K8s-Limits-Request-代码分析"><a href="#K8s-Limits-Request-代码分析" class="headerlink" title="K8s Limits &amp; Request 代码分析"></a>K8s Limits &amp; Request 代码分析</h5><p>k8s中管理cgroup的结构体在k8s.io&#x2F;kubernetes&#x2F;pkg&#x2F;kubelet&#x2F;cm&#x2F;cgroup_manager_linux.go中:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// cgroupManagerImpl implements the CgroupManager interface.</span><br><span class="line">// Its a stateless object which can be used to</span><br><span class="line">// update,create or delete any number of cgroups</span><br><span class="line">// It uses the Libcontainer raw fs cgroup manager for cgroup management.</span><br><span class="line">type cgroupManagerImpl struct &#123;</span><br><span class="line">	// subsystems holds information about all the</span><br><span class="line">	// mounted cgroup subsystems on the node</span><br><span class="line">	subsystems *CgroupSubsystems</span><br><span class="line">	// simplifies interaction with libcontainer and its cgroup managers</span><br><span class="line">	adapter *libcontainerAdapter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看下Update方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// Update updates the cgroup with the specified Cgroup Configuration</span><br><span class="line">func (m *cgroupManagerImpl) Update(cgroupConfig *CgroupConfig) error &#123;</span><br><span class="line">	...</span><br><span class="line">	// 提取cgroup资源参数</span><br><span class="line">	resourceConfig := cgroupConfig.ResourceParameters</span><br><span class="line">	resources := m.toResources(resourceConfig)</span><br><span class="line"></span><br><span class="line">	cgroupPaths := m.buildCgroupPaths(cgroupConfig.Name)</span><br><span class="line"></span><br><span class="line">	// 获得cgroupfs的位置.</span><br><span class="line">	abstractCgroupFsName := string(cgroupConfig.Name)</span><br><span class="line">	abstractParent := CgroupName(path.Dir(abstractCgroupFsName))</span><br><span class="line">	abstractName := CgroupName(path.Base(abstractCgroupFsName))</span><br><span class="line"></span><br><span class="line">	driverParent := m.adapter.adaptName(abstractParent, false)</span><br><span class="line">	driverName := m.adapter.adaptName(abstractName, false)</span><br><span class="line"></span><br><span class="line">	// 获取systemd的绝对位置</span><br><span class="line">	if m.adapter.cgroupManagerType == libcontainerSystemd &#123;</span><br><span class="line">		driverName = m.adapter.adaptName(cgroupConfig.Name, false)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 初始化cgroup配置</span><br><span class="line">	libcontainerCgroupConfig := &amp;libcontainerconfigs.Cgroup&#123;</span><br><span class="line">		Name:      driverName,</span><br><span class="line">		Parent:    driverParent,</span><br><span class="line">		Resources: resources,</span><br><span class="line">		Paths:     cgroupPaths,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    // 设置cgroup配置</span><br><span class="line">	if err := setSupportedSubsystems(libcontainerCgroupConfig); err != nil &#123;</span><br><span class="line">		return fmt.Errorf(&quot;failed to set supported cgroup subsystems for cgroup %v: %v&quot;, cgroupConfig.Name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看下参数是如何提取的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func (m *cgroupManagerImpl) toResources(resourceConfig *ResourceConfig) *libcontainerconfigs.Resources &#123;</span><br><span class="line">	resources := &amp;libcontainerconfigs.Resources&#123;&#125;</span><br><span class="line">	if resourceConfig == nil &#123;</span><br><span class="line">		return resources</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.Memory != nil &#123;</span><br><span class="line">		resources.Memory = *resourceConfig.Memory</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuShares != nil &#123;</span><br><span class="line">		resources.CpuShares = *resourceConfig.CpuShares</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuQuota != nil &#123;</span><br><span class="line">		resources.CpuQuota = *resourceConfig.CpuQuota</span><br><span class="line">	&#125;</span><br><span class="line">	if resourceConfig.CpuPeriod != nil &#123;</span><br><span class="line">		resources.CpuPeriod = *resourceConfig.CpuPeriod</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// huge page参数提取, 略过</span><br><span class="line">	if utilfeature.DefaultFeatureGate.Enabled(kubefeatures.HugePages) &#123;</span><br><span class="line">    ...</span><br><span class="line">	return resources</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在来看看CpuShare, CpuQuota, 和CpuPeriod都来字哪里:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// ResourceConfigForPod takes the input pod and outputs the cgroup resource config.</span><br><span class="line">func ResourceConfigForPod(pod *v1.Pod) *ResourceConfig &#123;</span><br><span class="line">	// sum requests and limits.</span><br><span class="line">	reqs, limits := resource.PodRequestsAndLimits(pod)</span><br><span class="line"></span><br><span class="line">	cpuRequests := int64(0)</span><br><span class="line">	cpuLimits := int64(0)</span><br><span class="line">	memoryLimits := int64(0)</span><br><span class="line">	if request, found := reqs[v1.ResourceCPU]; found &#123;</span><br><span class="line">		cpuRequests = request.MilliValue()</span><br><span class="line">	&#125;</span><br><span class="line">	if limit, found := limits[v1.ResourceCPU]; found &#123;</span><br><span class="line">		cpuLimits = limit.MilliValue()</span><br><span class="line">	&#125;</span><br><span class="line">	if limit, found := limits[v1.ResourceMemory]; found &#123;</span><br><span class="line">		memoryLimits = limit.Value()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// convert to CFS values</span><br><span class="line">	cpuShares := MilliCPUToShares(cpuRequests)</span><br><span class="line">	cpuQuota, cpuPeriod := MilliCPUToQuota(cpuLimits)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MilliCPUToShares converts the milliCPU to CFS shares.</span><br><span class="line">func MilliCPUToShares(milliCPU int64) uint64 &#123;</span><br><span class="line">	if milliCPU == 0 &#123;</span><br><span class="line">		// Docker converts zero milliCPU to unset, which maps to kernel default</span><br><span class="line">		// for unset: 1024. Return 2 here to really match kernel default for</span><br><span class="line">		// zero milliCPU.</span><br><span class="line">		return MinShares</span><br><span class="line">	&#125;</span><br><span class="line">	// Conceptually (milliCPU / milliCPUToCPU) * sharesPerCPU, but factored to improve rounding.</span><br><span class="line">	shares := (milliCPU * SharesPerCPU) / MilliCPUToCPU</span><br><span class="line">	if shares &lt; MinShares &#123;</span><br><span class="line">		return MinShares</span><br><span class="line">	&#125;</span><br><span class="line">	return uint64(shares)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// MilliCPUToQuota converts milliCPU to CFS quota and period values.</span><br><span class="line">func MilliCPUToQuota(milliCPU int64) (quota int64, period uint64) &#123;</span><br><span class="line">	// CFS quota is measured in two values:</span><br><span class="line">	//  - cfs_period_us=100ms (the amount of time to measure usage across)</span><br><span class="line">	//  - cfs_quota=20ms (the amount of cpu time allowed to be used across a period)</span><br><span class="line">	// so in the above example, you are limited to 20% of a single CPU</span><br><span class="line">	// for multi-cpu environments, you just scale equivalent amounts</span><br><span class="line"></span><br><span class="line">	if milliCPU == 0 &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// we set the period to 100ms by default</span><br><span class="line">	period = QuotaPeriod</span><br><span class="line"></span><br><span class="line">	// we then convert your milliCPU to a value normalized over a period</span><br><span class="line">	quota = (milliCPU * QuotaPeriod) / MilliCPUToCPU</span><br><span class="line"></span><br><span class="line">	// quota needs to be a minimum of 1ms.</span><br><span class="line">	if quota &lt; MinQuotaPeriod &#123;</span><br><span class="line">		quota = MinQuotaPeriod</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	// Taken from lmctfy https://github.com/google/lmctfy/blob/master/lmctfy/controllers/cpu_controller.cc</span><br><span class="line">	MinShares     = 2</span><br><span class="line">	SharesPerCPU  = 1024</span><br><span class="line">	MilliCPUToCPU = 1000</span><br><span class="line"></span><br><span class="line">	// 100000 is equivalent to 100ms</span><br><span class="line">	QuotaPeriod    = 100000</span><br><span class="line">	MinQuotaPeriod = 1000</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>设置的代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func setSupportedSubsystems(cgroupConfig *libcontainerconfigs.Cgroup) error &#123;</span><br><span class="line">	for _, sys := range getSupportedSubsystems() &#123;</span><br><span class="line">		if _, ok := cgroupConfig.Paths[sys.Name()]; !ok &#123;</span><br><span class="line">			return fmt.Errorf(&quot;Failed to find subsystem mount for subsystem: %v&quot;, sys.Name())</span><br><span class="line">		&#125;</span><br><span class="line">        // 调用前面的cgroup.Set()方法</span><br><span class="line">		if err := sys.Set(cgroupConfig.Paths[sys.Name()], cgroupConfig); err != nil &#123;</span><br><span class="line">			return fmt.Errorf(&quot;Failed to set config for supported subsystems : %v&quot;, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码很明显了:</p>
<p>Request -&gt; cpu.shares</p>
<p>Limits -&gt; cpu.quota(CFS或者RT)</p>
<p>QuotaPeriod 为100ms</p>
<p>所以当Request设置0.5(0.5 <em>1024&#x3D;512), 等价于设置500m(500</em> 1024&#x2F;1000&#x3D;512), 也就是512.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.shares </span><br><span class="line">512</span><br></pre></td></tr></table></figure>

<p>当Limit设置1(1 <em>1000</em> 100000&#x2F;1000&#x3D;100000), 等价于1000m(1000 * 100000 &#x2F; 1000 &#x3D; 100000 ), 也就是quota&#x3D;100000, period&#x3D;100000.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.cfs_quota_us </span><br><span class="line">100000</span><br><span class="line">[root@tdc-tester04 ~]# cat /sys/fs/cgroup/cpu/kubepods/burstable/pod4de91174-9002-11e8-a663-ac1f6b83dd66/1cbc69fd7756efdcba38d11a57acab5cdbe0b9b2e5eef2a9e86e3c6c8850b1a1/cpu.cfs_period_us </span><br><span class="line">100000</span><br></pre></td></tr></table></figure>

<p>至此所有路走通.</p>
<h4 id="值得注意的点"><a href="#值得注意的点" class="headerlink" title="值得注意的点"></a>值得注意的点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The CPU resource is measured in cpu units. One cpu, in Kubernetes, is equivalent to:</span><br><span class="line"></span><br><span class="line">    1 AWS vCPU</span><br><span class="line">    1 GCP Core</span><br><span class="line">    1 Azure vCore</span><br><span class="line">    1 Hyperthread on a bare-metal Intel processor with Hyperthreading</span><br></pre></td></tr></table></figure>

<p>从文档来看所以4核8线程对k8s来讲就是8核.</p>
<p>如果只设置了request没有设置limit, 意味着一个pod可以任意使用node资源, 如果没有其他pod创建. 如果集群管理员设置了<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#limitrange-v1-core/">LimitRange</a>, 那么当pod没有设置limit的时候就会使用LimitRange里设置的值作为默认.</p>
<h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><ol>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#what-if-you-specify-a-container-s-request-but-not-its-limit">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#what-if-you-specify-a-container-s-request-but-not-its-limit</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008323952">https://segmentfault.com/a/1190000008323952</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/03/10/2018-06-29-use-operator-sdk/" rel="prev" title="operator-framework的使用和调查">
                  <i class="fa fa-angle-left"></i> operator-framework的使用和调查
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/03/10/2018-10-12-docker-start-failed/" rel="next" title="docker-start-failed">
                  docker-start-failed <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
