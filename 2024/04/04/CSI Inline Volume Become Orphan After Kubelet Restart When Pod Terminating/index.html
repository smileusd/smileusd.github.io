<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="CSI Inline Volume Become Orphan After Kubelet Restart When Pod Terminating ProblemProblem When the pod is terminating and csi inline volume is deleted, the kubelet down or restart impact the volume be">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2024/04/04/CSI%20Inline%20Volume%20Become%20Orphan%20After%20Kubelet%20Restart%20When%20Pod%20Terminating/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="CSI Inline Volume Become Orphan After Kubelet Restart When Pod Terminating ProblemProblem When the pod is terminating and csi inline volume is deleted, the kubelet down or restart impact the volume be">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-04-04T05:32:27.363Z">
<meta property="article:modified_time" content="2024-04-04T05:32:27.364Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2024/04/04/CSI%20Inline%20Volume%20Become%20Orphan%20After%20Kubelet%20Restart%20When%20Pod%20Terminating/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2024/04/04/CSI%20Inline%20Volume%20Become%20Orphan%20After%20Kubelet%20Restart%20When%20Pod%20Terminating/","path":"2024/04/04/CSI Inline Volume Become Orphan After Kubelet Restart When Pod Terminating/","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Problem"><span class="nav-number">1.</span> <span class="nav-text">Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution"><span class="nav-number">2.</span> <span class="nav-text">Solution</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/04/CSI%20Inline%20Volume%20Become%20Orphan%20After%20Kubelet%20Restart%20When%20Pod%20Terminating/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-04 13:32:27" itemprop="dateCreated datePublished" datetime="2024-04-04T13:32:27+08:00">2024-04-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>CSI Inline Volume Become Orphan After Kubelet Restart When Pod Terminating</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Problem</p>
<p>When the pod is terminating and csi inline volume is deleted, the kubelet down or restart impact the volume become orphan and pod skip delete and unmount the volume. The error message show as follow:</p>
<p>Mar 12 00:28:56 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526549]: I0312 00:28:56.150307 1526549 state_mem.go:36] “Initialized new in-memory state store”Mar 12 00:28:56 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526549]: E0312 00:28:56.153369 1526549 server.go:302] “Failed to run kubelet” err&#x3D;”failed to run Kubelet: unable to determine runtime API version: rpc error: code &#x3D; Unknown desc &#x3D; server is not initialized yet”Mar 12 00:28:56 tess-node-kltc4-tess19.stratus.lvs.ebay.com systemd[1]: kubelet.service: Main process exited, code&#x3D;exited, status&#x3D;1&#x2F;FAILUREMar 12 00:28:56 tess-node-kltc4-tess19.stratus.lvs.ebay.com systemd[1]: kubelet.service: Failed with result ‘exit-code’.Mar 12 00:28:58 tess-node-kltc4-tess19.stratus.lvs.ebay.com systemd[1]: kubelet.service: Scheduled restart job, restart counter is at 1.**Mar 12 00:28:58 tess-node-kltc4-tess19.stratus.lvs.ebay.com systemd[1]: Stopped Kubernetes Kubelet Server.**<strong>Mar 12 00:28:58 tess-node-kltc4-tess19.stratus.lvs.ebay.com systemd[1]: Started Kubernetes Kubelet Server.</strong>…Mar 12 00:29:01 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: I0312 00:29:01.976957 1526901 reconciler.go:388] **”Could not construct volume information, cleaning up mounts” podName&#x3D;1517b38e-fa84-4138-b6c0-06663741e385 volumeSpecName&#x3D;”data” err&#x3D;”failed to GetVolumeName from volumePlugin for volumeSpec &quot;data&quot; err&#x3D;kubernetes.io&#x2F;csi: plugin.GetVolumeName failed to extract volume source from spec: unexpected api.CSIVolumeSource found in volume.Spec”**Mar 12 00:29:01 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: I0312 00:29:01.976982 1526901 reconciler.go:421] <strong>“Reconciler sync states: could not find volume information in desired state, clean up the mount points”</strong> podName&#x3D;1517b38e-fa84-4138-b6c0-06663741e385 volumeSpecName&#x3D;”data”Mar 12 00:29:01 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: E0312 00:29:01.981982 1526901 operation_generator.go:952] UnmountVolume.MarkVolumeMountAsUncertain failed for volume “” (UniqueName: “data”) pod “1517b38e-fa84-4138-b6c0-06663741e385” (UID: “1517b38e-fa84-4138-b6c0-06663741e385”) : no volume with the name “data” exists in the list of attached volumesMar 12 00:29:01 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: E0312 00:29:01.982029 1526901 nestedpendingoperations.go:335] Operation for “{volumeName:data podName:1517b38e-fa84-4138-b6c0-06663741e385 nodeName:}” failed. No retries permitted until 2024-03-12 00:29:02.482017035 -0700 -07 m&#x3D;+1.794257422 (durationBeforeRetry 500ms). Error: UnmountVolume.TearDown failed for volume “” (UniqueName: “data”) pod “1517b38e-fa84-4138-b6c0-06663741e385” (UID: “1517b38e-fa84-4138-b6c0-06663741e385”) : kubernetes.io&#x2F;csi: Unmounter.TearDownAt failed: rpc error: code &#x3D; Aborted desc &#x3D; NodeUnpublish operation for volume csi-c6b0a910c881c66f817829d6c0815f60d2dee9c028369214c6f1224be8139978 still ongoingMar 12 00:29:44 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: I0312 00:29:44.655173 1526901 kubelet.go:2126] “SyncLoop DELETE” source&#x3D;”api” pods&#x3D;[kube-system&#x2F;fio-test-6b7df68464-r66bv]Mar 12 00:29:44 tess-node-kltc4-tess19.stratus.lvs.ebay.com kubelet[1526901]: I0312 00:29:44.658223 1526901 kubelet.go:2120] “SyncLoop REMOVE” source&#x3D;”api” pods&#x3D;[kube-system&#x2F;fio-test-6b7df68464-r66bv]</p>
<p>From the error messages, we can know what happened:</p>
<p> Kubelet restart  -&gt; reconstructVolume   -&gt; get csi volume plugin by FindAttachablePluginByName and FindDeviceMountablePluginByName     -&gt; util.GetUniqueVolumeNameFromSpec      -&gt; volumePlugin.GetVolumeName       -&gt; getPVSourceFromSpec         -&gt; get error “unexpected api.CSIVolumeSource found in volume.Spec” because this function only check CSIPersistentVolumeSource</p>
<p>When reconstructVolume gets an error, the volume can not be added into the ActualStateOfWorld in kubelet, then the kubelet will skip this volume unmount when pod deleting.</p>
<p>​	reconstructedVolume, err :&#x3D; rc.<strong>reconstructVolume</strong>(volume)		if err !&#x3D; nil {			if <strong>volumeInDSW</strong> {				&#x2F;&#x2F; Some pod needs the volume, don’t clean it up and hope that				&#x2F;&#x2F; reconcile() calls SetUp and reconstructs the volume in ASW.				klog.V(4).InfoS(“Volume exists in desired state, skip cleaning up mounts”, “podName”, volume.podName, “volumeSpecName”, volume.volumeSpecName)				continue			}			&#x2F;&#x2F; No pod needs the volume.			klog.InfoS(“Could not construct volume information, cleaning up mounts”, “podName”, volume.podName, “volumeSpecName”, volume.volumeSpecName, “err”, err)			rc.<strong>cleanupMounts</strong>(volume)			continue		} </p>
<p>So there is a bug that the csi ephemeral volume should go into <strong>‘GetUniqueVolumeNameFromSpecWithPod’</strong> not <strong>‘GetUniqueVolumeNameFromSpec’.</strong> That means csi ephemeral volume <strong>should not</strong> get the attachablePlugin and deviceMountablePlugin.</p>
<p>​	if attachablePlugin !&#x3D; nil || deviceMountablePlugin !&#x3D; nil {		uniqueVolumeName, err &#x3D; util.<strong>GetUniqueVolumeNameFromSpec</strong>(plugin, volumeSpec)		if err !&#x3D; nil {			return nil, err		}	} else {		uniqueVolumeName &#x3D; util.<strong>GetUniqueVolumeNameFromSpecWithPod</strong>(volume.podName, plugin, volumeSpec)	}</p>
<p>This place should use <code>*FindDeviceMountablePluginBySpec*</code> not <code>*FindAttachablePluginByName*</code> to get the volume plugin:</p>
<p>​	attachablePlugin, err :&#x3D; rc.volumePluginMgr.<strong>FindAttachablePluginByName</strong>(volume.pluginName)	if err !&#x3D; nil {		return nil, err	}	deviceMountablePlugin, err :&#x3D; rc.volumePluginMgr.<strong>FindDeviceMountablePluginByName</strong>(volume.pluginName)	if err !&#x3D; nil {		return nil, err	} </p>
<p>Actually, due to pod is terminating and pod not added into the DSW, when reconstructVolume failed, the kubelet still try to unmount and clean mountpoint for this volume:</p>
<p>func (dswp *desiredStateOfWorldPopulator) findAndAddNewPods() {	&#x2F;&#x2F; Map unique pod name to outer volume name to MountedVolume.	mountedVolumesForPod :&#x3D; make(map[volumetypes.UniquePodName]map[string]cache.MountedVolume)	if utilfeature.DefaultFeatureGate.Enabled(features.ExpandInUsePersistentVolumes) {		for _, mountedVolume :&#x3D; range dswp.actualStateOfWorld.GetMountedVolumes() {			mountedVolumes, exist :&#x3D; mountedVolumesForPod[mountedVolume.PodName]			if !exist {				mountedVolumes &#x3D; make(map[string]cache.MountedVolume)				mountedVolumesForPod[mountedVolume.PodName] &#x3D; mountedVolumes			}			mountedVolumes[mountedVolume.OuterVolumeSpecName] &#x3D; mountedVolume		}	} 	processedVolumesForFSResize :&#x3D; sets.NewString()	for _, pod :&#x3D; range dswp.podManager.GetPods() {		if dswp.podStateProvider.<strong>ShouldPodContainersBeTerminating</strong>(pod.UID) {			&#x2F;&#x2F; Do not (re)add volumes for pods that can’t also be starting containers			continue		}		dswp.<strong>processPodVolumes</strong>(pod, mountedVolumesForPod, processedVolumesForFSResize)	}  func (rc *reconciler) cleanupMounts(volume podVolume) {	klog.V(2).InfoS(“Reconciler sync states: could not find volume information in desired state, clean up the mount points”, “podName”, volume.podName, “volumeSpecName”, volume.volumeSpecName)	mountedVolume :&#x3D; operationexecutor.MountedVolume{		PodName:       volume.podName,		VolumeName:     v1.UniqueVolumeName(volume.volumeSpecName),		InnerVolumeSpecName: volume.volumeSpecName,		PluginName:     volume.pluginName,		PodUID:       types.UID(volume.podName),	}	&#x2F;&#x2F; TODO: Currently cleanupMounts only includes UnmountVolume operation. In the next PR, we will add	&#x2F;&#x2F; to unmount both volume and device in the same routine.	err :&#x3D; rc.operationExecutor.<strong>UnmountVolume</strong>(mountedVolume, rc.actualStateOfWorld, rc.kubeletPodsDir)	if err !&#x3D; nil {		klog.ErrorS(err, mountedVolume.GenerateErrorDetailed(“volumeHandler.UnmountVolumeHandler for UnmountVolume failed”, err).Error())		return	}} </p>
<p>But in this time, the container was not finished the container termination, so the volume remove failed, this is the last chance to recycle the volume:</p>
<p>[CSI local driver]2024&#x2F;03&#x2F;29 03:10:59 logging.go:26: Serving &#x2F;csi.v1.Node&#x2F;NodeUnpublishVolume: req&#x3D;volume_id:”csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11” target_path:”&#x2F;var&#x2F;mnt&#x2F;kubelet&#x2F;pods&#x2F;8c76f1db-b963-4cfc-96b7-6f81fd9781f6&#x2F;volumes&#x2F;kubernetes.io~csi&#x2F;data&#x2F;mount” [CSI local driver]2024&#x2F;03&#x2F;29 03:10:59 server.go:1111: Looking up volume with id&#x3D;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11[CSI local driver]2024&#x2F;03&#x2F;29 03:10:59 lvm.go:830: Executing: &#x2F;usr&#x2F;sbin&#x2F;lvs –reportformat&#x3D;json –units&#x3D;b –nosuffix –options&#x3D;lv_name,lv_size,vg_name,lv_path vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11         {“lv_name”:”vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”, “lv_size”:”21474836480”, “vg_name”:”vg10000”, “lv_path”:”&#x2F;dev&#x2F;vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”}[CSI local driver]2024&#x2F;03&#x2F;29 03:11:03 server.go:1139: Removing volume with id&#x3D;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11[CSI local driver]2024&#x2F;03&#x2F;29 03:11:03 lvm.go:830: Executing: &#x2F;usr&#x2F;sbin&#x2F;lvs –reportformat&#x3D;json –units&#x3D;b –nosuffix –options&#x3D;lv_name,lv_size,vg_name,lv_path vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11         {“lv_name”:”vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”, “lv_size”:”21474836480”, “vg_name”:”vg10000”, “lv_path”:”&#x2F;dev&#x2F;vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”}2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StdoutBuf - “Calling mkfs”2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StderrBuf - “mke2fs 1.45.5 (07-Jan-2020)”2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StderrBuf - “&#x2F;dev&#x2F;vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11 is apparently in use by the system; will not make a filesystem here!”2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StdoutBuf - “Calling wipefs”2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StderrBuf - “wipefs: error: &#x2F;dev&#x2F;vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11: probing initialization failed: Device or resource busy”2024&#x2F;03&#x2F;29 03:11:09 Cleanup lv “vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11”: StdoutBuf - “Quick reset completed”[CSI local driver]2024&#x2F;03&#x2F;29 03:11:09 lvm.go:830: Executing: &#x2F;usr&#x2F;sbin&#x2F;lvremove -f vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11[CSI local driver]2024&#x2F;03&#x2F;29 03:11:18 lvm.go:837: stderr: Logical volume vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11 contains a filesystem in use.[CSI local driver]2024&#x2F;03&#x2F;29 03:11:18 logging.go:30: &#x2F;csi.v1.Node&#x2F;NodeUnpublishVolume failed: err&#x3D;rpc error: code &#x3D; Internal desc &#x3D; rpc error: code &#x3D; Internal desc &#x3D; Failed to remove volume: Failed to lvremove lv vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11: Logical volume vg10000&#x2F;vg10000_csi-17ef0134f9c76245a954e751a3ebdb57a965d6cf5ea66a6f19bc4b6aa37bad11 contains a filesystem in use.</p>
<p>So the conditions of producing orphan csi inline volume should be:</p>
<ol>
<li>Pod terminating</li>
<li>Kubelet restart or shutdown during pod terminating</li>
<li>Kubelet reconstructvolume failed and start unmount before container shutdown</li>
</ol>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>The upstream has reported and fixed this issue at 1.25 version: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/108997">https://github.com/kubernetes/kubernetes/pull/108997</a></p>
<p>I backport the related pr into our kubernetes repo: <a target="_blank" rel="noopener" href="https://github.corp.ebay.com/tess/kubernetes/pull/2289">https://github.corp.ebay.com/tess/kubernetes/pull/2289</a></p>
<p>Before the bug fix rollout, we need manually remove the orphan volume, else it might impact the new pod creating local pvc.</p>
<p>After I audit, I only see the orphan volumes in cluster 40. We can do a change to fix them after kubelet rollout. </p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/04/01/cgroup%20v2%20iocost%20records/" rel="prev" title="">
                  <i class="fa fa-angle-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/04/24/2024-05-04-cgroup-v2-buffer-io/" rel="next" title="Why the cgroup v1 can not throttle the buffer io but cgroup v2 can">
                  Why the cgroup v1 can not throttle the buffer io but cgroup v2 can <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
